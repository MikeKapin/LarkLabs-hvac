<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HVAC Jack">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#E85A4F">
    <title>HVAC Jack - Your Jack of All Trades HVAC AI Assistant</title>
    <link rel="apple-touch-icon" href="logo_2.png">
    <link rel="icon" type="image/png" sizes="192x192" href="logo_2.png">
    <link rel="icon" type="image/png" sizes="512x512" href="logo_2.png">
    <link rel="manifest" href="../manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1A1F2E;
            min-height: 100vh;
            color: #E2E8F0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Password Protection Styles */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1A1F2E;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 2rem;
        }

        .password-container {
            background: #2D3748;
            border: 2px solid #E85A4F;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(232, 90, 79, 0.3);
        }

        .password-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem auto;
            background-image: url('logo_2.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .password-title {
            color: #E85A4F;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .password-subtitle {
            color: #A0AEC0;
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        .password-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #4A5568;
            border-radius: 12px;
            background: #1A1F2E;
            color: #E2E8F0;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .password-input:focus {
            outline: none;
            border-color: #E85A4F;
            box-shadow: 0 0 0 3px rgba(232, 90, 79, 0.2);
        }

        .password-input::placeholder {
            color: #718096;
        }

        .password-button {
            width: 100%;
            padding: 1rem;
            background: #E85A4F;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(232, 90, 79, 0.4);
        }

        .password-button:hover {
            background: #C53030;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 90, 79, 0.6);
        }

        .password-button:active {
            transform: translateY(0);
        }

        .password-error {
            color: #F56565;
            font-size: 0.9rem;
            margin-top: 1rem;
            padding: 0.5rem;
            background: rgba(245, 101, 101, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(245, 101, 101, 0.3);
        }

        .beta-badge {
            background: linear-gradient(135deg, #E85A4F, #C53030);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .hidden {
            display: none !important;
        }

        /* Main App Styles */
        .mobile-header {
            background: rgba(26, 31, 46, 0.95);
            padding: 0.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            min-height: 140px;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #2D3748;
        }

        .mobile-header-content {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.5rem;
            position: relative;
            margin-bottom: 1rem;
        }

        .header-settings-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 40px;
            height: 40px;
            background: #E85A4F;
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .header-settings-btn:active {
            transform: scale(0.9);
            background: #C53030;
        }

        .header-logo {
            position: static;
            width: 90vw;
            height: 110px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 500px;
            margin: 0.1rem auto;
        }

        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .mobile-logo {
            font-size: 1.2rem;
            font-weight: bold;
            color: #E85A4F;
            display: flex;
            align-items: center;
            margin: 0 auto;
            padding-left: 50px;
        }

        .mobile-logo::before {
            content: "üîß";
            margin-right: 8px;
            font-size: 1.4rem;
        }

        .mobile-mode-toggle {
            display: flex;
            background: #2D3748;
            border-radius: 20px;
            padding: 2px;
            flex-shrink: 0;
            border: 1px solid #4A5568;
        }

        .mobile-mode-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            background: transparent;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            min-height: 36px;
            touch-action: manipulation;
            color: #A0AEC0;
        }

        .mobile-mode-btn.active {
            background: #E85A4F;
            color: white;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-status {
            font-size: 0.65rem;
            color: #A0AEC0;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            width: 100%;
            margin-top: 0.2rem;
        }

        .mobile-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #48BB78;
            animation: pulse 2s infinite;
        }

        .mobile-status-dot.error {
            background: #F56565;
        }

        .mobile-status-dot.connecting {
            background: #ED8936;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-container {
            padding: 0;
            height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 240px;
        }

        .mobile-chat-container {
            flex: 1;
            background: #1A1F2E;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .mobile-context-bar {
            background: linear-gradient(135deg, #E85A4F 0%, #C53030 100%);
            color: white;
            padding: 0.4rem;
            font-size: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 1px solid #C53030;
            flex-shrink: 0;
        }

        .mobile-context-bar.expanded {
            padding: 0.8rem 0.4rem;
        }

        .context-toggle {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .mobile-context-details {
            display: none;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .mobile-context-details.show {
            display: block;
        }

        .mobile-messages {
            flex: 1;
            padding: 1rem 0.75rem 20px 0.75rem;
            overflow-y: auto;
            background: #1A1F2E;
            -webkit-overflow-scrolling: touch;
        }

        .mobile-message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mobile-message.user {
            justify-content: flex-end;
        }

        .mobile-message.ai {
            justify-content: flex-start;
        }

        .mobile-message-content {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            position: relative;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .mobile-message.user .mobile-message-content {
            background: #E85A4F;
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-message.ai .mobile-message-content {
            background: #2D3748;
            border: 1px solid #4A5568;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: #E2E8F0;
        }

        .mobile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .mobile-avatar.user {
            background: #E85A4F;
            color: white;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-avatar.ai {
            background: #2D3748;
            color: #E85A4F;
            border: 1px solid #4A5568;
        }

        .mobile-input-container {
            padding: 0.75rem;
            background: #2D3748;
            border-top: 1px solid #4A5568;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }

        .mobile-quick-actions {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .mobile-quick-actions::-webkit-scrollbar {
            display: none;
        }

        .mobile-quick-btn {
            padding: 0.4rem 0.8rem;
            background: #1A1F2E;
            border: 1px solid #4A5568;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.3s;
            min-height: 36px;
            touch-action: manipulation;
            color: #A0AEC0;
        }

        .mobile-quick-btn:active {
            background: #E85A4F;
            color: white;
            border-color: #E85A4F;
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .mobile-input-field {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #4A5568;
            border-radius: 20px;
            font-size: 1rem;
            min-height: 44px;
            resize: none;
            max-height: 100px;
            transition: border-color 0.3s;
            background: #1A1F2E;
            color: #E2E8F0;
        }

        .mobile-input-field:focus {
            outline: none;
            border-color: #E85A4F;
            box-shadow: 0 0 0 3px rgba(232, 90, 79, 0.2);
        }

        .mobile-input-field::placeholder {
            color: #718096;
        }

        .mobile-send-btn {
            width: 44px;
            height: 44px;
            background: #E85A4F;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-send-btn:active {
            transform: scale(0.9);
            background: #C53030;
        }

        .mobile-send-btn:disabled {
            background: #4A5568;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .mobile-typing {
            display: none;
            padding: 0.5rem 0.75rem;
            color: #A0AEC0;
            font-size: 0.8rem;
            align-items: center;
            gap: 0.5rem;
            position: fixed;
            bottom: 220px;
            left: 0;
            right: 0;
            background: rgba(26, 31, 46, 0.95);
            z-index: 1001;
            backdrop-filter: blur(10px);
        }

        .mobile-typing-dots {
            display: flex;
            gap: 0.2rem;
        }

        .mobile-typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #E85A4F;
            animation: typing 1.4s infinite ease-in-out;
        }

        .mobile-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .mobile-typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .mobile-fab {
            display: none;
        }

        .mobile-footer {
            background: rgba(26, 31, 46, 0.95);
            border-top: 1px solid #2D3748;
            padding: 0.75rem;
            text-align: center;
            backdrop-filter: blur(10px);
            position: sticky;
            bottom: 0;
            z-index: 1000;
        }

        .footer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            font-size: 0.75rem;
            color: #A0AEC0;
        }

        .footer-logo {
            width: 20px;
            height: 20px;
            cursor: pointer;
            background: #E85A4F;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
        }

        .footer-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .footer-text {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .copyright {
            margin-top: 0.25rem;
            font-size: 0.65rem;
            color: #718096;
        }

        /* Connection error styling */
        .connection-error {
            background: rgba(245, 101, 101, 0.2);
            border: 1px solid #F56565;
            color: #FEB2B2;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            font-size: 0.8rem;
        }

        /* Scrollbar styling for webkit browsers */
        .mobile-messages::-webkit-scrollbar {
            width: 4px;
        }

        .mobile-messages::-webkit-scrollbar-track {
            background: #1A1F2E;
        }

        .mobile-messages::-webkit-scrollbar-thumb {
            background: #4A5568;
            border-radius: 2px;
        }

        .mobile-messages::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* Add safe area insets for mobile devices */
        .mobile-input-container {
            padding: 0.75rem;
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
            background: #2D3748;
            border-top: 1px solid #4A5568;
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            min-height: 140px;
        }

        /* Adjust body for better mobile support */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1A1F2E;
            min-height: 100vh;
            color: #E2E8F0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            margin: 0;
            padding: 0;
        }
        /* Enhanced glow effects for interactive elements */
        .mobile-send-btn:hover,
        .mobile-fab:hover {
            box-shadow: 0 4px 16px rgba(232, 90, 79, 0.6);
        }

        .mobile-mode-btn.active {
            box-shadow: 0 2px 12px rgba(232, 90, 79, 0.5);
        }

        /* Quick button hover effects */
        .mobile-quick-btn:hover {
            background: #2D3748;
            border-color: #E85A4F;
            color: #E85A4F;
        }

        /* Input field focus glow */
        .mobile-input-field:focus {
            box-shadow: 0 0 0 3px rgba(232, 90, 79, 0.3), 0 0 20px rgba(232, 90, 79, 0.1);
        }

        /* Message content styling improvements */
        .mobile-message.ai .mobile-message-content strong {
            color: #E85A4F;
        }

        /* Enhanced context bar gradient */
        .mobile-context-bar {
            background: linear-gradient(135deg, #E85A4F 0%, #C53030 50%, #9C2A2A 100%);
            box-shadow: 0 2px 10px rgba(232, 90, 79, 0.3);
        }

        /* Improved header styling */
        .mobile-header {
            background: linear-gradient(180deg, rgba(26, 31, 46, 0.98) 0%, rgba(26, 31, 46, 0.95) 100%);
            border-bottom: 1px solid #E85A4F;
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div class="password-overlay" id="passwordOverlay">
        <div class="password-container">
            <div class="beta-badge">üîí BETA ACCESS</div>
            <div class="password-logo"></div>
            <h1 class="password-title">HVAC Jack</h1>
            <p class="password-subtitle">Beta Testing - Enter access code to continue</p>
            
            <input 
                type="password" 
                class="password-input" 
                id="passwordInput" 
                placeholder="Enter password..."
                autocomplete="new-password"
            />
            
            <button class="password-button" onclick="checkPassword()">
                üöÄ Access HVAC Jack
            </button>
            
            <div class="password-error hidden" id="passwordError">
                ‚ùå Incorrect password. Please try again.
            </div>
        </div>
    </div>

    <!-- Main App Content (hidden initially) -->
    <div class="main-app hidden" id="mainApp">
        <div class="mobile-header">
            <div class="mobile-header-content">
                <div class="mobile-mode-toggle">
                    <button class="mobile-mode-btn active" id="mobileHomeownerBtn" onclick="switchMode('homeowner')">üè† Home</button>
                    <button class="mobile-mode-btn" id="mobileTechnicianBtn" onclick="switchMode('technician')">üîß Tech</button>
                </div>
                <button class="header-settings-btn" onclick="showMobileMenu()">‚öôÔ∏è</button>
                <a href="#" class="header-logo">
                    <img src="logo_2.png" alt="HVAC Jack Logo" />
                </a>
            </div>
            <div class="mobile-status">
                <div class="mobile-status-dot connecting" id="mobileStatusDot"></div>
                <span id="mobileStatusText">Connecting to Jack...</span>
            </div>
        </div>

        <div class="main-container">
            <div class="mobile-chat-container">
                <div class="mobile-messages" id="mobileMessages">
                    <div class="mobile-message ai">
                        <div class="mobile-avatar ai">üîß</div>
                        <div class="mobile-message-content" id="mobileWelcomeMessage">
                            <strong>Hey! I'm HVAC Jack!</strong><br><br>
                            üè† <strong>Homeowner Mode</strong> - I'll explain things simply and focus on safe DIY steps.<br><br>
                            üí≠ <strong>I Remember Everything</strong> - No need to repeat yourself as we chat!<br><br>
                            <strong>What's wrong with your heating or cooling?</strong>
                        </div>
                    </div>
                </div>
                <div class="mobile-context-bar" id="mobileContextBar" onclick="toggleContext()">
                    <div id="mobileContextSummary">üß† New conversation - Jack is learning about your system</div>
                    <div class="context-toggle">Tap to expand memory</div>
                    <div class="mobile-context-details" id="mobileContextDetails">
                        <strong>System:</strong> <span id="mobileSystemType">Unknown</span><br>
                        <strong>Problem:</strong> <span id="mobileProblemType">Diagnosing</span><br>
                        <strong>Messages:</strong> <span id="mobileMessageCount">0</span>
                    </div>
                </div>

                <div class="mobile-typing" id="mobileTyping">
                    <span>Jack is thinking</span>
                    <div class="mobile-typing-dots">
                        <div class="mobile-typing-dot"></div>
                        <div class="mobile-typing-dot"></div>
                        <div class="mobile-typing-dot"></div>
                    </div>
                </div>

                <div class="mobile-input-container">
                    <div class="mobile-quick-actions">
                        <button class="mobile-quick-btn" onclick="quickQuestion('No heat from furnace')">üî• No Heat</button>
                        <button class="mobile-quick-btn" onclick="quickQuestion('AC not cooling')">‚ùÑÔ∏è No Cool</button>
                        <button class="mobile-quick-btn" onclick="quickQuestion('Strange noises')">üîä Noise</button>
                        <button class="mobile-quick-btn" onclick="quickQuestion('System short cycling')">üîÑ Cycling</button>
                        <button class="mobile-quick-btn" onclick="quickQuestion('Frozen AC coil')">üßä Frozen</button>
                    </div>
                    
                    <div class="mobile-input-group">
                        <textarea class="mobile-input-field" id="mobileInput" placeholder="Tell Jack what's wrong..." rows="1" onkeypress="handleMobileKeyPress(event)" oninput="adjustTextareaHeight(this)"></textarea>
                        <button class="mobile-send-btn" id="mobileSendBtn" onclick="sendMobileMessage()">
                            <span>‚û§</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mobile-footer">
            <div class="footer-content">
                <div class="footer-text">
                    Created by 
                    <div class="footer-logo">
                        üîß
                    </div>
                    LARK Labs
                </div>
            </div>
            <div class="copyright">
                ¬© 2025 LARK Labs. All rights reserved. HVAC Jack is a trademark of LARK Labs.
            </div>
        </div>

        <button class="mobile-fab" id="mobileFab" style="display: none;" onclick="showMobileMenu()">‚öôÔ∏è</button>
    </div>

    <script>
        // Password Protection System
        const BETA_PASSWORD = 'HVACJACK2025';
        const SESSION_KEY = 'hvacjack_beta_session';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const errorDiv = document.getElementById('passwordError');
            const password = input.value.trim();

            if (password === BETA_PASSWORD) {
                // Store session with expiration
                const session = {
                    authenticated: true,
                    timestamp: Date.now()
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(session));
                
                // Hide password overlay and show main app
                document.getElementById('passwordOverlay').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Initialize the main app
                initializeMainApp();
                
                // Show success message
                console.log('‚úÖ Beta access granted - Welcome to HVAC Jack!');
            } else {
                // Show error
                errorDiv.classList.remove('hidden');
                input.value = '';
                input.focus();
                
                // Hide error after 3 seconds
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 3000);
            }
        }

        function checkExistingSession() {
            const stored = localStorage.getItem(SESSION_KEY);
            if (stored) {
                try {
                    const session = JSON.parse(stored);
                    const timeElapsed = Date.now() - session.timestamp;
                    
                    if (session.authenticated && timeElapsed < SESSION_DURATION) {
                        // Valid session - skip password
                        document.getElementById('passwordOverlay').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        initializeMainApp();
                        return true;
                    } else {
                        // Expired session
                        localStorage.removeItem(SESSION_KEY);
                    }
                } catch (error) {
                    // Invalid session data
                    localStorage.removeItem(SESSION_KEY);
                }
            }
            return false;
        }

        // Handle Enter key on password input
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            
            passwordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    checkPassword();
                }
            });
            
            // Check for existing session on page load
            if (!checkExistingSession()) {
                // Focus password input if no session
                setTimeout(() => passwordInput.focus(), 100);
            }
        });

        function initializeMainApp() {
            // Initialize the main HVAC Jack app
            const mobileHvacJack = new SecureMobileHVACJack();
            window.mobileHvacJack = mobileHvacJack; // Make it globally accessible
        }

        // Enhanced Mobile HVAC Jack with Content Filtering
        class SecureMobileHVACJack {
            constructor() {
                this.diagnosticsRun = 0;
                this.conversationHistory = [];
                this.currentMode = 'homeowner';
                this.systemContext = {
                    equipmentType: null,
                    brand: null,
                    symptoms: [],
                    previousActions: [],
                    currentProblem: null
                };
                // Backend API endpoints - Netlify Functions
                this.apiEndpoint = '/.netlify/functions/chat';
                this.healthEndpoint = '/.netlify/functions/health';
                this.trackingEndpoint = '/.netlify/functions/track-usage';
                this.isConnected = false;
                this.isProcessing = false;
                this.connectionAttempts = 0;
                this.maxConnectionAttempts = 3;
                
                // Content filtering settings
                this.maxMessageLength = 500;
                this.rateLimitWindow = 60000; // 1 minute
                this.maxMessagesPerWindow = 10;
                this.messageTimestamps = [];
                this.sessionId = this.generateSessionId();
                
                this.initializeContentFilters();
                this.init();
                
                // NEW: Track session start immediately
                this.trackSessionStart();
            }

            // NEW: Track session start method
            async trackSessionStart() {
                try {
                    await this.trackUsage('session_start', {
                        mode: this.currentMode,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent.substring(0, 50)
                    });
                    console.log('‚úÖ Session started and tracked:', this.sessionId);
                } catch (error) {
                    console.warn('Session tracking failed:', error);
                }
            }

            initializeContentFilters() {
                // HVAC-related keywords (whitelist approach)
                this.hvacKeywords = [
                    'hvac', 'heating', 'cooling', 'furnace', 'air conditioner', 'ac', 'heat pump',
                    'thermostat', 'duct', 'filter', 'compressor', 'condenser', 'evaporator',
                    'refrigerant', 'blower', 'motor', 'fan', 'coil', 'vent', 'airflow',
                    'temperature', 'humidity', 'btu', 'cfm', 'tonnage', 'seer', 'efficiency',
                    'gas', 'electric', 'propane', 'oil', 'boiler', 'radiator', 'baseboard',
                    'central air', 'mini split', 'ductless', 'zoning', 'damper', 'plenum',
                    'return air', 'supply air', 'exhaust', 'ventilation', 'indoor air quality',
                    'carbon monoxide', 'heat exchanger', 'igniter', 'pilot light', 'flame sensor',
                    'pressure switch', 'limit switch', 'capacitor', 'contactor', 'relay',
                    'transformer', 'circuit board', 'control board', 'wiring', 'electrical',
                    'refrigeration', 'defrost', 'superheat', 'subcooling', 'manifold',
                    'leak', 'repair', 'maintenance', 'service', 'installation', 'replacement',
                    'troubleshoot', 'diagnose', 'problem', 'issue', 'malfunction', 'broken',
                    'not working', 'noise', 'smell', 'smoke', 'water', 'ice', 'frozen',
                    'hot', 'cold', 'warm', 'cool', 'cycling', 'running', 'starting', 'system', 'unit'
                ];

                // Prohibited content patterns
                this.prohibitedPatterns = [
                    // Explicit content
                    /\b(porn|sex|nude|naked|explicit|adult|xxx|nsfw)\b/i,
                    
                    // Programming/code requests
                    /\b(code|program|script|function|api|database|python|javascript|html|css|sql|php|github|stackoverflow|programming)\b/i,
                    
                    // Large data requests
                    /\b(download|upload|file|document|pdf|database|spreadsheet|excel|csv)\b/i,
                    
                    // Off-topic requests
                    /\b(recipe|cooking|medical|legal|financial|politics|religion|homework|essay|assignment)\b/i,
                    
                    // System manipulation attempts
                    /\b(ignore|bypass|override|system prompt|jailbreak|pretend|roleplay|character|act as|you are now|from now on)\b/i
                ];

                // Suspicious patterns
                this.suspiciousPatterns = [
                    /\b(hack|crack|exploit|vulnerability|illegal|criminal|dangerous|harmful)\b/i,
                    /repeated\s+text|(.)\1{10,}/i, // Spam patterns
                    /[A-Z]{20,}/, // Excessive caps
                    /(.{1,10})\1{3,}/ // Repeated phrases
                ];
            }

            generateSessionId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            validateInput(input) {
                const validation = {
                    isValid: true,
                    reason: '',
                    category: '',
                    sanitizedInput: input.trim()
                };

                // 1. Length check
                if (input.length > this.maxMessageLength) {
                    validation.isValid = false;
                    validation.reason = `Message too long (${input.length}/${this.maxMessageLength} characters). Please keep HVAC questions concise.`;
                    validation.category = 'length';
                    return validation;
                }

                // 2. Rate limiting
                if (!this.checkRateLimit()) {
                    validation.isValid = false;
                    validation.reason = 'Too many messages. Please wait a moment before sending another HVAC question.';
                    validation.category = 'rate_limit';
                    return validation;
                }

                // 3. Empty or meaningless input
                if (input.trim().length < 3 || /^[^a-zA-Z]*$/.test(input.trim())) {
                    validation.isValid = false;
                    validation.reason = 'Please ask a specific HVAC question.';
                    validation.category = 'empty';
                    return validation;
                }

                // 4. Check for prohibited content
                const prohibitedMatch = this.prohibitedPatterns.find(pattern => pattern.test(input));
                if (prohibitedMatch) {
                    validation.isValid = false;
                    validation.reason = 'HVAC Jack only helps with heating, cooling, and ventilation questions. Please ask about your HVAC system.';
                    validation.category = 'prohibited';
                    return validation;
                }

                // 5. Check for suspicious content
                const suspiciousMatch = this.suspiciousPatterns.find(pattern => pattern.test(input));
                if (suspiciousMatch) {
                    validation.isValid = false;
                    validation.reason = 'This message seems suspicious. HVAC Jack only discusses heating and cooling systems.';
                    validation.category = 'suspicious';
                    return validation;
                }

                // 6. HVAC relevance check (lenient approach)
                const hasHvacKeywords = this.hvacKeywords.some(keyword => 
                    input.toLowerCase().includes(keyword.toLowerCase())
                );

                // Allow some flexibility for follow-up questions
                const isFollowUp = this.conversationHistory.length > 0;
                const hasGeneralTerms = /\b(it|this|that|system|unit|equipment|problem|issue|help|why|how|what|when|where)\b/i.test(input);

                if (!hasHvacKeywords && !isFollowUp && !hasGeneralTerms) {
                    validation.isValid = false;
                    validation.reason = 'HVAC Jack specializes in heating, cooling, and ventilation. Please ask about your HVAC system, furnace, AC, heat pump, or related equipment.';
                    validation.category = 'off_topic';
                    return validation;
                }

                // 7. Basic sanitization
                validation.sanitizedInput = this.sanitizeInput(input);

                return validation;
            }

            sanitizeInput(input) {
                return input
                    .replace(/[<>]/g, '') // Remove potential HTML
                    .replace(/javascript:/gi, '') // Remove JS injection attempts
                    .replace(/\s+/g, ' ') // Normalize whitespace
                    .trim()
                    .substring(0, this.maxMessageLength); // Ensure length limit
            }

            checkRateLimit() {
                const now = Date.now();
                
                // Remove old timestamps
                this.messageTimestamps = this.messageTimestamps.filter(
                    timestamp => now - timestamp < this.rateLimitWindow
                );

                // Check if under limit
                if (this.messageTimestamps.length >= this.maxMessagesPerWindow) {
                    return false;
                }

                // Add current timestamp
                this.messageTimestamps.push(now);
                return true;
            }

            generateValidationErrorResponse(validation) {
                const responses = {
                    length: "‚ö†Ô∏è **Message Too Long**\n\nPlease keep your HVAC questions shorter and more specific. Try asking about one issue at a time!\n\n**Examples:**\n‚Ä¢ \"My furnace won't start\"\n‚Ä¢ \"AC is making strange noises\"\n‚Ä¢ \"No heat from vents\"",
                    
                    rate_limit: "‚è≥ **Slow Down!**\n\nYou're asking questions too quickly. Take a moment to try my suggestions, then come back with updates!\n\nüí° **Tip:** Quality over quantity - detailed questions get better answers.",
                    
                    empty: "ü§î **Need More Details**\n\nI need a specific HVAC question to help you!\n\n**Try asking:**\n‚Ä¢ What's wrong with your heating/cooling?\n‚Ä¢ What symptoms are you seeing?\n‚Ä¢ What type of system do you have?",
                    
                    prohibited: "üîß **HVAC Questions Only**\n\nI'm HVAC Jack - I only help with heating, cooling, and ventilation systems!\n\n**I can help with:**\n‚Ä¢ Furnaces & boilers\n‚Ä¢ Air conditioners & heat pumps\n‚Ä¢ Thermostats & controls\n‚Ä¢ Ductwork & airflow\n‚Ä¢ System maintenance",
                    
                    suspicious: "üö® **Invalid Request**\n\nThat doesn't look like an HVAC question. I'm here to help with heating and cooling systems only.\n\n**Ask me about:**\n‚Ä¢ System problems\n‚Ä¢ Strange noises or smells\n‚Ä¢ Temperature issues\n‚Ä¢ Equipment troubleshooting",
                    
                    off_topic: "‚ùå **Off-Topic**\n\nI'm specialized in HVAC systems only! Please ask about:\n\nüî• **Heating:** Furnaces, boilers, heat pumps\n‚ùÑÔ∏è **Cooling:** Air conditioners, evaporative coolers\nüå™Ô∏è **Ventilation:** Fans, ductwork, air quality\nüéõÔ∏è **Controls:** Thermostats, sensors, smart systems"
                };

                return responses[validation.category] || responses.off_topic;
            }

            async trackUsage(eventType, data = {}) {
                try {
                    await fetch(this.trackingEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            eventType,
                            data: {
                                ...data,
                                mode: this.currentMode,
                                conversationLength: this.conversationHistory.length
                            },
                            sessionId: this.sessionId,
                            timestamp: new Date().toISOString()
                        })
                    });
                } catch (error) {
                    console.warn('Usage tracking failed:', error);
                }
            }

            async init() {
                this.setupMobileFeatures();
                this.loadSavedConversation();
                await this.checkBackendConnection();
            }

            setupMobileFeatures() {
                document.addEventListener('touchstart', function() {}, {passive: true});
                
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', this.handleViewportChange.bind(this));
                }
                
                document.addEventListener('touchmove', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, {passive: false});
                
                this.setupAutoScroll();
                this.setupHapticFeedback();
            }

            handleViewportChange() {
                const viewport = window.visualViewport;
                document.documentElement.style.setProperty('--viewport-height', `${viewport.height}px`);
                
                setTimeout(() => {
                    document.getElementById('mobileInput').scrollIntoView({behavior: 'smooth', block: 'nearest'});
                }, 100);
            }

            setupAutoScroll() {
                this.messagesContainer = document.getElementById('mobileMessages');
                this.observer = new MutationObserver(() => {
                    this.scrollToBottom();
                });
                this.observer.observe(this.messagesContainer, {childList: true});
            }

            setupHapticFeedback() {
                this.hapticFeedback = (type = 'light') => {
                    if (navigator.vibrate) {
                        const patterns = {
                            light: [10],
                            medium: [20],
                            heavy: [30],
                            success: [10, 50, 10]
                        };
                        navigator.vibrate(patterns[type] || patterns.light);
                    }
                };
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }, 100);
            }

            loadSavedConversation() {
                const saved = localStorage.getItem('hvacJackMobileConversation');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.conversationHistory = data.history || [];
                        this.systemContext = data.context || this.systemContext;
                        this.updateMobileMemoryDisplay();
                    } catch (error) {
                        console.log('Could not load saved conversation');
                    }
                }
            }

            saveConversation() {
                const data = {
                    history: this.conversationHistory,
                    context: this.systemContext,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('hvacJackMobileConversation', JSON.stringify(data));
            }

            addToConversation(role, content) {
                this.conversationHistory.push({
                    role: role,
                    content: content,
                    timestamp: new Date().toISOString(),
                    mode: this.currentMode
                });
                
                if (this.conversationHistory.length > 20) {
                    this.conversationHistory = this.conversationHistory.slice(-20);
                }
                
                this.updateMobileMemoryDisplay();
                this.saveConversation();
            }

            updateMobileMemoryDisplay() {
                document.getElementById('mobileMessageCount').textContent = this.conversationHistory.length;
                document.getElementById('mobileSystemType').textContent = this.systemContext.equipmentType || 'Unknown';
                document.getElementById('mobileProblemType').textContent = this.systemContext.currentProblem || 'Diagnosing';
                
                const summary = this.conversationHistory.length > 0 
                    ? `üß† Remembering: ${this.systemContext.equipmentType || 'system'} ${this.systemContext.currentProblem || 'issue'}`
                    : 'üß† New conversation - Jack is learning about your system';
                    
                document.getElementById('mobileContextSummary').textContent = summary;
            }

            extractSystemContext(userInput) {
                const input = userInput.toLowerCase();
                
                if (input.includes('furnace')) this.systemContext.equipmentType = 'furnace';
                else if (input.includes('air condition') || input.includes('ac ')) this.systemContext.equipmentType = 'air conditioner';
                else if (input.includes('heat pump')) this.systemContext.equipmentType = 'heat pump';
                else if (input.includes('water heater')) this.systemContext.equipmentType = 'water heater';
                
                if (input.includes('no heat')) this.systemContext.currentProblem = 'no heat';
                else if (input.includes('no cool') || input.includes('not cooling')) this.systemContext.currentProblem = 'no cooling';
                else if (input.includes('noise')) this.systemContext.currentProblem = 'strange noises';
                else if (input.includes('frozen')) this.systemContext.currentProblem = 'frozen system';
                else if (input.includes('cycling')) this.systemContext.currentProblem = 'short cycling';
            }

            async checkBackendConnection() {
                this.updateMobileStatus('connecting', 'Connecting to Jack...');
                this.connectionAttempts++;
                
                try {
                    console.log(`Attempting to connect to: ${this.healthEndpoint}`);
                    console.log(`Connection attempt ${this.connectionAttempts}/${this.maxConnectionAttempts}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    const response = await fetch(this.healthEndpoint, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Health check response:', data);
                        
                        if (data.claudeConfigured) {
                            this.isConnected = true;
                            this.connectionAttempts = 0;
                            this.updateMobileStatus('connected', 'Jack is ready!');
                            this.hapticFeedback('success');
                            
                            // Track successful connection
                            await this.trackUsage('connection_success', {
                                attempts: this.connectionAttempts
                            });
                            
                            // Remove any existing error messages
                            const existingErrors = document.querySelectorAll('.connection-error');
                            existingErrors.forEach(error => error.remove());
                        } else {
                            throw new Error('Claude API not configured on server');
                        }
                        
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Connection error details:', {
                        name: error.name,
                        message: error.message,
                        endpoint: this.healthEndpoint,
                        attempt: this.connectionAttempts
                    });
                    this.handleConnectionFailure(error);
                }
            }

            handleConnectionFailure(error) {
                this.isConnected = false;
                
                if (this.connectionAttempts < this.maxConnectionAttempts) {
                    this.updateMobileStatus('connecting', `Retrying... (${this.connectionAttempts}/${this.maxConnectionAttempts})`);
                    setTimeout(() => this.checkBackendConnection(), 3000);
                    return;
                }
                
                this.updateMobileStatus('error', 'Connection Failed');
                
                // Track connection failure
                this.trackUsage('connection_failed', {
                    error: error.message,
                    attempts: this.connectionAttempts
                });
                
                // Show detailed error message with troubleshooting
                let errorMessage = '‚ö†Ô∏è **Cannot Connect to HVAC Jack Server**\n\n';
                
                if (error.name === 'AbortError') {
                    errorMessage += '**Issue:** Connection timeout\n';
                    errorMessage += '**Using offline mode with built-in HVAC knowledge**\n\n';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage += '**Issue:** Network connection failed\n';
                    errorMessage += '**Using offline mode with built-in HVAC knowledge**\n\n';
                } else if (error.message.includes('Claude API not configured')) {
                    errorMessage += '**Issue:** Server running but Claude API not configured\n';
                    errorMessage += '**Using offline mode with built-in HVAC knowledge**\n\n';
                } else {
                    errorMessage += `**Issue:** ${error.message}\n\n`;
                }
                
                errorMessage += '**I can still help you!** I have extensive built-in HVAC knowledge for common problems.\n\n';
                errorMessage += '**Ask me about:**\n';
                errorMessage += '‚Ä¢ No heat or cooling issues\n';
                errorMessage += '‚Ä¢ Strange noises or smells\n';
                errorMessage += '‚Ä¢ Thermostat problems\n';
                errorMessage += '‚Ä¢ Basic troubleshooting steps\n\n';
                errorMessage += '*AI features will return when connection is restored*';
                
                this.addMobileMessage(errorMessage, 'ai');
            }

            updateMobileStatus(status, message) {
                const dot = document.getElementById('mobileStatusDot');
                const text = document.getElementById('mobileStatusText');
                
                dot.className = `mobile-status-dot ${status}`;
                text.textContent = message;
            }

            // ENHANCED: processUserInput method with better tracking
            async processUserInput(input) {
                if (this.isProcessing) return;

                // Validate input before processing
                const validation = this.validateInput(input);
                
                if (!validation.isValid) {
                    this.hapticFeedback('heavy');
                    
                    // ENHANCED: Log validation failure with more detail
                    await this.trackUsage('input_rejected', {
                        reason: validation.reason,
                        category: validation.category,
                        inputLength: input.length,
                        originalMessage: input.substring(0, 50) // First 50 chars for context
                    });

                    // Show helpful error message
                    const errorResponse = this.generateValidationErrorResponse(validation);
                    this.addMobileMessage(errorResponse, 'ai');
                    return { text: errorResponse, isError: true };
                }

                // Process with sanitized input
                this.isProcessing = true;
                const sanitizedInput = validation.sanitizedInput;

                // ENHANCED: Track message being sent
                await this.trackUsage('message_sent', {
                    inputLength: sanitizedInput.length,
                    mode: this.currentMode,
                    messageCount: this.conversationHistory.length,
                    message: sanitizedInput.substring(0, 100) // Store first 100 chars
                });

                this.showMobileTyping();
                this.addToConversation('user', sanitizedInput);
                this.extractSystemContext(sanitizedInput);
                
                const startTime = Date.now(); // NEW: Track response time
                
                try {
                    let response;
                    if (this.isConnected) {
                        response = await this.sendToBackend(sanitizedInput);
                    } else {
                        response = await this.processWithFallbackKnowledge(sanitizedInput);
                    }
                    
                    const responseTime = (Date.now() - startTime) / 1000; // NEW
                    
                    this.addToConversation('assistant', response);
                    this.hideMobileTyping();
                    this.diagnosticsRun++;
                    this.hapticFeedback('success');
                    
                    // ENHANCED: Track successful response
                    await this.trackUsage('response_received', {
                        responseTime: responseTime,
                        responseLength: response.length,
                        usingAI: this.isConnected,
                        mode: this.currentMode
                    });
                    
                    return { text: response, isError: false };
                    
                } catch (error) {
                    console.error('Processing error:', error);
                    this.hideMobileTyping();
                    this.hapticFeedback('heavy');
                    
                    const responseTime = (Date.now() - startTime) / 1000; // NEW
                    
                    // ENHANCED: Track error
                    await this.trackUsage('processing_error', {
                        error: error.message,
                        responseTime: responseTime,
                        usingAI: this.isConnected
                    });
                    
                    // If backend fails, try to reconnect and use fallback
                    if (this.isConnected) {
                        this.isConnected = false;
                        this.updateMobileStatus('error', 'Connection lost');
                        setTimeout(() => this.checkBackendConnection(), 1000);
                    }
                    
                    const fallback = await this.processWithFallbackKnowledge(sanitizedInput);
                    this.addToConversation('assistant', fallback + '\n\n*Note: Using fallback mode due to connection issue.*');
                    return { text: fallback, isError: false };
                } finally {
                    this.isProcessing = false;
                }
            }

            // ENHANCED: sendToBackend method to include session ID
            async sendToBackend(input) {
                const requestBody = {
                    message: input,
                    mode: this.currentMode,
                    conversationHistory: this.conversationHistory.slice(-10),
                    systemContext: this.systemContext,
                    sessionId: this.sessionId // NEW: Include session ID
                };

                console.log('Sending to backend:', this.apiEndpoint, {
                    ...requestBody,
                    message: input.substring(0, 50) + '...' // ENHANCED: Only log preview
                });
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                try {
                    const response = await fetch(this.apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Backend error: ${response.status} ${response.statusText} - ${errorText}`);
                    }

                    const data = await response.json();
                    
                    // ENHANCED: Better logging
                    console.log('Backend response received:', {
                        responseLength: data.response?.length || 0,
                        sessionId: data.sessionId,
                        usingAI: data.usingAI,
                        responseTime: data.responseTime
                    });
                    
                    if (data.fallback) {
                        console.warn('Server returned fallback response');
                    }
                    
                    return data.response || data.message || 'Sorry, I had trouble processing that.';
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }

            async processWithFallbackKnowledge(input) {
                await this.delay(1000);
                
                const analysis = this.analyzeInput(input);
                return this.generateFallbackResponse(analysis, input);
            }

            analyzeInput(input) {
                const inputLower = input.toLowerCase();
                return {
                    systemType: this.detectSystemType(inputLower),
                    problemType: this.detectProblemType(inputLower),
                    isFollowUp: this.conversationHistory.length > 1
                };
            }

            detectSystemType(input) {
                if (input.includes('furnace')) return 'furnace';
                if (input.includes('ac ') || input.includes('air condition')) return 'airConditioner';
                if (input.includes('water heater')) return 'waterHeater';
                return this.systemContext.equipmentType;
            }

            detectProblemType(input) {
                if (input.includes('no heat')) return 'noHeat';
                if (input.includes('no cool') || input.includes('not cooling')) return 'noCooling';
                if (input.includes('noise')) return 'noise';
                if (input.includes('frozen')) return 'frozenCoil';
                if (input.includes('cycling')) return 'shortCycling';
                return 'general';
            }

            generateFallbackResponse(analysis, input) {
                const contextInfo = this.conversationHistory.length > 1 
                    ? `(I remember: ${this.systemContext.equipmentType || 'your system'} with ${this.systemContext.currentProblem || 'issues'}) `
                    : '';

                if (this.currentMode === 'homeowner') {
                    return this.generateFallbackHomeownerResponse(analysis, contextInfo);
                } else {
                    return this.generateFallbackTechResponse(analysis, contextInfo);
                }
            }

            generateFallbackHomeownerResponse(analysis, contextInfo) {
                const responses = {
                    noHeat: `**No heat problem! ${contextInfo}**

**Quick checks:**
üì± Set thermostat 5¬∞F higher
üîã Replace thermostat batteries
‚ö° Check circuit breaker
üå™Ô∏è Replace air filter
üîß Listen for startup sounds

**STOP if you smell gas!** Call gas company immediately.

**Most likely:** Dead batteries (30% of my calls!) or dirty filter.

Try these and tell me what happens! üëç`,

                    noCooling: `**AC not cooling! ${contextInfo}**

**Start here:**
‚ùÑÔ∏è Set thermostat to COOL, 5¬∞F lower
üå™Ô∏è Replace dirty air filter (BIG cause!)
‚ö° Check both circuit breakers 
üè† Clean outdoor unit with hose
üëÄ All vents open and unblocked?

**Red flag:** Ice anywhere = turn OFF cooling!

**Quick test:** Any cool air from vents at all?

What did you find? üîç`,

                    general: `**HVAC issue! ${contextInfo}**

**Tell me:**
üîß What type of system?
‚ùì What's it doing (or not doing)?
üìÖ When did this start?
üëÇ Any weird sounds or smells?

**Safety first:**
üö® Gas smell = call gas company
üíß Water leaking = turn off system  
‚ö° Sparks/burning = turn off power

What's going on? I'm here to help! üòä`
                };

                return responses[analysis.problemType] || responses.general;
            }

            generateFallbackTechResponse(analysis, contextInfo) {
                const responses = {
                    noHeat: `**No heat diagnostic ${contextInfo}**

**Sequence check:**
‚ö° 24VAC R-W at unit
üî• HSI: 11-200Œ©, 3.2-3.6A draw  
üìä Gas: 3.5"WC NG, 11"WC LP
üëÅÔ∏è Flame sensor: 2-5ŒºA DC
üå™Ô∏è Pressure switch closure timing
üö® Limit switch continuity

**Tools:** DMM, manometer, ŒºA meter

**Common failures:**
- Control board fuses
- HSI cracked/high resistance  
- Flame sensor contamination
- Pressure switch tubing

Current symptoms and test results?`,

                    noCooling: `**No cooling diagnostic ${contextInfo}**

**Power/electrical:**
‚ö° 240VAC at disconnect
üìä Compressor/fan amp draws
üîã Start/run capacitor ŒºF
üîå Contactor pull-in voltage

**Refrigerant (EPA req'd):**
‚ùÑÔ∏è Suction/discharge pressures
üå°Ô∏è Superheat/subcooling calc
üíß Leak detection (oil spots)

**Airflow:**
üìè Static pressure measurement
üå™Ô∏è CFM verification
üîß Blower wheel/motor inspection

Current readings and observations?`,

                    general: `**Tech diagnostic mode ${contextInfo}**

**Need:**
üìã Model/serial numbers
üìä Current measurements
üîß Specific failure point
‚ö° Test equipment available

**Standard approach:**
1. Electrical verification
2. Pressure/temperature readings  
3. Sequence timing analysis
4. Component isolation testing

What's your current diagnostic status?`
                };

                return responses[analysis.problemType] || responses.general;
            }

            showMobileTyping() {
                document.getElementById('mobileTyping').style.display = 'flex';
                document.getElementById('mobileSendBtn').disabled = true;
                this.scrollToBottom();
            }

            hideMobileTyping() {
                document.getElementById('mobileTyping').style.display = 'none';
                document.getElementById('mobileSendBtn').disabled = false;
            }

            // ENHANCED: switchMode method with better tracking
            switchMode(mode) {
                const oldMode = this.currentMode; // Store old mode first
                this.currentMode = mode;
                this.hapticFeedback('light');
                
                // ENHANCED: Track mode switch with correct old/new modes
                this.trackUsage('mode_switched', {
                    from_mode: oldMode,
                    to_mode: mode
                });
                
                document.getElementById('mobileHomeownerBtn').classList.toggle('active', mode === 'homeowner');
                document.getElementById('mobileTechnicianBtn').classList.toggle('active', mode === 'technician');
                
                const placeholder = mode === 'homeowner' 
                    ? 'Tell Jack what\'s wrong...' 
                    : 'Describe symptoms and readings...';
                document.getElementById('mobileInput').placeholder = placeholder;
                
                this.updateWelcomeMessage(mode);
                
                const modeMessage = mode === 'homeowner'
                    ? 'üè† **Switched to Homeowner Mode** - I\'ll explain things simply and focus on safe DIY steps you can take.'
                    : 'üîß **Switched to Technician Mode** - I\'ll provide detailed technical specs, measurements, and professional diagnostic procedures.';
                    
                this.addMobileMessage(modeMessage, 'ai');
            }

            updateWelcomeMessage(mode) {
                const welcomeElement = document.getElementById('mobileWelcomeMessage');
                if (welcomeElement) {
                    if (mode === 'homeowner') {
                        welcomeElement.innerHTML = `
                            <strong>Hey! I'm HVAC Jack!</strong><br><br>
                            üè† <strong>Homeowner Mode</strong> - I'll explain things simply and focus on safe DIY steps.<br><br>
                            üí≠ <strong>I Remember Everything</strong> - No need to repeat yourself as we chat!<br><br>
                            <strong>What's wrong with your heating or cooling?</strong>
                        `;
                    } else {
                        welcomeElement.innerHTML = `
                            <strong>HVAC Jack - Technician Mode</strong><br><br>
                            üîß <strong>Professional Mode</strong> - Technical specs, measurements, and diagnostic procedures.<br><br>
                            üí≠ <strong>Conversation Memory</strong> - I'll build on our diagnostic history.<br><br>
                            <strong>What system are you diagnosing? Include model info and current readings.</strong>
                        `;
                    }
                }
            }

            addMobileMessage(content, sender) {
                const messagesContainer = document.getElementById('mobileMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `mobile-message ${sender}`;
                
                const avatar = document.createElement('div');
                avatar.className = `mobile-avatar ${sender}`;
                avatar.textContent = sender === 'user' ? 'üë§' : 'üîß';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'mobile-message-content';
                
                if (sender === 'ai') {
                    let formattedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n\n/g, '<br><br>')
                        .replace(/\n/g, '<br>');
                    messageContent.innerHTML = formattedContent;
                } else {
                    messageContent.textContent = content;
                }
                
                if (sender === 'user') {
                    messageDiv.appendChild(messageContent);
                    messageDiv.appendChild(avatar);
                } else {
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(messageContent);
                }
                
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            async delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Mobile-specific functions
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function handleMobileKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMobileMessage();
            }
        }

        async function sendMobileMessage() {
            if (!window.mobileHvacJack) return;
            
            const input = document.getElementById('mobileInput');
            const message = input.value.trim();
            
            if (!message || window.mobileHvacJack.isProcessing) return;

            window.mobileHvacJack.hapticFeedback('light');
            addMobileMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';

            try {
                const response = await window.mobileHvacJack.processUserInput(message);
                addMobileMessage(response.text, 'ai');
            } catch (error) {
                addMobileMessage('‚ùå Sorry! Something went wrong. Try again?', 'ai');
                window.mobileHvacJack.hapticFeedback('heavy');
            }
        }

        function addMobileMessage(content, sender) {
            const messagesContainer = document.getElementById('mobileMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mobile-message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = `mobile-avatar ${sender}`;
            avatar.textContent = sender === 'user' ? 'üë§' : 'üîß';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'mobile-message-content';
            
            if (sender === 'ai') {
                let formattedContent = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');
                messageContent.innerHTML = formattedContent;
            } else {
                messageContent.textContent = content;
            }
            
            if (sender === 'user') {
                messageDiv.appendChild(messageContent);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
            }
            
            messagesContainer.appendChild(messageDiv);
            if (window.mobileHvacJack) {
                window.mobileHvacJack.scrollToBottom();
            }
        }

        function quickQuestion(question) {
            document.getElementById('mobileInput').value = question;
            sendMobileMessage();
        }

        function switchMode(mode) {
            if (window.mobileHvacJack) {
                window.mobileHvacJack.switchMode(mode);
            }
        }

        function toggleContext() {
            const details = document.getElementById('mobileContextDetails');
            const bar = document.getElementById('mobileContextBar');
            
            details.classList.toggle('show');
            bar.classList.toggle('expanded');
            if (window.mobileHvacJack) {
                window.mobileHvacJack.hapticFeedback('light');
            }
        }

        function showMobileMenu() {
            if (confirm('Clear conversation and start fresh?')) {
                clearMobileConversation();
            }
        }

        function clearMobileConversation() {
            if (!window.mobileHvacJack) return;
            
            // Track conversation clear
            window.mobileHvacJack.trackUsage('conversation_cleared', {
                messageCount: window.mobileHvacJack.conversationHistory.length
            });
            
            window.mobileHvacJack.conversationHistory = [];
            window.mobileHvacJack.systemContext = {
                equipmentType: null,
                brand: null,
                symptoms: [],
                previousActions: [],
                currentProblem: null
            };
            
            localStorage.removeItem('hvacJackMobileConversation');
            
            document.getElementById('mobileMessages').innerHTML = `
                <div class="mobile-message ai">
                    <div class="mobile-avatar ai">üîß</div>
                    <div class="mobile-message-content" id="mobileWelcomeMessage">
                        ${window.mobileHvacJack.currentMode === 'homeowner' ? 
                            '<strong>Hey! I\'m HVAC Jack!</strong><br><br>üè† <strong>Homeowner Mode</strong> - I\'ll explain things simply and focus on safe DIY steps.<br><br>üí≠ <strong>I Remember Everything</strong> - No need to repeat yourself as we chat!<br><br><strong>What\'s wrong with your heating or cooling?</strong>' :
                            '<strong>HVAC Jack - Technician Mode</strong><br><br>üîß <strong>Professional Mode</strong> - Technical specs, measurements, and diagnostic procedures.<br><br>üí≠ <strong>Conversation Memory</strong> - I\'ll build on our diagnostic history.<br><br><strong>What system are you diagnosing? Include model info and current readings.</strong>'
                        }
                    </div>
                </div>
            `;
            
            window.mobileHvacJack.updateMobileMemoryDisplay();
            window.mobileHvacJack.hapticFeedback('success');
        }
    </script>
</body>
</html>
