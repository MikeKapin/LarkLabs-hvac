<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LARK Labs Admin Dashboard</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #16a085;
            --light: #ecf0f1;
            --dark: #34495e;
            --card-bg: #ffffff;
            --border: #e1e8ed;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--secondary);
        }

        .login-box p {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-form button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-form button:hover {
            transform: translateY(-2px);
        }

        .error-message {
            background: #ffe5e5;
            color: var(--danger);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.95;
            font-size: 1.1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: white;
            color: var(--dark);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tab-button:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-card.success { border-left-color: var(--success); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-card.danger { border-left-color: var(--danger); }
        .stat-card.info { border-left-color: var(--info); }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-value.primary { color: var(--primary); }
        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.danger { color: var(--danger); }
        .stat-value.info { color: var(--info); }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .card h2 {
            color: var(--secondary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
        }

        .data-table {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: var(--success);
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning);
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger);
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: var(--info);
            color: #0c5460;
        }

        .google-analytics-embed {
            background: white;
            padding: 20px;
            border-radius: 12px;
            min-height: 400px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>🎓 LARK Labs</h1>
            <p>Admin Dashboard</p>
            <div class="error-message" id="loginError">Invalid access code</div>
            <form class="login-form" onsubmit="login(event)">
                <input
                    type="password"
                    id="accessCode"
                    placeholder="Enter access code"
                    autofocus
                    required
                >
                <button type="submit">Access Dashboard</button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard" id="mainDashboard">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>📊 LARK Labs Admin Dashboard</h1>
                    <p>Centralized analytics, email management, and usage tracking</p>
                </div>
                <button class="logout-btn" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('overview')">📈 Overview</button>
            <button class="tab-button" onclick="switchTab('analytics')">📊 Website Analytics</button>
            <button class="tab-button" onclick="switchTab('emails')">📧 Email Subscribers</button>
            <button class="tab-button" onclick="switchTab('hvac')">🔧 HVAC Jack Stats</button>
            <button class="tab-button" onclick="switchTab('google')">🌐 Google Analytics</button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value primary" id="totalPageViews">-</div>
                    <div class="stat-label">Total Page Views</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value success" id="totalSubscribers">-</div>
                    <div class="stat-label">Email Subscribers</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value info" id="activeSessions">-</div>
                    <div class="stat-label">Active Sessions</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value warning" id="hvacSessions">-</div>
                    <div class="stat-label">HVAC Jack Sessions</div>
                </div>
            </div>

            <div class="card">
                <h2>📈 Quick Stats (Last 7 Days)</h2>
                <div class="chart-container">
                    <canvas id="overviewChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>🚀 App Usage Stats</h2>
                <div class="stats-grid">
                    <div class="stat-card danger">
                        <div class="stat-value danger" id="hvacJackViews">-</div>
                        <div class="stat-label">🔧 HVAC Jack Page Views</div>
                        <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
                            <strong id="hvacJackLaunches">-</strong> Launch Clicks
                        </div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value success" id="gasTechViews">-</div>
                        <div class="stat-label">⚡ Gas Tech AI Page Views</div>
                        <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
                            <strong id="gasTechLaunches">-</strong> Launch Clicks
                        </div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-value info" id="codeCompassViews">-</div>
                        <div class="stat-label">💻 Code Compass Page Views</div>
                        <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
                            <strong id="codeCompassLaunches">-</strong> Launch Clicks
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>🎯 Top Pages</h2>
                <div class="data-table">
                    <table id="topPagesTable">
                        <thead>
                            <tr>
                                <th>Page</th>
                                <th>Views</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="loading">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Website Analytics Tab -->
        <div class="tab-content" id="analytics">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshAnalytics()">🔄 Refresh Data</button>
                <button class="btn btn-success" onclick="exportAnalytics()">📥 Export Analytics</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value primary" id="analyticsPageViews">-</div>
                    <div class="stat-label">Total Page Views</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value info" id="analyticsSessions">-</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value success" id="analyticsActive">-</div>
                    <div class="stat-label">Active Now</div>
                </div>
            </div>

            <div class="card">
                <h2>📊 Daily Traffic (Last 7 Days)</h2>
                <div class="chart-container">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>🔝 Top Referrers</h2>
                <div class="data-table" id="referrersTable">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading referrer data...
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Subscribers Tab -->
        <div class="tab-content" id="emails">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshEmails()">🔄 Refresh List</button>
                <button class="btn btn-success" onclick="exportEmails()">📥 Export CSV</button>
                <button class="btn btn-warning" onclick="copyEmailList()">📋 Copy Emails</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card success">
                    <div class="stat-value success" id="emailTotal">-</div>
                    <div class="stat-label">Total Subscribers</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value info" id="emailToday">-</div>
                    <div class="stat-label">New Today</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value warning" id="emailThisWeek">-</div>
                    <div class="stat-label">This Week</div>
                </div>
            </div>

            <div class="card">
                <h2>📧 Subscriber List</h2>
                <div id="emailListAlert"></div>
                <div class="data-table">
                    <table id="subscribersTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Subscribed Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Loading subscribers...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2>📊 Subscription Sources</h2>
                <div class="chart-container">
                    <canvas id="sourcesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- HVAC Jack Stats Tab -->
        <div class="tab-content" id="hvac">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshHVAC()">🔄 Refresh Data</button>
                <button class="btn btn-success" onclick="exportHVAC()">📥 Export Stats</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value primary" id="hvacTotalSessions">-</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value info" id="hvacMessages">-</div>
                    <div class="stat-label">Messages Processed</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value success" id="hvacSuccessRate">-</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value danger" id="hvacBlocked">-</div>
                    <div class="stat-label">Blocked Content</div>
                </div>
            </div>

            <div class="card">
                <h2>📈 HVAC Jack Usage Over Time</h2>
                <div class="chart-container">
                    <canvas id="hvacUsageChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>🔧 Mode Distribution</h2>
                <div class="chart-container">
                    <canvas id="hvacModeChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>📋 Recent HVAC Jack Sessions</h2>
                <div class="data-table">
                    <table id="hvacSessionsTable">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Start Time</th>
                                <th>Messages</th>
                                <th>Mode</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Loading sessions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Google Analytics Tab -->
        <div class="tab-content" id="google">
            <div class="card">
                <h2>🌐 Google Analytics Integration</h2>
                <div class="alert alert-info">
                    <strong>📌 Your Google Analytics ID:</strong> G-CJLXH9XZ0M
                </div>
                <p style="margin-bottom: 20px;">
                    For detailed Google Analytics reports, visit your
                    <a href="https://analytics.google.com" target="_blank" style="color: var(--primary); font-weight: 600;">
                        Google Analytics Dashboard →
                    </a>
                </p>
                <div class="google-analytics-embed">
                    <h3 style="margin-bottom: 15px;">Quick Links:</h3>
                    <ul style="line-height: 2;">
                        <li><a href="https://analytics.google.com/analytics/web/#/p512345678/reports/intelligenthome" target="_blank">📊 Real-time Overview</a></li>
                        <li><a href="https://analytics.google.com/analytics/web/#/p512345678/reports/reportinghub" target="_blank">📈 Acquisition Reports</a></li>
                        <li><a href="https://analytics.google.com/analytics/web/#/p512345678/reports/engagement" target="_blank">👥 Engagement Reports</a></li>
                        <li><a href="https://analytics.google.com/analytics/web/#/p512345678/reports/life-cycle" target="_blank">🔄 User Lifecycle</a></li>
                    </ul>
                    <p style="margin-top: 20px; color: #7f8c8d;">
                        💡 <strong>Tip:</strong> Sign in with your Google account to access full analytics data.
                    </p>
                </div>
            </div>

            <div class="card">
                <h2>📊 Custom Tracking Events</h2>
                <p>Custom events can be tracked through the Analytics Tracker function. Current tracked events:</p>
                <ul style="line-height: 2; margin-top: 15px;">
                    <li>✅ Page views</li>
                    <li>✅ Session starts</li>
                    <li>✅ Email signups</li>
                    <li>✅ Tool usage (HVAC Jack, Code Compass, etc.)</li>
                    <li>✅ Form submissions</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Authentication
        const ACCESS_CODE = '2080';
        let charts = {};

        function login(event) {
            event.preventDefault();
            const code = document.getElementById('accessCode').value;

            if (code === ACCESS_CODE) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                sessionStorage.setItem('larklabs_auth', 'authenticated');
                initDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            sessionStorage.removeItem('larklabs_auth');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('accessCode').value = '';
        }

        // Check if already authenticated
        window.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('larklabs_auth') === 'authenticated') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                initDashboard();
            }
        });

        // Tab switching
        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load data for specific tabs
            switch(tabName) {
                case 'emails':
                    loadEmailData();
                    break;
                case 'analytics':
                    loadAnalyticsData();
                    break;
                case 'hvac':
                    loadHVACData();
                    break;
            }
        }

        // Initialize Dashboard
        async function initDashboard() {
            await loadOverviewData();
        }

        // Load Overview Data
        async function loadOverviewData() {
            try {
                // Load all data sources
                const [analyticsData, emailData, hvacData] = await Promise.all([
                    fetch('/.netlify/functions/analytics-tracker?auth=2080&days=7').then(r => r.json()),
                    fetch('/.netlify/functions/collect-email?auth=2080').then(r => r.json()),
                    fetch('/.netlify/functions/get-usage-stats').then(r => r.json())
                ]);

                // Update overview stats
                document.getElementById('totalPageViews').textContent =
                    analyticsData.totalPageViews?.toLocaleString() || '0';
                document.getElementById('totalSubscribers').textContent =
                    emailData.totalSubscribers?.toLocaleString() || '0';
                document.getElementById('activeSessions').textContent =
                    analyticsData.activeSessions?.toLocaleString() || '0';
                document.getElementById('hvacSessions').textContent =
                    hvacData.summary?.totalSessions?.toLocaleString() || '0';

                // Create overview chart
                createOverviewChart(analyticsData.dailyStats || []);

                // Update top pages table
                updateTopPagesTable(analyticsData.topPages || []);

                // Update app-specific stats
                if (analyticsData.appStats) {
                    document.getElementById('hvacJackViews').textContent =
                        analyticsData.appStats['hvac-jack']?.pageViews?.toLocaleString() || '0';
                    document.getElementById('hvacJackLaunches').textContent =
                        analyticsData.appStats['hvac-jack']?.launches?.toLocaleString() || '0';

                    document.getElementById('gasTechViews').textContent =
                        analyticsData.appStats['gas-tech-tutor']?.pageViews?.toLocaleString() || '0';
                    document.getElementById('gasTechLaunches').textContent =
                        analyticsData.appStats['gas-tech-tutor']?.launches?.toLocaleString() || '0';

                    document.getElementById('codeCompassViews').textContent =
                        analyticsData.appStats['code-compass']?.pageViews?.toLocaleString() || '0';
                    document.getElementById('codeCompassLaunches').textContent =
                        analyticsData.appStats['code-compass']?.launches?.toLocaleString() || '0';
                }

            } catch (error) {
                console.error('Error loading overview data:', error);
                showNotification('Error loading dashboard data', 'danger');
            }
        }

        function createOverviewChart(dailyStats) {
            const ctx = document.getElementById('overviewChart');
            if (!ctx) return;

            if (charts.overview) {
                charts.overview.destroy();
            }

            charts.overview = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyStats.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Page Views',
                        data: dailyStats.map(d => d.pageViews),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Unique Visitors',
                        data: dailyStats.map(d => d.uniqueVisitors),
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTopPagesTable(topPages) {
            const tbody = document.querySelector('#topPagesTable tbody');
            if (!topPages || topPages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">No data available</td></tr>';
                return;
            }

            const totalViews = topPages.reduce((sum, page) => sum + page.views, 0);

            tbody.innerHTML = topPages.map(page => `
                <tr>
                    <td>${page.page}</td>
                    <td>${page.views.toLocaleString()}</td>
                    <td>${((page.views / totalViews) * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        // Load Analytics Data
        async function loadAnalyticsData() {
            try {
                const response = await fetch('/.netlify/functions/analytics-tracker?auth=2080&days=7');
                const data = await response.json();

                document.getElementById('analyticsPageViews').textContent =
                    data.totalPageViews?.toLocaleString() || '0';
                document.getElementById('analyticsSessions').textContent =
                    data.totalSessions?.toLocaleString() || '0';
                document.getElementById('analyticsActive').textContent =
                    data.activeSessions?.toLocaleString() || '0';

                createTrafficChart(data.dailyStats || []);
                updateReferrersTable(data.topReferrers || []);

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function createTrafficChart(dailyStats) {
            const ctx = document.getElementById('trafficChart');
            if (!ctx) return;

            if (charts.traffic) {
                charts.traffic.destroy();
            }

            charts.traffic = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyStats.map(d => new Date(d.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Page Views',
                        data: dailyStats.map(d => d.pageViews),
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateReferrersTable(referrers) {
            const container = document.getElementById('referrersTable');
            if (!referrers || referrers.length === 0) {
                container.innerHTML = '<div class="loading">No referrer data available</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Referrer</th>
                            <th>Visits</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${referrers.map(ref => `
                            <tr>
                                <td>${ref.referrer}</td>
                                <td>${ref.count.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = html;
        }

        // Load Email Data
        async function loadEmailData() {
            try {
                const response = await fetch('/.netlify/functions/collect-email?auth=2080');
                const data = await response.json();

                if (!data.success) {
                    showEmailAlert('Unable to load email data', 'warning');
                    return;
                }

                document.getElementById('emailTotal').textContent =
                    data.totalSubscribers?.toLocaleString() || '0';

                // Calculate today and this week
                const today = new Date().toISOString().split('T')[0];
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);

                const todayCount = data.subscribers.filter(s =>
                    s.subscribedAt.startsWith(today)
                ).length;

                const weekCount = data.subscribers.filter(s =>
                    new Date(s.subscribedAt) >= weekAgo
                ).length;

                document.getElementById('emailToday').textContent = todayCount;
                document.getElementById('emailThisWeek').textContent = weekCount;

                updateSubscribersTable(data.subscribers || []);
                createSourcesChart(data.sources || {});

                if (data.dataNote) {
                    showEmailAlert(data.dataNote, 'info');
                }

            } catch (error) {
                console.error('Error loading email data:', error);
                showEmailAlert('Error loading email data', 'danger');
            }
        }

        function showEmailAlert(message, type) {
            const alertDiv = document.getElementById('emailListAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function updateSubscribersTable(subscribers) {
            const tbody = document.querySelector('#subscribersTable tbody');

            if (!subscribers || subscribers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No subscribers yet</td></tr>';
                return;
            }

            // Sort by date (newest first)
            subscribers.sort((a, b) => new Date(b.subscribedAt) - new Date(a.subscribedAt));

            tbody.innerHTML = subscribers.map(sub => `
                <tr>
                    <td>${sub.email}</td>
                    <td>${sub.name || '-'}</td>
                    <td><span class="badge badge-info">${sub.source}</span></td>
                    <td>${new Date(sub.subscribedAt).toLocaleDateString()}</td>
                    <td><span class="badge badge-success">Active</span></td>
                </tr>
            `).join('');
        }

        function createSourcesChart(sources) {
            const ctx = document.getElementById('sourcesChart');
            if (!ctx) return;

            if (charts.sources) {
                charts.sources.destroy();
            }

            const labels = Object.keys(sources);
            const data = Object.values(sources);

            if (labels.length === 0) {
                return;
            }

            charts.sources = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3498db',
                            '#27ae60',
                            '#f39c12',
                            '#e74c3c',
                            '#9b59b6',
                            '#16a085'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Load HVAC Data
        async function loadHVACData() {
            try {
                const response = await fetch('/.netlify/functions/get-usage-stats');
                const data = await response.json();

                document.getElementById('hvacTotalSessions').textContent =
                    data.summary?.totalSessions?.toLocaleString() || '0';
                document.getElementById('hvacMessages').textContent =
                    data.summary?.totalMessages?.toLocaleString() || '0';
                document.getElementById('hvacSuccessRate').textContent =
                    (data.summary?.successRate || 100) + '%';
                document.getElementById('hvacBlocked').textContent =
                    data.summary?.blockedMessages?.toLocaleString() || '0';

                createHVACUsageChart(data.dailyUsage || []);
                createHVACModeChart(data.modeUsage || {});
                updateHVACSessionsTable(data.recentSessions || []);

            } catch (error) {
                console.error('Error loading HVAC data:', error);
            }
        }

        function createHVACUsageChart(dailyUsage) {
            const ctx = document.getElementById('hvacUsageChart');
            if (!ctx) return;

            if (charts.hvacUsage) {
                charts.hvacUsage.destroy();
            }

            charts.hvacUsage = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyUsage.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Sessions',
                        data: dailyUsage.map(d => d.sessions),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Messages',
                        data: dailyUsage.map(d => d.messages),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createHVACModeChart(modeUsage) {
            const ctx = document.getElementById('hvacModeChart');
            if (!ctx) return;

            if (charts.hvacMode) {
                charts.hvacMode.destroy();
            }

            charts.hvacMode = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Homeowner', 'Technician'],
                    datasets: [{
                        data: [modeUsage.homeowner || 0, modeUsage.technician || 0],
                        backgroundColor: ['#e74c3c', '#3498db']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateHVACSessionsTable(sessions) {
            const tbody = document.querySelector('#hvacSessionsTable tbody');

            if (!sessions || sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No recent sessions</td></tr>';
                return;
            }

            tbody.innerHTML = sessions.map(session => `
                <tr>
                    <td><code>${session.sessionId}</code></td>
                    <td>${new Date(session.startTime).toLocaleString()}</td>
                    <td>${session.messageCount || 0}</td>
                    <td><span class="badge badge-info">${session.mode}</span></td>
                    <td><span class="badge badge-${session.resolved ? 'success' : 'warning'}">
                        ${session.resolved ? 'Completed' : 'Active'}
                    </span></td>
                </tr>
            `).join('');
        }

        // Refresh Functions
        async function refreshAnalytics() {
            showNotification('Refreshing analytics data...', 'info');
            await loadAnalyticsData();
            showNotification('Analytics data refreshed!', 'success');
        }

        async function refreshEmails() {
            showNotification('Refreshing email list...', 'info');
            await loadEmailData();
            showNotification('Email list refreshed!', 'success');
        }

        async function refreshHVAC() {
            showNotification('Refreshing HVAC Jack stats...', 'info');
            await loadHVACData();
            showNotification('HVAC Jack stats refreshed!', 'success');
        }

        // Export Functions
        async function exportAnalytics() {
            try {
                const response = await fetch('/.netlify/functions/analytics-tracker?auth=2080&days=30');
                const data = await response.json();
                downloadJSON(data, 'larklabs-analytics');
                showNotification('Analytics exported successfully!', 'success');
            } catch (error) {
                showNotification('Export failed', 'danger');
            }
        }

        async function exportEmails() {
            try {
                const response = await fetch('/.netlify/functions/collect-email?auth=2080');
                const data = await response.json();

                // Create CSV
                const csv = convertToCSV(data.subscribers);
                downloadCSV(csv, 'larklabs-subscribers');
                showNotification('Email list exported successfully!', 'success');
            } catch (error) {
                showNotification('Export failed', 'danger');
            }
        }

        async function copyEmailList() {
            try {
                const response = await fetch('/.netlify/functions/collect-email?auth=2080');
                const data = await response.json();
                const emailList = data.subscribers.map(s => s.email).join(', ');
                await navigator.clipboard.writeText(emailList);
                showNotification('Email list copied to clipboard!', 'success');
            } catch (error) {
                showNotification('Copy failed', 'danger');
            }
        }

        async function exportHVAC() {
            try {
                const response = await fetch('/.netlify/functions/get-usage-stats');
                const data = await response.json();
                downloadJSON(data, 'hvac-jack-stats');
                showNotification('HVAC Jack stats exported!', 'success');
            } catch (error) {
                showNotification('Export failed', 'danger');
            }
        }

        // Utility Functions
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';

            const headers = ['Email', 'Name', 'Source', 'Subscribed Date', 'IP'];
            const rows = data.map(sub => [
                sub.email,
                sub.name || '',
                sub.source,
                new Date(sub.subscribedAt).toLocaleDateString(),
                sub.ip
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type) {
            // Simple notification (you can enhance this)
            console.log(`${type.toUpperCase()}: ${message}`);
        }
    </script>
</body>
</html>
