<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2L Refrigerant Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional HVAC tools for A2L refrigerant systems including leak detection, P-T calculations, and system diagnostics.">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="A2L Calculator">
    <meta name="msapplication-TileColor" content="#667eea">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon and App Icons - Updated to use your PNG logo -->
    <link rel="icon" type="image/png" sizes="32x32" href="A2L_Pro_Logo.png">
    <link rel="icon" type="image/png" sizes="192x192" href="A2L_Pro_Logo.png">
    <link rel="apple-touch-icon" href="A2L_Pro_Logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="A2L_Pro_Logo.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .header h1 {
            color: #4a5568;
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            color: #718096;
            font-size: 0.9em;
        }

        /* Install Button */
        .install-container {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .install-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .install-btn.show {
            display: flex;
        }

        .install-icon {
            width: 16px;
            height: 16px;
        }

        /* Install Banner */
        .install-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9em;
        }

        .install-banner.show {
            display: flex;
        }

        .banner-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .banner-buttons {
            display: flex;
            gap: 8px;
        }

        .banner-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .banner-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .banner-btn.primary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border-color: transparent;
        }

        .banner-btn.primary:hover {
            background: white;
        }

        .nav-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 15px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85em;
            font-weight: 600;
            color: #4a5568;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:hover, .nav-btn.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .calculator {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .calculator.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calc-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .calc-header h2 {
            color: #4a5568;
            margin-bottom: 8px;
        }

        .calc-header p {
            color: #718096;
            font-size: 0.9em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .calc-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .calc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .result {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .result.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .error {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .pt-table {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 15px;
        }

        .pt-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .pt-table th, .pt-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85em;
        }

        .pt-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            position: sticky;
            top: 0;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .install-container {
                position: static;
                margin-top: 10px;
                text-align: center;
            }
            
            .nav-menu {
                grid-template-columns: 1fr 1fr;
            }
            
            .nav-btn {
                padding: 12px 8px;
                font-size: 0.8em;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }

            .install-banner {
                flex-direction: column;
                gap: 10px;
            }

            .banner-content {
                text-align: center;
            }
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.85em;
            color: #4a5568;
        }

        /* Update notification */
        .update-banner {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            color: white;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9em;
        }

        .update-banner.show {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Install Banner -->
        <div id="install-banner" class="install-banner">
            <div class="banner-content">
                <svg class="install-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Install A2L Calculator for quick access and offline use</span>
            </div>
            <div class="banner-buttons">
                <button class="banner-btn primary" onclick="installApp()">Install</button>
                <button class="banner-btn" onclick="dismissInstallBanner()">Later</button>
            </div>
        </div>

        <!-- Update Banner -->
        <div id="update-banner" class="update-banner">
            <span>New version available! Click to update.</span>
            <button class="banner-btn primary" onclick="updateApp()">Update</button>
        </div>

        <div class="header">
            <div class="install-container">
                <button id="install-button" class="install-btn" onclick="installApp()">
                    <svg class="install-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    Install
                </button>
            </div>
            <h1>A2L Refrigerant Calculator</h1>
            <p>Professional HVAC Tools for A2L Systems</p>
        </div>

        <div class="nav-menu">
            <button class="nav-btn active" onclick="showCalculator('leak-detector', this)">Leak Detector Cal</button>
            <button class="nav-btn" onclick="showCalculator('pt-calc', this)">P-T Calculator</button>
            <button class="nav-btn" onclick="showCalculator('leak-rate', this)">Leak Rate</button>
            <button class="nav-btn" onclick="showCalculator('system-diag', this)">System Diagnostic</button>
            <button class="nav-btn" onclick="showCalculator('superheat', this)">Superheat/Subcool</button>
            <button class="nav-btn" onclick="showCalculator('charge-calc', this)">Charge Calculator</button>
        </div>

        <!-- Leak Detector Calibration Calculator -->
        <div id="leak-detector" class="calculator active">
            <div class="calc-header">
                <h2>Leak Detector Calibration</h2>
                <p>Calculate calibration gas concentration for A2L leak detectors</p>
            </div>
            
            <div class="input-group">
                <label>Refrigerant Type:</label>
                <select id="cal-refrigerant">
                    <option value="R32">R-32</option>
                    <option value="R454B">R-454B</option>
                    <option value="R454C">R-454C</option>
                    <option value="R32-HFO">R-32/HFO Blend</option>
                </select>
            </div>

            <div class="input-group">
                <label>Detector Sensitivity (ppm):</label>
                <input type="number" id="cal-sensitivity" placeholder="Enter sensitivity (e.g., 10)" value="10">
            </div>

            <div class="input-group">
                <label>Calibration Factor:</label>
                <input type="number" id="cal-factor" placeholder="Enter factor (1.0-5.0)" value="2.5" step="0.1">
            </div>

            <div class="input-group">
                <label>Application Type:</label>
                <select id="cal-application">
                    <option value="residential">Residential</option>
                    <option value="commercial">Commercial</option>
                    <option value="industrial">Industrial</option>
                </select>
            </div>

            <button class="calc-btn" onclick="calculateCalibration()">Calculate Calibration</button>

            <div id="cal-result" class="result"></div>

            <div class="info-box">
                <strong>Note:</strong> A2L refrigerants require special leak detection equipment due to their mildly flammable nature. Always follow manufacturer guidelines.
            </div>
        </div>

        <!-- Pressure-Temperature Calculator -->
        <div id="pt-calc" class="calculator">
            <div class="calc-header">
                <h2>Pressure-Temperature Calculator</h2>
                <p>Convert between pressure and temperature for A2L refrigerants</p>
            </div>

            <div class="input-group">
                <label>Refrigerant:</label>
                <select id="pt-refrigerant">
                    <option value="R32">R-32</option>
                    <option value="R454B">R-454B</option>
                    <option value="R454C">R-454C</option>
                    <option value="R290">R-290 (Propane)</option>
                </select>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>Temperature (°F):</label>
                    <input type="number" id="pt-temp" placeholder="Temperature" onchange="calculatePressure()">
                </div>
                <div class="input-group">
                    <label>Pressure (PSIG):</label>
                    <input type="number" id="pt-pressure" placeholder="Pressure" onchange="calculateTemperature()">
                </div>
            </div>

            <button class="calc-btn" onclick="generatePTTable()">Generate P-T Table</button>

            <div id="pt-result" class="result"></div>

            <div id="pt-table-container" class="pt-table" style="display: none;">
                <table id="pt-table">
                    <thead>
                        <tr>
                            <th>Temp (°F)</th>
                            <th>Pressure (PSIG)</th>
                            <th>Temp (°C)</th>
                            <th>Pressure (kPa)</th>
                        </tr>
                    </thead>
                    <tbody id="pt-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Leak Rate Calculator -->
        <div id="leak-rate" class="calculator">
            <div class="calc-header">
                <h2>A2L Leak Rate Calculator</h2>
                <p>Calculate acceptable leak rates for A2L refrigerant systems</p>
            </div>

            <div class="input-group">
                <label>System Type:</label>
                <select id="leak-system-type">
                    <option value="residential">Residential Split System</option>
                    <option value="commercial">Commercial Package Unit</option>
                    <option value="vrf">VRF System</option>
                    <option value="chiller">Chiller</option>
                </select>
            </div>

            <div class="input-group">
                <label>Refrigerant Charge (lbs):</label>
                <input type="number" id="leak-charge" placeholder="Enter charge amount" step="0.1">
            </div>

            <div class="input-group">
                <label>Room Volume (ft³):</label>
                <input type="number" id="leak-room-volume" placeholder="Enter room volume">
            </div>

            <div class="input-group">
                <label>Ventilation Rate (CFM):</label>
                <input type="number" id="leak-ventilation" placeholder="Enter ventilation rate">
            </div>

            <button class="calc-btn" onclick="calculateLeakRate()">Calculate Leak Rate</button>

            <div id="leak-result" class="result"></div>

            <div class="info-box">
                <strong>A2L Safety:</strong> Maximum leak rate for A2L systems is typically 0.25 kg/h (0.55 lbs/h) in occupied spaces. Always verify with local codes.
            </div>
        </div>

        <!-- System Diagnostic Calculator -->
        <div id="system-diag" class="calculator">
            <div class="calc-header">
                <h2>System Diagnostic Calculator</h2>
                <p>Analyze A2L system performance based on operating conditions</p>
            </div>

            <div class="input-group">
                <label>Refrigerant Type:</label>
                <select id="diag-refrigerant">
                    <option value="R32">R-32</option>
                    <option value="R454B">R-454B</option>
                    <option value="R454C">R-454C</option>
                </select>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>Outdoor Temp (°F):</label>
                    <input type="number" id="diag-outdoor-temp" placeholder="Outdoor temp">
                </div>
                <div class="input-group">
                    <label>Indoor Temp (°F):</label>
                    <input type="number" id="diag-indoor-temp" placeholder="Indoor temp">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>Suction Pressure (PSIG):</label>
                    <input type="number" id="diag-suction-pressure" placeholder="Suction pressure">
                </div>
                <div class="input-group">
                    <label>Discharge Pressure (PSIG):</label>
                    <input type="number" id="diag-discharge-pressure" placeholder="Discharge pressure">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>Suction Temp (°F):</label>
                    <input type="number" id="diag-suction-temp" placeholder="Suction temp">
                </div>
                <div class="input-group">
                    <label>Liquid Line Temp (°F):</label>
                    <input type="number" id="diag-liquid-temp" placeholder="Liquid temp">
                </div>
            </div>

            <button class="calc-btn" onclick="calculateSystemDiag()">Analyze System</button>

            <div id="diag-result" class="result"></div>
        </div>

        <!-- Superheat/Subcooling Calculator -->
        <div id="superheat" class="calculator">
            <div class="calc-header">
                <h2>Superheat & Subcooling Calculator</h2>
                <p>Calculate superheat and subcooling for A2L systems</p>
            </div>

            <div class="input-group">
                <label>Refrigerant:</label>
                <select id="sh-refrigerant">
                    <option value="R32">R-32</option>
                    <option value="R454B">R-454B</option>
                    <option value="R454C">R-454C</option>
                </select>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>Suction Pressure (PSIG):</label>
                    <input type="number" id="sh-suction-pressure" placeholder="Suction pressure">
                </div>
                <div class="input-group">
                    <label>Suction Temperature (°F):</label>
                    <input type="number" id="sh-suction-temp" placeholder="Suction temp">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>Discharge Pressure (PSIG):</label>
                    <input type="number" id="sh-discharge-pressure" placeholder="Discharge pressure">
                </div>
                <div class="input-group">
                    <label>Liquid Temperature (°F):</label>
                    <input type="number" id="sh-liquid-temp" placeholder="Liquid temp">
                </div>
            </div>

            <button class="calc-btn" onclick="calculateSuperheat()">Calculate</button>

            <div id="sh-result" class="result"></div>

            <div class="info-box">
                <strong>Typical Values:</strong> Superheat: 8-12°F for TXV, 12-20°F for fixed orifice. Subcooling: 8-15°F for most systems.
            </div>
        </div>

        <!-- Charge Calculator -->
        <div id="charge-calc" class="calculator">
            <div class="calc-header">
                <h2>Refrigerant Charge Calculator</h2>
                <p>Calculate proper refrigerant charge for A2L systems</p>
            </div>

            <div class="input-group">
                <label>System Type:</label>
                <select id="charge-system-type">
                    <option value="residential-split">Residential Split System</option>
                    <option value="mini-split">Mini Split</option>
                    <option value="package">Package Unit</option>
                    <option value="vrf">VRF System</option>
                </select>
            </div>

            <div class="input-group">
                <label>Evaporator Capacity (BTU/h):</label>
                <input type="number" id="charge-capacity" placeholder="Enter capacity">
            </div>

            <div class="input-group">
                <label>Line Set Length (ft):</label>
                <input type="number" id="charge-line-length" placeholder="Total line set length">
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>Suction Line Diameter (in):</label>
                    <input type="number" id="charge-suction-diameter" placeholder="Suction diameter" step="0.125">
                </div>
                <div class="input-group">
                    <label>Liquid Line Diameter (in):</label>
                    <input type="number" id="charge-liquid-diameter" placeholder="Liquid diameter" step="0.125">
                </div>
            </div>

            <div class="input-group">
                <label>Refrigerant Type:</label>
                <select id="charge-refrigerant">
                    <option value="R32">R-32</option>
                    <option value="R454B">R-454B</option>
                    <option value="R454C">R-454C</option>
                </select>
            </div>

            <button class="calc-btn" onclick="calculateCharge()">Calculate Charge</button>

            <div id="charge-result" class="result"></div>

            <div class="info-box">
                <strong>Safety Note:</strong> A2L refrigerants have specific charge limits for occupied spaces. Always verify with equipment manufacturer and local codes.
            </div>
        </div>
    </div>

    <!-- Include chat and health monitoring scripts -->
    <script src="chat.js"></script>
    <script src="health.js"></script>

    <!-- Service Worker Registration and App Logic -->
    <script>
        // PWA Installation and Service Worker
        let deferredPrompt;
        let isInstalled = false;
        
        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            isInstalled = true;
            hideInstallPromotion();
            console.log('App installed successfully');
        });

        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt event fired');
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Save the event so it can be triggered later
            deferredPrompt = e;
            // Show install promotion
            showInstallPromotion();
        });

        // Check if we should show install promotion on load
        window.addEventListener('load', () => {
            // Check if already installed (standalone mode)
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                isInstalled = true;
                console.log('App is running in standalone mode');
                return;
            }

            // Show install button after a short delay if not already triggered by beforeinstallprompt
            setTimeout(() => {
                if (!isInstalled && !deferredPrompt) {
                    console.log('Showing install button - fallback method');
                    document.getElementById('install-button').classList.add('show');
                    // Show banner if not dismissed
                    if (!localStorage.getItem('installBannerDismissed')) {
                        document.getElementById('install-banner').classList.add('show');
                    }
                }
            }, 2000);
        });

        function showInstallPromotion() {
            console.log('showInstallPromotion called');
            if (!isInstalled) {
                // Show install button
                const installBtn = document.getElementById('install-button');
                if (installBtn) {
                    installBtn.classList.add('show');
                    console.log('Install button shown');
                }
                
                // Show banner if not dismissed
                if (!localStorage.getItem('installBannerDismissed')) {
                    const installBanner = document.getElementById('install-banner');
                    if (installBanner) {
                        installBanner.classList.add('show');
                        console.log('Install banner shown');
                    }
                }
            }
        }

        function hideInstallPromotion() {
            console.log('hideInstallPromotion called');
            const installBtn = document.getElementById('install-button');
            const installBanner = document.getElementById('install-banner');
            
            if (installBtn) installBtn.classList.remove('show');
            if (installBanner) installBanner.classList.remove('show');
        }

        function installApp() {
            console.log('installApp called');
            
            if (deferredPrompt) {
                console.log('Using deferredPrompt');
                // Hide the promotion first
                hideInstallPromotion();
                
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('User choice:', choiceResult.outcome);
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        isInstalled = true;
                    } else {
                        console.log('User dismissed the install prompt');
                        // Show again in 24 hours
                        setTimeout(showInstallPromotion, 24 * 60 * 60 * 1000);
                    }
                    deferredPrompt = null;
                });
            } else {
                console.log('No deferredPrompt available');
                
                // Check if we're on iOS
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
                
                if (isIOS && !isInStandaloneMode) {
                    // iOS Safari instructions
                    alert('To install this app on iOS:\n\n1. Tap the Share button (⬆️) in Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to confirm\n\nThe app will then work offline and appear on your home screen!');
                } else if ('serviceWorker' in navigator) {
                    // For other browsers, show general instructions
                    alert('To install this app:\n\n• Chrome/Edge: Look for the install icon in the address bar\n• Firefox: Use "Add to Home Screen" from the menu\n• Safari: Use "Add to Home Screen" from the share menu\n\nOnce installed, the app will work offline!');
                } else {
                    // Fallback for browsers that don't support PWA installation
                    alert('This browser doesn\'t fully support app installation.\n\nFor the best experience, try using:\n• Chrome\n• Firefox\n• Safari\n• Microsoft Edge');
                }
            }
        }

        function dismissInstallBanner() {
            document.getElementById('install-banner').classList.remove('show');
            localStorage.setItem('installBannerDismissed', 'true');
            // Show banner again after 7 days
            setTimeout(() => {
                localStorage.removeItem('installBannerDismissed');
            }, 7 * 24 * 60 * 60 * 1000);
        }

        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('ServiceWorker registered successfully');
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version is available
                                showUpdateBanner();
                            }
                        });
                    });
                } catch (error) {
                    console.log('ServiceWorker registration failed');
                }
            });
        }

        function showUpdateBanner() {
            document.getElementById('update-banner').classList.add('show');
        }

        function updateApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then((registration) => {
                    if (registration && registration.waiting) {
                        registration.waiting.postMessage({ action: 'skipWaiting' });
                        registration.waiting.addEventListener('statechange', () => {
                            window.location.reload();
                        });
                    }
                });
            }
        }

        // Original calculator functions remain the same...
        
        // Refrigerant property data for A2L refrigerants
        const refrigerantData = {
            'R32': {
                name: 'R-32',
                gwp: 675,
                safety: 'A2L',
                density: 2.07, // lb/ft³ at liquid state
                chargeMultiplier: 0.95,
                ptData: [
                    {temp: -10, pressure: -6.8}, {temp: 0, pressure: 7.1}, {temp: 10, pressure: 22.9},
                    {temp: 20, pressure: 40.6}, {temp: 30, pressure: 60.3}, {temp: 40, pressure: 82.2},
                    {temp: 50, pressure: 106.4}, {temp: 60, pressure: 133.0}, {temp: 70, pressure: 162.1},
                    {temp: 80, pressure: 193.9}, {temp: 90, pressure: 228.4}, {temp: 100, pressure: 265.8}
                ]
            },
            'R454B': {
                name: 'R-454B',
                gwp: 466,
                safety: 'A2L',
                density: 1.89,
                chargeMultiplier: 1.02,
                ptData: [
                    {temp: -10, pressure: -2.1}, {temp: 0, pressure: 12.8}, {temp: 10, pressure: 29.6},
                    {temp: 20, pressure: 48.3}, {temp: 30, pressure: 69.1}, {temp: 40, pressure: 92.1},
                    {temp: 50, pressure: 117.4}, {temp: 60, pressure: 145.1}, {temp: 70, pressure: 175.3},
                    {temp: 80, pressure: 208.1}, {temp: 90, pressure: 243.6}, {temp: 100, pressure: 281.9}
                ]
            },
            'R454C': {
                name: 'R-454C',
                gwp: 148,
                safety: 'A2L',
                density: 1.76,
                chargeMultiplier: 1.08,
                ptData: [
                    {temp: -10, pressure: 1.2}, {temp: 0, pressure: 16.8}, {temp: 10, pressure: 34.3},
                    {temp: 20, pressure: 53.7}, {temp: 30, pressure: 75.2}, {temp: 40, pressure: 98.9},
                    {temp: 50, pressure: 124.9}, {temp: 60, pressure: 153.3}, {temp: 70, pressure: 184.2},
                    {temp: 80, pressure: 217.7}, {temp: 90, pressure: 253.9}, {temp: 100, pressure: 292.9}
                ]
            },
            'R290': {
                name: 'R-290 (Propane)',
                gwp: 3,
                safety: 'A3',
                density: 1.22,
                chargeMultiplier: 0.42,
                ptData: [
                    {temp: -10, pressure: 2.4}, {temp: 0, pressure: 18.7}, {temp: 10, pressure: 37.1},
                    {temp: 20, pressure: 57.7}, {temp: 30, pressure: 80.6}, {temp: 40, pressure: 105.9},
                    {temp: 50, pressure: 133.7}, {temp: 60, pressure: 164.2}, {temp: 70, pressure: 197.4},
                    {temp: 80, pressure: 233.5}, {temp: 90, pressure: 272.6}, {temp: 100, pressure: 314.7}
                ]
            }
        };

        function showCalculator(calcId, clickedButton = null) {
            // Hide all calculators
            const calculators = document.querySelectorAll('.calculator');
            calculators.forEach(calc => calc.classList.remove('active'));
            
            // Remove active class from all nav buttons
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('active'));
            
            // Show selected calculator
            document.getElementById(calcId).classList.add('active');
            
            // Add active class to clicked button
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find and activate the corresponding nav button
                const targetBtn = Array.from(navBtns).find(btn => 
                    btn.onclick.toString().includes(calcId)
                );
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
            }
        }

        function calculateCalibration() {
            const refrigerant = document.getElementById('cal-refrigerant').value;
            const sensitivity = parseFloat(document.getElementById('cal-sensitivity').value);
            const factor = parseFloat(document.getElementById('cal-factor').value);
            const application = document.getElementById('cal-application').value;

            if (!sensitivity || !factor) {
                showResult('cal-result', 'Please enter valid sensitivity and calibration factor values.', 'error');
                return;
            }

            const calibrationGas = sensitivity * factor;
            const lfl = refrigerant === 'R32' ? 144000 : 
                       refrigerant === 'R454B' ? 140000 : 
                       refrigerant === 'R454C' ? 138000 : 135000; // ppm

            const safetyMargin = (calibrationGas / lfl) * 100;
            
            let recommendation = '';
            if (safetyMargin < 0.01) {
                recommendation = '✅ Excellent safety margin';
            } else if (safetyMargin < 0.05) {
                recommendation = '⚠️ Good safety margin';
            } else {
                recommendation = '❌ Consider lower calibration gas concentration';
            }

            const result = `
                <strong>Calibration Results for ${refrigerant}</strong><br>
                📊 Calibration Gas: ${calibrationGas.toFixed(1)} ppm<br>
                🔥 Lower Flammability Limit: ${(lfl/1000).toFixed(0)}k ppm<br>
                🛡️ Safety Margin: ${safetyMargin.toFixed(3)}% of LFL<br>
                💡 ${recommendation}<br><br>
                <strong>Application:</strong> ${application.charAt(0).toUpperCase() + application.slice(1)}
            `;

            showResult('cal-result', result);
        }

        function calculatePressure() {
            const temp = parseFloat(document.getElementById('pt-temp').value);
            const refrigerant = document.getElementById('pt-refrigerant').value;

            if (!temp) return;

            const pressure = interpolatePressure(temp, refrigerant);
            document.getElementById('pt-pressure').value = pressure.toFixed(1);
            
            showResult('pt-result', `At ${temp}°F, ${refrigerantData[refrigerant].name} pressure is ${pressure.toFixed(1)} PSIG`);
        }

        function calculateTemperature() {
            const pressure = parseFloat(document.getElementById('pt-pressure').value);
            const refrigerant = document.getElementById('pt-refrigerant').value;

            if (!pressure) return;

            const temp = interpolateTemperature(pressure, refrigerant);
            document.getElementById('pt-temp').value = temp.toFixed(1);
            
            showResult('pt-result', `At ${pressure} PSIG, ${refrigerantData[refrigerant].name} temperature is ${temp.toFixed(1)}°F`);
        }

        function interpolatePressure(temp, refrigerant) {
            const data = refrigerantData[refrigerant].ptData;
            
            // Find surrounding data points
            for (let i = 0; i < data.length - 1; i++) {
                if (temp >= data[i].temp && temp <= data[i + 1].temp) {
                    const ratio = (temp - data[i].temp) / (data[i + 1].temp - data[i].temp);
                    return data[i].pressure + ratio * (data[i + 1].pressure - data[i].pressure);
                }
            }
            
            // Extrapolate if outside range
            if (temp < data[0].temp) {
                const slope = (data[1].pressure - data[0].pressure) / (data[1].temp - data[0].temp);
                return data[0].pressure + slope * (temp - data[0].temp);
            } else {
                const lastIdx = data.length - 1;
                const slope = (data[lastIdx].pressure - data[lastIdx - 1].pressure) / (data[lastIdx].temp - data[lastIdx - 1].temp);
                return data[lastIdx].pressure + slope * (temp - data[lastIdx].temp);
            }
        }

        function interpolateTemperature(pressure, refrigerant) {
            const data = refrigerantData[refrigerant].ptData;
            
            // Find surrounding data points
            for (let i = 0; i < data.length - 1; i++) {
                if (pressure >= data[i].pressure && pressure <= data[i + 1].pressure) {
                    const ratio = (pressure - data[i].pressure) / (data[i + 1].pressure - data[i].pressure);
                    return data[i].temp + ratio * (data[i + 1].temp - data[i].temp);
                }
            }
            
            // Extrapolate if outside range
            if (pressure < data[0].pressure) {
                const slope = (data[1].temp - data[0].temp) / (data[1].pressure - data[0].pressure);
                return data[0].temp + slope * (pressure - data[0].pressure);
            } else {
                const lastIdx = data.length - 1;
                const slope = (data[lastIdx].temp - data[lastIdx - 1].temp) / (data[lastIdx].pressure - data[lastIdx - 1].pressure);
                return data[lastIdx].temp + slope * (pressure - data[lastIdx].pressure);
            }
        }

        function generatePTTable() {
            const refrigerant = document.getElementById('pt-refrigerant').value;
            const tableBody = document.getElementById('pt-table-body');
            const tableContainer = document.getElementById('pt-table-container');
            
            tableBody.innerHTML = '';
            
            for (let tempF = -10; tempF <= 120; tempF += 10) {
                const pressurePSIG = interpolatePressure(tempF, refrigerant);
                const tempC = ((tempF - 32) * 5 / 9);
                const pressureKPa = (pressurePSIG + 14.7) * 6.895;
                
                const row = `
                    <tr>
                        <td>${tempF}</td>
                        <td>${pressurePSIG.toFixed(1)}</td>
                        <td>${tempC.toFixed(1)}</td>
                        <td>${pressureKPa.toFixed(0)}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            }
            
            tableContainer.style.display = 'block';
            showResult('pt-result', `P-T Table generated for ${refrigerantData[refrigerant].name}`);
        }

        function calculateLeakRate() {
            const systemType = document.getElementById('leak-system-type').value;
            const charge = parseFloat(document.getElementById('leak-charge').value);
            const roomVolume = parseFloat(document.getElementById('leak-room-volume').value);
            const ventilation = parseFloat(document.getElementById('leak-ventilation').value);

            if (!charge || !roomVolume) {
                showResult('leak-result', 'Please enter charge amount and room volume.', 'error');
                return;
            }

            // A2L maximum acceptable leak rate calculations
            const maxLeakRate = 0.55; // lbs/h per ASHRAE 15
            const chargeKg = charge * 0.453592;
            const roomVolumeM3 = roomVolume * 0.0283168;
            
            // Calculate LFL concentration limit
            const lflKgM3 = 0.31; // kg/m³ for most A2L refrigerants
            const maxChargeDensity = lflKgM3 * roomVolumeM3;
            
            let safetyAssessment = '';
            if (chargeKg <= maxChargeDensity * 0.25) {
                safetyAssessment = '✅ Charge is well within safety limits';
            } else if (chargeKg <= maxChargeDensity * 0.5) {
                safetyAssessment = '⚠️ Charge requires enhanced safety measures';
            } else {
                safetyAssessment = '❌ Charge may exceed safety limits - review required';
            }

            const ventilationFactor = ventilation > 0 ? ventilation / roomVolume : 0;
            const adjustedMaxLeak = maxLeakRate * (1 + ventilationFactor * 0.1);

            const result = `
                <strong>Leak Rate Analysis</strong><br>
                🏠 System: ${systemType.replace('-', ' ')}<br>
                📊 Charge: ${charge} lbs (${chargeKg.toFixed(2)} kg)<br>
                🏢 Room: ${roomVolume} ft³ (${roomVolumeM3.toFixed(1)} m³)<br>
                💨 Ventilation: ${ventilation || 'Not specified'} CFM<br><br>
                <strong>Safety Assessment:</strong><br>
                🔴 Max Allowable Leak: ${adjustedMaxLeak.toFixed(2)} lbs/h<br>
                🟡 Charge Density: ${(chargeKg/roomVolumeM3).toFixed(3)} kg/m³<br>
                🟢 LFL Limit: ${lflKgM3} kg/m³<br><br>
                ${safetyAssessment}
            `;

            showResult('leak-result', result);
        }

        function calculateSystemDiag() {
            const refrigerant = document.getElementById('diag-refrigerant').value;
            const outdoorTemp = parseFloat(document.getElementById('diag-outdoor-temp').value);
            const indoorTemp = parseFloat(document.getElementById('diag-indoor-temp').value);
            const suctionPressure = parseFloat(document.getElementById('diag-suction-pressure').value);
            const dischargePressure = parseFloat(document.getElementById('diag-discharge-pressure').value);
            const suctionTemp = parseFloat(document.getElementById('diag-suction-temp').value);
            const liquidTemp = parseFloat(document.getElementById('diag-liquid-temp').value);

            if (!outdoorTemp || !indoorTemp || !suctionPressure || !dischargePressure) {
                showResult('diag-result', 'Please enter all required values.', 'error');
                return;
            }

            // Calculate expected pressures based on temperatures
            const expectedSuctionPressure = interpolatePressure(indoorTemp - 35, refrigerant);
            const expectedDischargePressure = interpolatePressure(outdoorTemp + 30, refrigerant);

            // Calculate superheat and subcooling if temperatures provided
            let superheat = 0;
            let subcooling = 0;
            
            if (suctionTemp) {
                const saturationTemp = interpolateTemperature(suctionPressure, refrigerant);
                superheat = suctionTemp - saturationTemp;
            }
            
            if (liquidTemp) {
                const saturationTempHigh = interpolateTemperature(dischargePressure, refrigerant);
                subcooling = saturationTempHigh - liquidTemp;
            }

            // System analysis
            let diagnosis = [];
            
            if (suctionPressure < expectedSuctionPressure * 0.9) {
                diagnosis.push('🔴 Low suction pressure - possible undercharge or restriction');
            } else if (suctionPressure > expectedSuctionPressure * 1.1) {
                diagnosis.push('🟡 High suction pressure - possible overcharge or poor heat rejection');
            } else {
                diagnosis.push('✅ Suction pressure normal');
            }

            if (dischargePressure < expectedDischargePressure * 0.9) {
                diagnosis.push('🟡 Low discharge pressure - check condenser');
            } else if (dischargePressure > expectedDischargePressure * 1.1) {
                diagnosis.push('🔴 High discharge pressure - poor condenser performance');
            } else {
                diagnosis.push('✅ Discharge pressure normal');
            }

            if (superheat > 0) {
                if (superheat < 5) {
                    diagnosis.push('🔴 Low superheat - possible flooding');
                } else if (superheat > 20) {
                    diagnosis.push('🔴 High superheat - possible undercharge');
                } else {
                    diagnosis.push('✅ Superheat normal');
                }
            }

            if (subcooling > 0) {
                if (subcooling < 5) {
                    diagnosis.push('🔴 Low subcooling - possible undercharge');
                } else if (subcooling > 20) {
                    diagnosis.push('🔴 High subcooling - possible overcharge');
                } else {
                    diagnosis.push('✅ Subcooling normal');
                }
            }

            const result = `
                <strong>System Diagnostic - ${refrigerantData[refrigerant].name}</strong><br>
                🌡️ Conditions: ${outdoorTemp}°F OAT, ${indoorTemp}°F IAT<br><br>
                <strong>Pressures:</strong><br>
                📊 Suction: ${suctionPressure} PSIG (Expected: ${expectedSuctionPressure.toFixed(1)})<br>
                📊 Discharge: ${dischargePressure} PSIG (Expected: ${expectedDischargePressure.toFixed(1)})<br><br>
                ${superheat > 0 ? `🔥 Superheat: ${superheat.toFixed(1)}°F<br>` : ''}
                ${subcooling > 0 ? `❄️ Subcooling: ${subcooling.toFixed(1)}°F<br><br>` : '<br>'}
                <strong>Diagnosis:</strong><br>
                ${diagnosis.join('<br>')}
            `;

            showResult('diag-result', result);
        }

        function calculateSuperheat() {
            const refrigerant = document.getElementById('sh-refrigerant').value;
            const suctionPressure = parseFloat(document.getElementById('sh-suction-pressure').value);
            const suctionTemp = parseFloat(document.getElementById('sh-suction-temp').value);
            const dischargePressure = parseFloat(document.getElementById('sh-discharge-pressure').value);
            const liquidTemp = parseFloat(document.getElementById('sh-liquid-temp').value);

            if (!suctionPressure || !suctionTemp || !dischargePressure || !liquidTemp) {
                showResult('sh-result', 'Please enter all required values.', 'error');
                return;
            }

            const saturationTempLow = interpolateTemperature(suctionPressure, refrigerant);
            const saturationTempHigh = interpolateTemperature(dischargePressure, refrigerant);
            
            const superheat = suctionTemp - saturationTempLow;
            const subcooling = saturationTempHigh - liquidTemp;

            let superheatStatus = '';
            if (superheat < 5) {
                superheatStatus = '🔴 Low - Risk of flooding';
            } else if (superheat >= 5 && superheat <= 15) {
                superheatStatus = '✅ Normal range';
            } else if (superheat <= 25) {
                superheatStatus = '🟡 High - Check charge';
            } else {
                superheatStatus = '🔴 Very high - Undercharged';
            }

            let subcoolingStatus = '';
            if (subcooling < 5) {
                subcoolingStatus = '🔴 Low - Undercharged';
            } else if (subcooling >= 5 && subcooling <= 15) {
                subcoolingStatus = '✅ Normal range';
            } else if (subcooling <= 25) {
                subcoolingStatus = '🟡 High - Check system';
            } else {
                subcoolingStatus = '🔴 Very high - Overcharged';
            }

            const result = `
                <strong>Superheat & Subcooling Analysis - ${refrigerantData[refrigerant].name}</strong><br><br>
                <strong>Superheat Calculation:</strong><br>
                📊 Suction Temp: ${suctionTemp}°F<br>
                📊 Saturation Temp: ${saturationTempLow.toFixed(1)}°F<br>
                🔥 <strong>Superheat: ${superheat.toFixed(1)}°F</strong><br>
                Status: ${superheatStatus}<br><br>
                <strong>Subcooling Calculation:</strong><br>
                📊 Liquid Temp: ${liquidTemp}°F<br>
                📊 Saturation Temp: ${saturationTempHigh.toFixed(1)}°F<br>
                ❄️ <strong>Subcooling: ${subcooling.toFixed(1)}°F</strong><br>
                Status: ${subcoolingStatus}
            `;

            showResult('sh-result', result);
        }

        function calculateCharge() {
            const systemType = document.getElementById('charge-system-type').value;
            const capacity = parseFloat(document.getElementById('charge-capacity').value);
            const lineLength = parseFloat(document.getElementById('charge-line-length').value);
            const suctionDiameter = parseFloat(document.getElementById('charge-suction-diameter').value);
            const liquidDiameter = parseFloat(document.getElementById('charge-liquid-diameter').value);
            const refrigerant = document.getElementById('charge-refrigerant').value;

            if (!capacity || !lineLength) {
                showResult('charge-result', 'Please enter capacity and line length.', 'error');
                return;
            }

            // Base charge calculation (simplified)
            const baseChargeOzPerBTU = systemType === 'mini-split' ? 0.0008 : 
                                     systemType === 'residential-split' ? 0.001 :
                                     systemType === 'package' ? 0.0012 : 0.0015;

            const baseCharge = capacity * baseChargeOzPerBTU;

            // Line set charge calculation
            let lineSetCharge = 0;
            if (suctionDiameter && liquidDiameter) {
                const suctionVolume = Math.PI * Math.pow(suctionDiameter / 2, 2) * lineLength / 12; // ft³
                const liquidVolume = Math.PI * Math.pow(liquidDiameter / 2, 2) * lineLength / 12; // ft³
                
                const refrigData = refrigerantData[refrigerant];
                const suctionCharge = suctionVolume * 0.05; // Approximate vapor density
                const liquidCharge = liquidVolume * refrigData.density;
                
                lineSetCharge = (suctionCharge + liquidCharge) * 16; // Convert to oz
            } else {
                // Simplified line set charge
                lineSetCharge = lineLength * 0.6; // oz per foot (typical)
            }

            const totalCharge = (baseCharge + lineSetCharge) * refrigerantData[refrigerant].chargeMultiplier;
            const chargeLbs = totalCharge / 16;

            // Safety considerations for A2L
            const maxResidentialCharge = 4.4; // lbs for residential
            const maxCommercialCharge = 13.2; // lbs for commercial

            let safetyNote = '';
            if (systemType.includes('residential') && chargeLbs > maxResidentialCharge) {
                safetyNote = '⚠️ Exceeds residential A2L charge limit - additional safety measures required';
            } else if (chargeLbs > maxCommercialCharge) {
                safetyNote = '⚠️ Large charge - verify local code compliance for A2L systems';
            } else {
                safetyNote = '✅ Within typical A2L charge limits';
            }

            const result = `
                <strong>Refrigerant Charge Calculation - ${refrigerantData[refrigerant].name}</strong><br><br>
                🏠 System: ${systemType.replace('-', ' ')}<br>
                🔧 Capacity: ${capacity.toLocaleString()} BTU/h<br>
                📏 Line Length: ${lineLength} ft<br><br>
                <strong>Charge Breakdown:</strong><br>
                📊 Base System: ${baseCharge.toFixed(1)} oz<br>
                📊 Line Set: ${lineSetCharge.toFixed(1)} oz<br>
                📊 A2L Factor: ${refrigerantData[refrigerant].chargeMultiplier}x<br><br>
                <strong>🎯 Total Charge: ${totalCharge.toFixed(1)} oz (${chargeLbs.toFixed(2)} lbs)</strong><br><br>
                ${safetyNote}
            `;

            showResult('charge-result', result);
        }

        function showResult(elementId, message, type = 'success') {
            const resultDiv = document.getElementById(elementId);
            resultDiv.innerHTML = message;
            resultDiv.className = `result show ${type === 'error' ? 'error' : ''}`;
        }

        // Initialize with first calculator and check for install capability
        document.addEventListener('DOMContentLoaded', function() {
            showCalculator('leak-detector');
            
            // Debug: Check PWA support
            console.log('PWA Support Check:');
            console.log('- Service Worker:', 'serviceWorker' in navigator);
            console.log('- Standalone mode:', window.matchMedia('(display-mode: standalone)').matches);
            console.log('- iOS standalone:', window.navigator.standalone === true);
            console.log('- User agent:', navigator.userAgent);
            
            // Force show install elements for testing (remove in production if desired)
            setTimeout(() => {
                if (!isInstalled) {
                    console.log('Force showing install elements for visibility');
                    const installBtn = document.getElementById('install-button');
                    const installBanner = document.getElementById('install-banner');
                    
                    if (installBtn) {
                        installBtn.classList.add('show');
                        installBtn.style.display = 'flex'; // Force display
                    }
                    
                    if (installBanner && !localStorage.getItem('installBannerDismissed')) {
                        installBanner.classList.add('show');
                        installBanner.style.display = 'flex'; // Force display
                    }
                }
            }, 1000);
        });
    </script>
</body>
</html>
