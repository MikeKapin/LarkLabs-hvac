<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G3 AI Tutor - CSA Gas Technician Resource</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .app-container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 300;
        }

        .header .subtitle {
            margin-top: 5px;
            opacity: 0.95;
            font-size: 14px;
            color: #bdc3c7;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .control-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 15px 20px;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .context-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 20px;
            max-width: 85%;
        }

        .message.user {
            margin-left: auto;
        }

        .message.ai {
            margin-right: auto;
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.ai .message-content {
            background: #f8f9fa;
            color: #2c3e50;
            border: 1px solid #e9ecef;
        }

        .chat-input-area {
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            padding: 20px;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }

        .send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            color: #6c757d;
            font-style: italic;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .app-container {
                height: 95vh;
                margin: 10px;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>ðŸ”¥ G3 AI Tutor</h1>
            <div class="subtitle">CSA Gas Technician Certification Resource Assistant</div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="control-group">
                    <label for="moduleSelect">Select Module:</label>
                    <select id="moduleSelect">
                        <option value="">Choose a module...</option>
                        <option value="1">Module 1: Safety</option>
                        <option value="2">Module 2: Tools</option>
                        <option value="3">Module 3: Properties and Safe Handling of Fuel Gases</option>
                        <option value="4">Module 4: Codes and Standards</option>
                        <option value="5">Module 5: Electrical Fundamentals</option>
                        <option value="6">Module 6: Technical Drawings, Manuals and Graphs</option>
                        <option value="7">Module 7: Customer Relations</option>
                        <option value="8">Module 8: Introduction to Piping and Tubing Systems</option>
                        <option value="9">Module 9: Introduction to Gas Appliances</option>
                    </select>
                </div>

                <div class="control-group" id="chapterSelector" style="display: none;">
                    <label for="chapterSelect">Select Chapter:</label>
                    <select id="chapterSelect">
                        <option value="">All Chapters</option>
                    </select>
                </div>
            </div>

            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-title" id="chatTitle">AI Tutor Chat</div>
                    <div class="context-info" id="contextInfo">Select a module to begin learning</div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="loading-message">
                        Select a module and chapter to start learning with your AI tutor assistant!
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    AI is thinking...
                </div>

                <div class="chat-input-area">
                    <div class="input-container">
                        <textarea id="chatInput" class="chat-input" placeholder="Ask questions about the chapter content, request elaboration, or seek clarification..."></textarea>
                        <button id="sendBtn" class="send-btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Module data storage
        let moduleDataCache = {};
        let currentModule = null;
        let currentChapter = null;

        // Embedded Module 1 Data
        const module1SafetyData = {
            moduleId: 1,
            title: "Safety",
            keywords: ["safety", "ppe", "hazards", "emergency", "procedures", "lockout", "tagout", "gas detection", "confined spaces", "msd", "musculoskeletal", "work habits", "protective equipment", "site hazards", "group safety", "ventilation", "first aid", "emergency plans", "tools", "hand tools", "power tools", "electrical tools", "pneumatic tools", "ladders", "scaffolds"],
            description: "Fundamental safety principles and procedures for gas technicians including on-the-job safety measures, hazard identification, and safe work practices",
            keyTopics: [
                "Personal safety factors and work habits",
                "Musculoskeletal Disorder (MSD) hazards prevention",
                "Personal Protective Equipment (PPE) requirements",
                "Site hazards and protection measures",
                "Group safety equipment and procedures",
                "First aid equipment and emergency response",
                "Hand tools, power tools, and equipment safety",
                "Lockout/tagout procedures",
                "Ladder and scaffold safety",
                "General safety rules and responsibilities"
            ],
            chapters: {
                1: {
                    id: 1,
                    title: "Personal Safety Factors",
                    content: {
                        overview: "Personal safety is a combination of knowledge and awareness. Gas technicians must be knowledgeable and skillful in tool use and aware of hazards and safety procedures.",
                        workHabits: [
                            "Courtesy - Taking into account the safety of those you work with",
                            "Attention - To safety of your environment and those working nearby",
                            "Safe conduct - Wearing appropriate PPE, good housekeeping, following procedures"
                        ]
                    }
                },
                2: {
                    id: 2,
                    title: "Musculoskeletal Disorder (MSD) Hazards",
                    content: {
                        overview: "MSD hazards increase the risk of workers developing musculoskeletal disorders. Primary hazards are force, posture, and repetition.",
                        hazardTypes: {
                            force: "The amount of effort exerted by muscles and pressure on body parts from job demands. Can damage muscles, tendons, joints, and soft tissue.",
                            posture: "Position of body parts during activity. Poor posture away from neutral position increases strain and injury risk.",
                            repetition: "Risk increases when same body parts are used repeatedly with few breaks. Can lead to fatigue and tissue damage."
                        }
                    }
                },
                3: {
                    id: 3,
                    title: "Personal Protective Equipment (PPE)",
                    content: {
                        overview: "Standard safety clothing is usually mandatory. PPE is the 'last line of defence' - environment awareness and safe work practice come first.",
                        requirements: {
                            head: "Hard hats required in construction environments. Must be CSA-approved, adjustable. No metallic hats near electrical equipment.",
                            respiratory: "Approved masks/respirators for airborne particles, chemicals, toxic gases. Special certification may be required.",
                            eye: "Safety glasses required. Must be CSA-certified for job conditions. Protection from arc flash for electrical work.",
                            hearing: "Protection required in noisy environments. Choose appropriate type - plugs should fit tightly and be clean.",
                            hand: "Cut-resistant gloves, thermal protection, chemical-resistant gloves as needed. Right protection for specific hazards.",
                            foot: "CSA-approved safety footwear. Grade 1 with green triangle marking. Electrical shock resistance for live electrical work."
                        }
                    }
                },
                4: {
                    id: 4,
                    title: "Site Hazards and Protection",
                    content: {
                        overview: "Work sites contain various physical and atmospheric hazards that gas technicians must identify and protect against.",
                        physicalHazards: [
                            "Working in restricted spaces and cramped areas",
                            "Difficulty gaining access",
                            "Moving or non-fixed equipment",
                            "Corrosive residues",
                            "Electrical hazards",
                            "Movement of liquids or solids in pipes and vessels",
                            "Temperature extremes"
                        ],
                        atmosphericHazards: [
                            "Combustible or explosive gases and vapours",
                            "Too much or too little oxygen",
                            "Toxic fumes (CO)"
                        ],
                        confinedSpaces: {
                            definition: "Work area where location, design, or construction restricts entry and exit and where equipment, operations, or atmospheres may pose hazards.",
                            requirements: "Site- and situation-specific resources and certification required before engaging in confined space activities."
                        }
                    }
                },
                5: {
                    id: 5,
                    title: "Group Safety Equipment",
                    content: {
                        overview: "Equipment such as fire extinguishers and first aid kits supplied by the employer and positioned around the job site.",
                        fireExtinguishers: "Designed to fight small fires. Standard extinguisher has little value after fire is well underway.",
                        fireBlankets: "Use approved fire blanket (ultra-heavy fibreglass) to catch sparks and slag when welding above flammable substances.",
                        ventilation: {
                            vacuum: "Remove sawdust and chips from machines",
                            exhaust: "Remove exhaust gases from mechanical shops",
                            special: "Remove harmful dust and toxic paint fumes in spray-painting booths"
                        }
                    }
                },
                6: {
                    id: 6,
                    title: "Emergency Plans and First Aid",
                    content: {
                        overview: "Every work site should have Emergency Response Plan and first aid facilities.",
                        firstAid: "Most industrial settings include first aid station with trained attendant. Know location, who staffs it, and available services.",
                        emergencyPlans: "Every work site should have Emergency Response Plan. Workers must familiarize themselves and consult supervisor for resource.",
                        emergencyShutdown: "Learn location of emergency shutdown systems or 'panic buttons'. Hit the panic button in emergency - don't hunt for correct switch."
                    }
                },
                7: {
                    id: 7,
                    title: "Safety of Tools and Equipment",
                    content: {
                        overview: "Proper tool selection, maintenance, and safe usage practices for hand tools, power tools, and equipment.",
                        handToolsDo: [
                            "Select proper tool for the job",
                            "Keep tools clean, serviced, and in good condition",
                            "Check handles of hammers and axes fit tight",
                            "Only use pipe wrenches to turn or hold pipe",
                            "Replace worn jaws on pipe tools",
                            "Return tools to proper place when not in use"
                        ],
                        handToolsDoNot: [
                            "Use tool for purpose other than intended",
                            "Use damaged or unsafe tools",
                            "Leave tools where they can fall and strike someone",
                            "Use file or rasp without handle",
                            "Use pipe extenders with wrenches",
                            "Use pliers as hammer"
                        ],
                        powerToolsSafety: [
                            "Only authorized persons use power tools",
                            "Review operation manual before use",
                            "Shut off machinery when leaving area",
                            "Let revolving machinery stop on its own",
                            "Disconnect and lock off before adjusting/cleaning"
                        ],
                        powerToolsProtection: [
                            "Always use protective equipment for eyes/face",
                            "Use dust mask when sanding or buffing",
                            "Beware of moving parts",
                            "Don't use without guards and covers in place"
                        ],
                        lockoutProcedures: {
                            purpose: "Use locks to ensure all sources of hazardous energy are isolated during work",
                            requirements: [
                                "Assess system hazards thoroughly",
                                "Isolate and lock off all energy sources",
                                "Each worker has own lock and key",
                                "Use safety tags to identify who locked out system",
                                "Never work live unless authorized and supervised"
                            ]
                        }
                    }
                },
                8: {
                    id: 8,
                    title: "Ladder and Scaffold Safety",
                    content: {
                        overview: "Safety procedures and precautions for ladder and scaffold usage in gas technician work.",
                        commonHazards: [
                            "Falls from slippery rungs or improper gripping",
                            "Ladders not properly secured to ground/wall",
                            "High winds causing fall over",
                            "Workers leaning out at dangerous angles",
                            "Proximity to electrical lines",
                            "Damaged or defective ladders"
                        ],
                        precautions: [
                            "Check for defects before use",
                            "Check for nearby power lines",
                            "Ensure firm, level surface",
                            "Set ladder 1 ft out for every 3 ft up (3:1 ratio)",
                            "Top rails at least 3 ft above sill or landing",
                            "Maintain 3-point contact when climbing",
                            "Use safety belt at heights over 10 ft"
                        ],
                        inspection: {
                            checkFor: [
                                "Straightness and rigidity",
                                "Frayed or worn ropes on extension types",
                                "Dents and bends",
                                "Rail and rung strength",
                                "Proper swivelling and non-skidding feet"
                            ],
                            maintenance: [
                                "Keep free of grease, oil, and debris",
                                "Don't paint ladders - may hide defects"
                            ]
                        }
                    }
                }
            },
            commonQuestions: [
                {
                    question: "What PPE is required for gas technicians?",
                    answer: "Essential PPE includes ANSI-approved safety glasses, CSA-approved safety footwear, cut-resistant work gloves, high-visibility clothing when required, and combustible gas detectors. Hard hats are required in construction environments. Respiratory protection may be needed for toxic gases or confined spaces."
                },
                {
                    question: "What are the primary MSD hazards?",
                    answer: "The primary MSD (Musculoskeletal Disorder) hazards are force, posture, and repetition. Force involves muscle effort and pressure on body parts. Poor posture away from neutral position increases strain. Repetition of tasks without adequate breaks can lead to fatigue and tissue damage."
                },
                {
                    question: "What are the main types of site hazards?",
                    answer: "Site hazards include physical hazards (restricted spaces, moving equipment, electrical hazards, temperature extremes) and atmospheric hazards (combustible gases, oxygen deficiency/excess, toxic fumes like CO). Confined spaces require special resources and certification."
                },
                {
                    question: "What is the proper ladder positioning ratio?",
                    answer: "Ladders should be positioned using a 3:1 ratio - set the ladder 1 foot out from the wall for every 3 feet of height. The top rails should extend at least 3 feet above the landing point, and maintain 3-point contact when climbing."
                },
                {
                    question: "What are lockout procedures?",
                    answer: "Lockout procedures use locks and safety tags to ensure all sources of hazardous energy (electrical, pneumatic, hydraulic, gravitational) are isolated during work. Each worker must use their own lock and key, and never remove someone else's lock."
                },
                {
                    question: "What should you do in an emergency situation?",
                    answer: "In emergency situations, locate and hit the panic button or emergency shutdown system. Don't waste time hunting for the 'correct' switch. Know the location of first aid stations, emergency exits, and your workplace Emergency Response Plan."
                }
            ],
            safetyTerms: {
                "Confined space": "Work area where location, design, or construction restricts entry and exit and where equipment, operations, or atmospheres may pose hazards to health and safety",
                "Group safety equipment": "Equipment such as fire extinguishers and first aid kits supplied by the employer and positioned around the job site",
                "Lockout procedures": "Procedures using locks and safety tags to ensure isolation and lock off of all sources of potential energy during work on a system",
                "MSD hazards": "Musculoskeletal disorder hazards - aspects of the job that increase risk of developing MSD. Primary hazards are force, posture, and repetition",
                "PPE": "Personal Protective Equipment - standard safety clothing and equipment required for protection",
                "Ventilation equipment": "Equipment designed for removal of harmful dust or fumes from workshops"
            }
        };

        // Cache Module 1 data immediately
        moduleDataCache['1'] = module1SafetyData;

        // Placeholder for additional modules (to be added as embedded content)
        // Module 2: Tools - Content to be added
        // Module 3: Properties and Safe Handling of Fuel Gases - Content to be added  
        // Module 4: Codes and Standards - Content to be added
        // Module 5: Electrical Fundamentals - Content to be added
        // Module 6: Technical Drawings, Manuals and Graphs - Content to be added
        // Module 7: Customer Relations - Content to be added
        // Module 8: Introduction to Piping and Tubing Systems - Content to be added
        // Module 9: Introduction to Gas Appliances - Content to be added

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            console.log('G3 AI Tutor - Modular Version Initialized');
        });

        function initializeEventListeners() {
            document.getElementById('moduleSelect').addEventListener('change', handleModuleChange);
            document.getElementById('chapterSelect').addEventListener('change', handleChapterChange);
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            document.getElementById('chatInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }

        // Load module data (all modules are now embedded)
        async function loadModuleData(moduleId) {
            if (moduleDataCache[moduleId]) {
                return moduleDataCache[moduleId];
            }

            // Check if module content is available
            const moduleNames = {
                '1': 'Safety',
                '2': 'Tools',
                '3': 'Properties and Safe Handling of Fuel Gases',
                '4': 'Codes and Standards', 
                '5': 'Electrical Fundamentals',
                '6': 'Technical Drawings, Manuals and Graphs',
                '7': 'Customer Relations',
                '8': 'Introduction to Piping and Tubing Systems',
                '9': 'Introduction to Gas Appliances'
            };

            // For modules not yet added, show placeholder message
            if (!moduleDataCache[moduleId]) {
                const moduleName = moduleNames[moduleId] || `Module ${moduleId}`;
                addMessage('ai', `ðŸ“š **Module ${moduleId}: ${moduleName}**\n\nContent for this module is being prepared and will be available soon.\n\nCurrently available:\nâ€¢ **Module 1: Safety** - Complete with 8 comprehensive chapters\n\nPlease select Module 1 to access the full safety resources content, or check back later for additional modules.`);
                return null;
            }

            return moduleDataCache[moduleId];
        }


        // Handle module selection
        async function handleModuleChange() {
            const moduleId = document.getElementById('moduleSelect').value;
            currentModule = moduleId;
            currentChapter = null;

            if (!moduleId) {
                document.getElementById('chapterSelector').style.display = 'none';
                updateContextInfo();
                updateChatTitle();
                return;
            }

            showTypingIndicator();
            
            const moduleData = await loadModuleData(moduleId);
            if (moduleData) {
                updateChapterSelector(moduleData);
                updateContextInfo();
                updateChatTitle();
                
                // Display module overview
                displayModuleOverview(moduleData);
            }
            
            hideTypingIndicator();
        }

        // Handle chapter selection
        async function handleChapterChange() {
            const chapterId = document.getElementById('chapterSelect').value;
            currentChapter = chapterId;
            updateContextInfo();

            if (chapterId && currentModule) {
                const moduleData = moduleDataCache[currentModule];
                if (moduleData) {
                    await displayChapterContent(moduleData, chapterId);
                }
            }
        }

        // Update chapter selector
        function updateChapterSelector(moduleData) {
            const chapterSelector = document.getElementById('chapterSelector');
            const chapterSelect = document.getElementById('chapterSelect');
            
            chapterSelect.innerHTML = '<option value="">All Chapters</option>';
            
            if (moduleData.chapters) {
                Object.entries(moduleData.chapters).forEach(([chapterId, chapter]) => {
                    const option = document.createElement('option');
                    option.value = chapterId;
                    option.textContent = chapter.title;
                    chapterSelect.appendChild(option);
                });
            }
            
            chapterSelector.style.display = 'block';
        }

        // Display module overview
        async function displayModuleOverview(moduleData) {
            let content = `# ${moduleData.title}\n\n`;
            content += `**Description:** ${moduleData.description}\n\n`;
            
            if (moduleData.chapters) {
                content += `## Available Chapters:\n\n`;
                Object.entries(moduleData.chapters).forEach(([chapterId, chapter]) => {
                    content += `**Chapter ${chapterId}:** ${chapter.title}\n`;
                    if (chapter.content && chapter.content.overview) {
                        content += `*${chapter.content.overview}*\n\n`;
                    }
                });
            }
            
            content += `\n---\n\nðŸ’¡ **Select a specific chapter to view its complete content and ask detailed questions about any topic!**`;
            
            await new Promise(resolve => setTimeout(resolve, 500));
            addMessage('ai', content);
        }

        // Display full chapter content
        async function displayChapterContent(moduleData, chapterId) {
            showTypingIndicator();
            
            const chapter = moduleData.chapters[chapterId];
            if (!chapter || !chapter.content) {
                hideTypingIndicator();
                addMessage('ai', "Sorry, I couldn't find the content for this chapter.");
                return;
            }

            let content = `# ${chapter.title}\n\n`;
            content += `**Module:** ${moduleData.title}\n\n`;
            
            if (chapter.content.overview) {
                content += `## Overview\n${chapter.content.overview}\n\n`;
            }

            // Display all content sections
            Object.entries(chapter.content).forEach(([key, value]) => {
                if (key === 'overview') return; // Already displayed

                const sectionTitle = key.replace(/([A-Z])/g, ' $1')
                    .replace(/^./, str => str.toUpperCase()).trim();
                
                content += `## ${sectionTitle}\n\n`;
                
                if (Array.isArray(value)) {
                    value.forEach(item => {
                        content += `â€¢ ${item}\n`;
                    });
                } else if (typeof value === 'object') {
                    Object.entries(value).forEach(([subKey, subValue]) => {
                        const subTitle = subKey.replace(/([A-Z])/g, ' $1')
                            .replace(/^./, str => str.toUpperCase()).trim();
                        content += `### ${subTitle}\n`;
                        if (Array.isArray(subValue)) {
                            subValue.forEach(item => {
                                content += `â€¢ ${item}\n`;
                            });
                        } else {
                            content += `${subValue}\n`;
                        }
                        content += '\n';
                    });
                } else {
                    content += `${value}\n`;
                }
                content += '\n';
            });

            // Add common questions if available
            if (moduleData.commonQuestions) {
                const relevantQuestions = moduleData.commonQuestions.filter(qa => 
                    qa.question.toLowerCase().includes(chapter.title.toLowerCase().split(' ')[0]) ||
                    Object.values(chapter.content).some(section => 
                        JSON.stringify(section).toLowerCase().includes(qa.question.toLowerCase().split(' ')[0])
                    )
                );
                
                if (relevantQuestions.length > 0) {
                    content += `## Related Questions\n\n`;
                    relevantQuestions.forEach(qa => {
                        content += `**Q: ${qa.question}**\n\n${qa.answer}\n\n`;
                    });
                }
            }
            
            content += `\n---\n\nðŸ’¡ **Ask me to elaborate on any section, explain concepts in more detail, or provide practical examples!**`;
            
            await new Promise(resolve => setTimeout(resolve, 800));
            hideTypingIndicator();
            addMessage('ai', content);
        }

        // Send message
        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            showTypingIndicator();
            
            try {
                const response = await getAIResponse(message);
                hideTypingIndicator();
                addMessage('ai', response);
            } catch (error) {
                hideTypingIndicator();
                addMessage('ai', "I'm having trouble processing your request. Please try again.");
                console.error('Error:', error);
            }
        };

        // Get AI response
        async function getAIResponse(userMessage) {
            await new Promise(resolve => setTimeout(resolve, 1200));
            
            if (!currentModule) {
                return "Please select a module first so I can provide you with specific information about that topic.";
            }

            const moduleData = moduleDataCache[currentModule];
            if (!moduleData) {
                return "I'm still loading the module data. Please wait a moment and try again.";
            }

            const lowerMessage = userMessage.toLowerCase();
            
            // Check for elaboration requests
            if (isElaborationRequest(lowerMessage)) {
                return await handleElaborationRequest(moduleData, lowerMessage, userMessage);
            }

            // Search in common questions
            if (moduleData.commonQuestions) {
                const matchingQA = moduleData.commonQuestions.find(qa =>
                    lowerMessage.includes(qa.question.toLowerCase().slice(0, 20)) ||
                    qa.question.toLowerCase().includes(lowerMessage.slice(0, 15))
                );
                
                if (matchingQA) {
                    return `**${matchingQA.question}**\n\n${matchingQA.answer}\n\n---\n\nðŸ’¡ *Need more details about this topic? Just ask me to elaborate!*`;
                }
            }

            // Search chapter content
            if (currentChapter && moduleData.chapters[currentChapter]) {
                const response = searchChapterContent(moduleData, moduleData.chapters[currentChapter], lowerMessage, userMessage);
                if (response) return response;
            }

            // Search all chapters
            for (const chapter of Object.values(moduleData.chapters)) {
                const response = searchChapterContent(moduleData, chapter, lowerMessage, userMessage);
                if (response) return response;
            }

            return `I understand you're asking about "${userMessage}". Could you be more specific or select a chapter to focus on? I can provide detailed explanations about any topic in ${moduleData.title}.`;
        }

        // Check for elaboration requests
        function isElaborationRequest(message) {
            const elaborationKeywords = [
                'elaborate', 'explain more', 'tell me more', 'more detail', 'expand on',
                'break down', 'examples', 'how does', 'why does', 'clarify', 'simplify'
            ];
            return elaborationKeywords.some(keyword => message.includes(keyword));
        }

        // Handle elaboration requests
        async function handleElaborationRequest(moduleData, lowerMessage, originalMessage) {
            if (!currentChapter) {
                return "I'd be happy to elaborate! Please select a specific chapter first, and I'll provide detailed explanations of any topic within that chapter.";
            }

            const chapter = moduleData.chapters[currentChapter];
            const searchTerms = extractSearchTerms(lowerMessage);
            let bestMatch = null;
            let matchScore = 0;

            // Search through chapter content
            Object.entries(chapter.content).forEach(([sectionKey, sectionValue]) => {
                if (sectionKey === 'overview') return;
                
                const sectionText = JSON.stringify(sectionValue).toLowerCase();
                const score = searchTerms.reduce((acc, term) => {
                    return acc + (sectionText.includes(term) ? 1 : 0);
                }, 0);
                
                if (score > matchScore) {
                    matchScore = score;
                    bestMatch = { key: sectionKey, value: sectionValue, score };
                }
            });

            if (bestMatch && bestMatch.score > 0) {
                return generateDetailedElaboration(moduleData, chapter, bestMatch.key, bestMatch.value);
            }

            return `I can provide detailed explanations about any section in "${chapter.title}". Try asking about specific topics from the chapter, such as the main concepts or procedures mentioned.`;
        }

        // Generate detailed elaboration
        function generateDetailedElaboration(moduleData, chapter, sectionKey, sectionValue) {
            const sectionTitle = sectionKey.replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase()).trim();
            
            let response = `## Detailed Explanation: ${sectionTitle}\n\n`;
            response += `**From:** ${chapter.title} (${moduleData.title})\n\n`;

            if (Array.isArray(sectionValue)) {
                response += `This section covers ${sectionValue.length} key points:\n\n`;
                
                sectionValue.forEach((item, index) => {
                    response += `### ${index + 1}. ${item}\n\n`;
                    response += generatePracticalExplanation(item, moduleData.title) + '\n\n';
                });
                
            } else if (typeof sectionValue === 'object') {
                response += `This section includes several important categories:\n\n`;
                
                Object.entries(sectionValue).forEach(([subKey, subValue]) => {
                    const subTitle = subKey.replace(/([A-Z])/g, ' $1')
                        .replace(/^./, str => str.toUpperCase()).trim();
                    response += `### ${subTitle}\n\n`;
                    
                    if (Array.isArray(subValue)) {
                        subValue.forEach(item => {
                            response += `â€¢ **${item}**\n`;
                            response += `  ${generatePracticalExplanation(item, moduleData.title)}\n\n`;
                        });
                    } else {
                        response += `${subValue}\n\n`;
                    }
                });
            } else {
                response += sectionValue + '\n\n';
                response += generatePracticalExplanation(sectionValue, moduleData.title) + '\n\n';
            }

            response += `---\n\nðŸ’¡ *Need even more specific details? Just ask!*`;
            return response;
        }

        // Generate practical explanations
        function generatePracticalExplanation(item, moduleTitle) {
            if (moduleTitle.includes('Customer Relations')) {
                if (item.includes('listening')) {
                    return `This means giving your full attention to the customer, asking clarifying questions, and confirming understanding. For example, if a customer says "the heat isn't working," ask "Is there no heat at all, or is it not heating enough?" to get specific details.`;
                }
                if (item.includes('professional')) {
                    return `Professional behavior includes punctuality, clean appearance, clear communication, and respectful treatment of property. Always explain what you're doing and why.`;
                }
                if (item.includes('conflict')) {
                    return `When conflicts arise, remain calm, listen to concerns, acknowledge feelings, and focus on solutions. Never argue with customers - instead, seek to understand their perspective.`;
                }
            }
            
            return `This is an important concept that requires proper understanding and practical application in real-world gas technician work.`;
        }

        // Search chapter content
        function searchChapterContent(moduleData, chapter, lowerMessage, originalMessage) {
            const content = chapter.content;
            if (!content) return null;

            // Search for content matches
            for (const [key, value] of Object.entries(content)) {
                if (typeof value === 'string' && value.toLowerCase().includes(lowerMessage.slice(0, 15))) {
                    return `**${chapter.title} - ${key}**\n\n${value}\n\n---\n\nðŸ’¡ *Ask me to elaborate on this topic for more details!*`;
                }
                
                if (Array.isArray(value)) {
                    const matchingItem = value.find(item => 
                        item.toLowerCase().includes(lowerMessage.slice(0, 10)) ||
                        lowerMessage.includes(item.toLowerCase().slice(0, 10))
                    );
                    
                    if (matchingItem) {
                        let response = `**${chapter.title}**\n\n`;
                        response += `Found in **${key.replace(/([A-Z])/g, ' $1').trim()}**:\n\n`;
                        response += `â€¢ ${matchingItem}\n\n`;
                        response += generatePracticalExplanation(matchingItem, moduleData.title);
                        response += `\n\n---\n\nðŸ’¡ *Want more details about this or related topics? Just ask!*`;
                        return response;
                    }
                }
            }

            return null;
        }

        // Extract search terms
        function extractSearchTerms(message) {
            const stopWords = ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'];
            return message.toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(' ')
                .filter(word => word.length > 2 && !stopWords.includes(word));
        }

        // UI Helper functions
        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Clear loading message if exists
            const loadingMessage = messagesContainer.querySelector('.loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (sender === 'ai') {
                // Convert markdown-like formatting to HTML
                const formattedContent = content
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^\* (.*$)/gm, 'â€¢ $1')
                    .replace(/^â€¢ (.*$)/gm, 'â€¢ $1')
                    .replace(/\n/g, '<br>');
                    
                contentDiv.innerHTML = formattedContent;
            } else {
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function updateContextInfo() {
            const contextInfo = document.getElementById('contextInfo');
            
            if (currentModule && currentChapter) {
                const moduleData = moduleDataCache[currentModule];
                if (moduleData && moduleData.chapters && moduleData.chapters[currentChapter]) {
                    const chapter = moduleData.chapters[currentChapter];
                    contextInfo.textContent = `${moduleData.title} - ${chapter.title}`;
                } else {
                    contextInfo.textContent = 'Loading chapter...';
                }
            } else if (currentModule) {
                const moduleData = moduleDataCache[currentModule];
                if (moduleData) {
                    contextInfo.textContent = `${moduleData.title} - All Chapters`;
                } else {
                    contextInfo.textContent = 'Loading module...';
                }
            } else {
                contextInfo.textContent = 'Select a module to begin learning';
            }
        }

        function updateChatTitle() {
            const chatTitle = document.getElementById('chatTitle');
            
            if (currentModule) {
                const moduleData = moduleDataCache[currentModule];
                if (moduleData) {
                    chatTitle.textContent = `AI Tutor - ${moduleData.title}`;
                } else {
                    chatTitle.textContent = 'AI Tutor - Loading...';
                }
            } else {
                chatTitle.textContent = 'AI Tutor Chat';
            }
        }
    </script>
</body>
</html>