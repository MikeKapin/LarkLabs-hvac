<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSSA G3 AI Tutor - CSA Gas Technician Modules 1-9</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 10px;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #fff;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .logo p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .module-selector {
            margin-bottom: 20px;
        }

        .module-selector label {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }

        .module-select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .module-select option {
            background: #333;
            color: #fff;
        }

        .quick-topics {
            flex: 1;
            overflow-y: auto;
        }

        .quick-topics h3 {
            color: #fff;
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .topic-btn {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.98);
            font-size: 13px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .topic-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
            color: #fff;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-header h2 {
            color: #fff;
            font-size: 20px;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            text-align: right;
        }

        .message.ai {
            text-align: left;
        }

        .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 20%;
        }

        .message.ai .message-bubble {
            background: #fff;
            color: #333;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-right: 20%;
        }

        .message-time {
            font-size: 11px;
            color: #495057;
            margin-top: 5px;
        }

        .typing-indicator {
            display: none;
            text-align: left;
            margin-bottom: 20px;
        }

        .typing-indicator .message-bubble {
            background: #fff;
            border: 1px solid #e9ecef;
            padding: 15px 20px;
            margin-right: 20%;
        }

        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #495057;
            animation: typing 1.4s infinite;
        }

        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #fff;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 50px;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s ease;
            white-space: nowrap;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #495057;
        }

        .welcome-message h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .welcome-message p {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .example-questions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .example-btn {
            padding: 15px 20px;
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }

        .example-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                margin: 5px;
                border-radius: 15px;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
                overflow-y: auto;
                padding: 15px;
            }

            .chat-area {
                height: calc(100vh - 220px);
            }

            .message-bubble {
                max-width: 90%;
            }

            .example-questions {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>G3 AI Tutor</h1>
                <p>CSA Gas Technician Modules 1-9</p>
            </div>

            <div class="module-selector">
                <label for="moduleSelect">Select Module:</label>
                <select id="moduleSelect" class="module-select">
                    <option value="">All Modules</option>
                    <option value="1">Module 1: Safety</option>
                    <option value="2">Module 2: Fasteners, Tools and Test Equipment</option>
                    <option value="3">Module 3: Properties and Safe Handling of Fuel Gases</option>
                    <option value="4">Module 4: Gas Industry Codes, Acts and Regulations</option>
                    <option value="5">Module 5: Basic Electricity</option>
                    <option value="6">Module 6: Technical Drawings, Manuals and Graphs</option>
                    <option value="7">Module 7: Customer Relations</option>
                    <option value="8">Module 8: Introduction to Piping and Tubing Systems</option>
                    <option value="9">Module 9: Introduction to Gas Appliances</option>
                </select>
            </div>

            <div class="quick-topics">
                <h3>Quick Topics</h3>
                <div id="topicButtons">
                    <button class="topic-btn" onclick="askQuestion('What PPE is required for gas technicians?')">PPE Requirements</button>
                    <button class="topic-btn" onclick="askQuestion('How do I perform a proper leak test?')">Leak Testing</button>
                    <button class="topic-btn" onclick="askQuestion('What are the primary hazards in gas work?')">Gas Hazards</button>
                    <button class="topic-btn" onclick="askQuestion('What is NPT thread?')">NPT Threads</button>
                    <button class="topic-btn" onclick="askQuestion('What is natural gas heating value?')">Heating Values</button>
                    <button class="topic-btn" onclick="askQuestion('What is CSA B149.1?')">CSA Codes</button>
                    <button class="topic-btn" onclick="askQuestion('What is Ohm\\'s Law?')">Ohm's Law</button>
                    <button class="topic-btn" onclick="askQuestion('How do you read gas piping schematics?')">Schematics</button>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <h2>AI Tutor Chat</h2>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message">
                    <h3>Welcome to your G3 AI Tutor! 🔧</h3>
                    <p>I'm here to help you master CSA Gas Technician Modules 1-9 for your TSSA G3 certification.</p>
                    <p>Ask me about safety procedures, tools, gas properties, codes, electricity, and more!</p>
                    
                    <div class="example-questions">
                        <div class="example-btn" onclick="askQuestion('What safety precautions should I take when working with gas?')">
                            <strong>Safety First</strong><br>
                            What safety precautions should I take when working with gas?
                        </div>
                        <div class="example-btn" onclick="askQuestion('What tools are essential for gas work?')">
                            <strong>Essential Tools</strong><br>
                            What tools are essential for gas work?
                        </div>
                        <div class="example-btn" onclick="askQuestion('What are the key CSA B149.1 requirements?')">
                            <strong>Code Knowledge</strong><br>
                            What are the key CSA B149.1 requirements?
                        </div>
                        <div class="example-btn" onclick="askQuestion('Explain natural gas properties and composition')">
                            <strong>Gas Properties</strong><br>
                            Explain natural gas properties and composition
                        </div>
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="message-bubble">
                    <div class="typing-dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <span style="margin-left: 10px; color: #495057;">AI Tutor is thinking...</span>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-group">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="Ask me anything about CSA Gas Technician modules..."
                        rows="1"
                    ></textarea>
                    <button id="sendBtn" class="send-btn" onclick="sendMessage()">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import actual module data from your files
        // In a real implementation, you would uncomment and use these imports:
        /*
        import { module1SafetyData } from './module1-safety.js';
        import { module2ToolsData } from './module2-tools.js';
        import { module3GasPropertiesData } from './module3-gas-properties.js';
        import { module4CodesData } from './module4-codes.js';
        import { module5ElectricityData } from './module5-electricity.js';
        import { module6TechnicalDrawingsData } from './module6-technical-drawings.js';
        import { module7CustomerRelationsData } from './module7-customer-relations.js';
        import { module8PipingSystemsData } from './module8-piping-systems.js';
        import { module9GasAppliancesData } from './module9-gas-appliances.js';
        */

        // Simulate your actual module data structure for demo
        const realModuleData = {
            1: {
                moduleId: 1,
                title: "Safety",
                description: "Fundamental safety principles and procedures for gas technicians",
                chapters: {
                    1: {
                        title: "Safety Fundamentals - Chapter 1",
                        content: {
                            overview: "Introduction to gas safety principles and hazard recognition",
                            keyTopics: [
                                "Personal Protective Equipment (PPE)",
                                "Hazard identification and assessment",
                                "Emergency procedures and protocols",
                                "Safety regulations and standards",
                                "Workplace safety culture and responsibility"
                            ],
                            learningObjectives: [
                                "Identify potential hazards in gas work environments",
                                "Select and use appropriate PPE for different tasks",
                                "Implement emergency response procedures",
                                "Apply safety regulations and best practices"
                            ],
                            safetyPrinciples: [
                                "Always assume gas is present until proven otherwise",
                                "Use proper gas detection equipment",
                                "Maintain situational awareness at all times",
                                "Follow lock-out/tag-out procedures",
                                "Communicate hazards to team members"
                            ]
                        }
                    },
                    2: {
                        title: "Gas Safety Hazards - Chapter 2",
                        content: {
                            overview: "Understanding specific hazards associated with gas work",
                            primaryHazards: [
                                "Combustible gas accumulation",
                                "Asphyxiation from oxygen displacement",
                                "Fire and explosion risks",
                                "Toxic gas exposure",
                                "Electrical hazards in gas environments"
                            ],
                            riskAssessment: [
                                "Environmental hazard evaluation",
                                "Equipment condition assessment",
                                "Weather and atmospheric conditions",
                                "Site-specific risk factors",
                                "Personal health and fitness considerations"
                            ]
                        }
                    },
                    3: {
                        title: "Personal Protective Equipment - Chapter 3",
                        content: {
                            overview: "Selection, use, and maintenance of PPE for gas technicians",
                            basicPPE: [
                                "ANSI-approved safety glasses or goggles",
                                "CSA-approved safety footwear",
                                "Cut-resistant work gloves",
                                "High-visibility clothing when required",
                                "Hard hats in construction environments"
                            ],
                            specializedEquipment: [
                                "Combustible gas detectors (LEL meters)",
                                "Oxygen deficiency monitors",
                                "Personal gas monitors",
                                "Emergency escape respirators",
                                "Fall protection equipment"
                            ]
                        }
                    }
                }
            },
            2: {
                moduleId: 2,
                title: "Fasteners, Tools and Test Equipment",
                description: "Essential tools, fasteners, and testing equipment for gas work",
                chapters: {
                    1: {
                        title: "Hand Tools and Basic Equipment - Chapter 1",
                        content: {
                            overview: "Basic hand tools and equipment used in gas system work",
                            essentialTools: [
                                "Pipe wrenches (various sizes)",
                                "Adjustable wrenches",
                                "Channel lock pliers",
                                "Screwdrivers (flathead and Phillips)",
                                "Hex key sets (metric and imperial)"
                            ],
                            specializedTools: [
                                "Pipe threading tools",
                                "Tube benders and cutters",
                                "Flaring tools",
                                "Pipe cutting tools",
                                "Deburring tools"
                            ]
                        }
                    },
                    2: {
                        title: "Fasteners and Joining Methods - Chapter 2",
                        content: {
                            overview: "Types of fasteners and joining methods for gas systems",
                            threadedFasteners: [
                                "NPT (National Pipe Thread) - tapered threads",
                                "BSP (British Standard Pipe) threads",
                                "Metric threads for specific applications",
                                "Thread sealants and compounds",
                                "Torque specifications and requirements"
                            ]
                        }
                    }
                }
            },
            3: {
                moduleId: 3,
                title: "Properties and Safe Handling of Fuel Gases",
                description: "Understanding fuel gas properties and safe handling procedures",
                chapters: {
                    1: {
                        title: "Natural Gas Properties - Chapter 1",
                        content: {
                            overview: "Physical and chemical properties of natural gas",
                            physicalProperties: [
                                "Specific gravity: 0.60 (lighter than air)",
                                "Heating value: ~1000 BTU/ft³ (37 MJ/m³)",
                                "Ignition temperature: ~1000°F (540°C)",
                                "Flammable range: 5-15% by volume in air",
                                "Odorless in pure form (mercaptan added for detection)"
                            ],
                            chemicalComposition: [
                                "Methane (CH₄): 85-95% typical",
                                "Ethane (C₂H₆): 3-8%",
                                "Propane (C₃H₈): 1-3%",
                                "Butane (C₄H₁₀): <1%",
                                "Nitrogen (N₂): 1-5%",
                                "Carbon dioxide (CO₂): <3%"
                            ]
                        }
                    }
                }
            },
            4: {
                moduleId: 4,
                title: "Gas Industry Codes, Acts and Regulations",
                description: "Gas industry codes, acts, and regulatory requirements",
                chapters: {
                    1: {
                        title: "Introduction to Gas Codes - Chapter 1",
                        content: {
                            overview: "Introduction to gas industry codes and standards",
                            primaryCodes: [
                                "CSA B149.1 - Natural gas and propane installation code",
                                "CSA B149.2 - Propane storage and handling code",
                                "CSA B149.3 - Propane and natural gas for vehicles",
                                "NFPA 54/ANSI Z223.1 - National Fuel Gas Code (US)",
                                "Local codes and amendments"
                            ],
                            codeHierarchy: [
                                "National codes establish minimum standards",
                                "Provincial regulations may be more restrictive",
                                "Municipal bylaws add local requirements",
                                "Most restrictive code always applies",
                                "Manufacturer requirements must also be met"
                            ]
                        }
                    }
                }
            }
        };

        // Global variables
        let chatHistory = [];

        window.askQuestion = function(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            showTypingIndicator();
            
            try {
                // Get AI response using real module data
                const response = await getAIResponseFromRealData(message);
                hideTypingIndicator();
                addMessage('ai', response);
            } catch (error) {
                hideTypingIndicator();
                addMessage('ai', "I'm sorry, I'm having trouble connecting right now. Please try again in a moment.");
                console.error('Error:', error);
            }
        }

        // Enhanced AI response system using real module data with detailed explanations
        async function getAIResponseFromRealData(userMessage) {
            await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate processing time
            
            const selectedModule = document.getElementById('moduleSelect').value;
            const lowerMessage = userMessage.toLowerCase();
            
            // Search through actual module data
            if (selectedModule && realModuleData[selectedModule]) {
                const moduleData = realModuleData[selectedModule];
                
                // Search through chapters for relevant content
                for (const chapter of Object.values(moduleData.chapters)) {
                    const content = chapter.content;
                    
                    // Check for PPE-related questions
                    if ((lowerMessage.includes('ppe') || lowerMessage.includes('personal protective')) && content.basicPPE) {
                        return `**${moduleData.title} - Personal Protective Equipment Explained**\n\n🛡️ **Think of PPE as your personal armor against gas hazards!**\n\n**Essential PPE for Gas Technicians:**\n${content.basicPPE.map(item => `• **${item}**`).join('\n')}\n\n**Let me explain why each piece is critical:**\n\n👓 **Safety Glasses/Goggles:** Protect your eyes from debris when cutting pipes or chemical splashes from sealants. **Example:** When threading pipe, metal shavings can fly into your eyes.\n\n👢 **CSA-Approved Safety Footwear:** Steel toes protect against dropped tools and pipes. Slip-resistant soles prevent falls on wet surfaces. **Real scenario:** A 20-lb pipe wrench dropped from waist height can break toes without proper footwear.\n\n🧤 **Cut-Resistant Gloves:** Gas work involves sharp edges on pipes and tools. **Example:** When handling freshly cut steel pipe, the edges are razor-sharp and can cause deep cuts.\n\n🦺 **High-Visibility Clothing:** Required when working near traffic or heavy equipment. Makes you visible from 500+ feet away.\n\n⛑️ **Hard Hats:** Protect against overhead hazards in construction zones.\n\n${content.specializedEquipment ? `**🔍 Specialized Detection Equipment:**\n${content.specializedEquipment.map(item => `• **${item}**`).join('\n')}\n\n**Why Detection Equipment is Critical:**\n\n📟 **Gas Detectors:** Like having a "canary in a coal mine" - they warn you of invisible dangers. Natural gas is odorless (mercaptan is added), but detectors can find leaks before you smell them.\n\n💨 **Oxygen Monitors:** In confined spaces, heavy gases can displace oxygen. **Real danger:** You could pass out before realizing there's not enough oxygen to breathe.\n\n` : ''}**🚨 Daily PPE Inspection Checklist:**\n1. **Visual Check:** Look for cracks, tears, or damage\n2. **Function Test:** Ensure gas detectors beep and calibrate properly\n3. **Fit Check:** PPE should fit snugly but not restrict movement\n4. **Cleanliness:** Clean equipment works better and lasts longer\n\n**💡 Pro Tips:**\n• Replace PPE immediately if damaged - your life depends on it\n• Keep spare batteries for gas detectors\n• Store PPE properly to prevent damage\n\n📚 **From:** ${chapter.title}\n\n**What would you like to know next?** Ask me about specific PPE maintenance, when to use what equipment, or how to properly fit different types of protection!`;
                    }
                    
                    // Check for hazard-related questions
                    if ((lowerMessage.includes('hazard') || lowerMessage.includes('risk')) && content.primaryHazards) {
                        return `**${moduleData.title} - Understanding Gas Work Hazards**\n\n⚠️ **Gas work is like handling invisible dangers - you can't see them, but they're real!**\n\n**Primary Hazards Explained:**\n\n${content.primaryHazards.map(hazard => {
                            if (hazard.includes('Combustible gas')) {
                                return `🔥 **${hazard}:** Gas can build up in low areas or enclosed spaces. **Think of it like:** Filling a invisible bucket with explosive material. **Real example:** Gas leaking into a basement can reach explosive levels (5-15% concentration) and ignite from a pilot light.`;
                            } else if (hazard.includes('Asphyxiation')) {
                                return `😵 **${hazard}:** Heavy gases push oxygen away. **Simple explanation:** Like being underwater - you can't breathe what isn't there. **Real scenario:** In manholes or confined spaces, gases can create "dead air" zones where you'll pass out in seconds.`;
                            } else if (hazard.includes('Fire and explosion')) {
                                return `💥 **${hazard}:** Gas + air + ignition source = BOOM! **Analogy:** Like mixing gasoline vapor with a match. **Real danger:** Even tiny sparks from tools or static electricity can ignite gas clouds.`;
                            } else if (hazard.includes('Toxic gas')) {
                                return `☠️ **${hazard}:** Some gases are poisonous, not just explosive. **Example:** Carbon monoxide from incomplete combustion - you can't smell it, see it, or taste it, but it kills.`;
                            } else if (hazard.includes('Electrical')) {
                                return `⚡ **${hazard}:** Gas and electricity don't mix! **Why dangerous:** Sparks can ignite gas, and gas can make electrical equipment fail. **Real situation:** Using non-intrinsically safe electrical tools in gas areas.`;
                            }
                            return `• **${hazard}**`;
                        }).join('\n\n')}\n\n${content.riskAssessment ? `**🔍 Before You Start - Risk Assessment Like a Detective:**\n\n${content.riskAssessment.map(item => {
                            if (item.includes('Environmental')) {
                                return `🌍 **${item}:** Check weather, confined spaces, ventilation. **Ask yourself:** "Where could gas accumulate here?"`;
                            } else if (item.includes('Equipment')) {
                                return `🔧 **${item}:** Are your tools gas-safe? Is PPE working properly? **Remember:** Faulty equipment kills.`;
                            } else if (item.includes('Weather')) {
                                return `🌨️ **${item}:** Wind affects gas dispersion, rain affects equipment. **Example:** No wind = gas doesn't blow away.`;
                            } else if (item.includes('Site-specific')) {
                                return `📍 **${item}:** Every site is different. **Look for:** Underground utilities, nearby ignition sources, escape routes.`;
                            } else if (item.includes('Personal health')) {
                                return `🏃 **${item}:** Are you alert? Tired workers make mistakes. **Be honest:** If you're not 100%, don't do gas work.`;
                            }
                            return `• ${item}`;
                        }).join('\n')}\n\n` : ''}**🚨 The "STOP and THINK" Method:**\n1. **S**can the area for hazards\n2. **T**est the atmosphere with gas detectors\n3. **O**rganize your safety equipment\n4. **P**lan your escape route\n\n**💡 Remember the Gas Worker's Golden Rule:**\n"If you're not sure it's safe, it's not safe. Period."\n\n📚 **From:** ${chapter.title}\n\n**Want to dig deeper?** Ask me about specific hazards, how to test for them, or what to do if you encounter them on the job!`;
                    }
                    
                    // Check for safety principles
                    if (lowerMessage.includes('safety') && content.safetyPrinciples) {
                        return `**${moduleData.title} - Safety Principles**\n\n**Fundamental Safety Principles:**\n${content.safetyPrinciples.map(principle => `• ${principle}`).join('\n')}\n\n${content.learningObjectives ? `**Learning Objectives:**\n${content.learningObjectives.map(obj => `• ${obj}`).join('\n')}\n\n` : ''}**Remember:** These principles form the foundation of safe gas work practices.\n\n📚 **From:** ${chapter.title}\n\nWhat specific safety procedure would you like to discuss?`;
                    }
                    
                    // Check for tools questions
                    if (lowerMessage.includes('tool') && content.essentialTools) {
                        return `**${moduleData.title} - Your Gas Technician Toolbox Explained**\n\n🧰 **Think of your tools as extensions of your hands - each one has a specific job!**\n\n**Essential Hand Tools & Why You Need Them:**\n\n${content.essentialTools.map(tool => {
                            if (tool.includes('Pipe wrenches')) {
                                return `🔧 **${tool}:** The workhorses of gas work. **Why different sizes?** Small pipes need small wrenches, big pipes need big wrenches. **Pro tip:** Use two wrenches - one to hold, one to turn. **Real example:** When connecting a 1/2" gas line, you'd use an 8" wrench to hold the fitting and a 10" wrench to tighten the pipe.`;
                            } else if (tool.includes('Adjustable wrenches')) {
                                return `🔧 **${tool}:** Your "Swiss Army knife" wrench. **Best for:** Fittings, unions, and odd-sized nuts. **Quality matters:** Cheap ones slip and round off corners. **Safety note:** Always pull toward yourself, never push away.`;
                            } else if (tool.includes('Channel lock pliers')) {
                                return `🔧 **${tool}:** Great grip strength for round objects. **Perfect for:** Holding pipes while threading, gripping smooth surfaces. **Technique:** Adjust to fit snugly - too loose and they'll slip and damage the pipe.`;
                            } else if (tool.includes('Screwdrivers')) {
                                return `🪛 **${tool}:** For valve packings, control adjustments, and electrical connections. **Safety:** Use the right size - wrong size screwdrivers slip and can cause injury or damage.`;
                            } else if (tool.includes('Hex key')) {
                                return `🔧 **${tool}:** Modern gas equipment uses hex bolts. **Metric vs Imperial:** Know which system your equipment uses - forcing the wrong size will strip the bolt head.`;
                            }
                            return `🔧 **${tool}**`;
                        }).join('\n\n')}\n\n${content.specializedTools ? `**🛠️ Specialized Tools - The Precision Instruments:**\n\n${content.specializedTools.map(tool => {
                            if (tool.includes('Pipe threading')) {
                                return `🧵 **${tool}:** Creates the threads that make leak-proof connections. **Like:** A metal lathe for pipes. **Critical:** Sharp dies cut clean threads, dull dies create weak, leaky connections. **Real scenario:** Threading a 3/4" pipe requires proper die alignment and cutting oil for clean threads.`;
                            } else if (tool.includes('Tube benders')) {
                                return `↩️ **${tool}:** Bend tubing without kinking. **Why important:** Kinked tubing restricts gas flow and creates pressure problems. **Technique:** Support the tube on both sides of the bend - like bending a straw without pinching it.`;
                            } else if (tool.includes('Flaring tools')) {
                                return `📯 **${tool}:** Create the bell-shaped ends for flare fittings. **Analogy:** Like making a trumpet end on a tube. **Quality check:** Perfect flares are smooth and even - scratches or tool marks cause leaks.`;
                            } else if (tool.includes('Pipe cutting')) {
                                return `✂️ **${tool}:** Clean, square cuts are essential for proper threading. **vs Hacksaw:** Power cutters give perfect 90° cuts; handsaws often create angled cuts that won't thread properly.`;
                            } else if (tool.includes('Deburring')) {
                                return `🪚 **${tool}:** Remove sharp edges and metal fragments. **Why critical:** Burrs can puncture gaskets and create leak paths. **After every cut:** Always deburr inside and outside of the pipe.`;
                            }
                            return `🛠️ **${tool}**`;
                        }).join('\n\n')}\n\n` : ''}**🔍 Daily Tool Inspection - The 5-Point Check:**\n1. **Sharp & Clean:** Cutting tools should be sharp, all tools clean\n2. **Tight & Secure:** No loose handles or moving parts\n3. **Calibrated:** Measuring tools should read accurately\n4. **Complete:** All parts present (dies, handles, etc.)\n5. **Safe Storage:** Tools organized and protected from damage\n\n**💡 Pro Tips from Experienced Technicians:**\n• "Buy quality tools once, rather than cheap tools multiple times"\n• "A sharp tool is a safe tool - dull tools require more force"\n• "Clean tools last longer and work better"\n• "Organization saves time - know where every tool is"\n\n📚 **From:** ${chapter.title}\n\n**Ready to learn more?** Ask me about specific tool techniques, maintenance schedules, or which brands experienced techs recommend!`;
                    }
                    
                    // Check for thread/NPT questions
                    if ((lowerMessage.includes('npt') || lowerMessage.includes('thread')) && content.threadedFasteners) {
                        return `**${moduleData.title} - Thread Systems Made Simple**\n\n🧵 **Imagine threads like spiral staircases - they need to match perfectly to work!**\n\n**Thread Types Explained:**\n\n${content.threadedFasteners.map(thread => {
                            if (thread.includes('NPT')) {
                                return `🏠 **${thread}:** The North American standard. **Key feature:** TAPERED threads that get tighter as you screw them in. **Think of it like:** A cork going into a wine bottle - it seals by wedging tight. **Real example:** When you thread a 1/2" NPT gas cock into a tee, the tapered threads compress and seal without needing a gasket.`;
                            } else if (thread.includes('BSP')) {
                                return `🇬🇧 **${thread}:** British/European standard. **Two types:** Parallel (BSPP) and Tapered (BSPT). **Parallel threads:** Like straight sides on a jar - need gaskets to seal. **Tapered threads:** Work like NPT but different angle.`;
                            } else if (thread.includes('Metric')) {
                                return `🌍 **${thread}:** International standard using millimeter measurements. **Common in:** European equipment and newer appliances. **Key difference:** Measured in mm pitch vs threads per inch.`;
                            } else if (thread.includes('Thread sealants')) {
                                return `🧴 **${thread}:** The "glue" that makes threads gas-tight. **Types:** Pipe dope (paste), Teflon tape, liquid sealants. **Rule:** Use gas-rated sealants only - plumbing sealants can dissolve in gas!`;
                            } else if (thread.includes('Torque')) {
                                return `💪 **${thread}:** How tight is tight enough? **Too loose:** Leaks. **Too tight:** Breaks the fitting or strips threads. **Sweet spot:** Follow manufacturer specs or use the "hand tight plus 2-3 turns" rule for most gas fittings.`;
                            }
                            return `🧵 **${thread}**`;
                        }).join('\n\n')}\n\n**🎯 NPT vs BSP - The Critical Differences:**\n\n| Feature | NPT (North American) | BSP (British/International) |\n|---------|---------------------|---------------------------|\n| **Thread Angle** | 60 degrees | 55 degrees |\n| **Sealing Method** | Tapered wedging | Gasket (parallel) or wedging (tapered) |\n| **Common Sizes** | 1/8", 1/4", 1/2", 3/4" | 6mm, 8mm, 15mm, 20mm |\n| **Where Used** | North America, gas appliances | Europe, some equipment imports |\n\n**⚠️ DANGER: Mixing Thread Types**\n• NPT male into BSP female = **WILL LEAK**\n• Different thread angles = **WEAK CONNECTION**\n• Wrong pitch = **STRIPPED THREADS**\n\n**🔧 Step-by-Step NPT Threading Process:**\n1. **Cut pipe square** - use pipe cutter, not hacksaw\n2. **Deburr inside and outside** - remove all sharp edges\n3. **Apply thread sealant** - 2-3 wraps of Teflon tape or thin layer of pipe dope\n4. **Thread by hand first** - should go 2-3 turns by hand\n5. **Use wrenches** - tighten until hand-tight plus 2-3 more turns\n6. **Test for leaks** - always test with soap solution\n\n**💡 Pro Threading Tips:**\n• "If it doesn't start by hand, don't force it with wrenches"\n• "Clean threads cut better and seal tighter"\n• "When in doubt, back it out and start over"\n• "A good thread feels smooth, a bad thread feels rough"\n\n📚 **From:** ${chapter.title}\n\n**Want to master threading?** Ask me about specific pipe sizes, sealant types, or troubleshooting threading problems!`;
                    }
                    
                    // Check for gas properties
                    if ((lowerMessage.includes('natural gas') || lowerMessage.includes('properties')) && content.physicalProperties) {
                        return `**${moduleData.title} - Natural Gas Properties Explained**\n\n⛽ **Think of natural gas like invisible air with superpowers - it has unique characteristics that make it both useful and potentially dangerous!**\n\n**Physical Properties Broken Down:**\n\n${content.physicalProperties.map(prop => {
                            if (prop.includes('Specific gravity')) {
                                return `⚖️ **${prop}:** **What this means:** Natural gas is lighter than air. **Real-world impact:** Gas leaks rise and accumulate at ceiling level, not floor level like propane. **Safety implication:** Check attics, upper areas, and ceiling pockets for leaks. **Example:** A basement leak will float up through floor cracks to the main floor.`;
                            } else if (prop.includes('Heating value')) {
                                return `🔥 **${prop}:** **In simple terms:** This is how much heat energy you get from burning one cubic foot of gas. **Comparison:** Like saying one gallon of gasoline can move your car 25 miles. **Practical use:** Engineers use this to size burners and calculate gas consumption. **Real example:** A 100,000 BTU furnace needs 100 cubic feet of gas per hour.`;
                            } else if (prop.includes('Ignition temperature')) {
                                return `🌡️ **${prop}:** **What this means:** Gas needs to be heated to 1000°F before it will ignite. **Good news:** This is pretty hot - a cigarette burns at about 1200°F. **Safety note:** Hot exhaust pipes, engines, and welding equipment can easily reach ignition temperature. **Real danger:** Car exhaust pipes run at 1200°F+.`;
                            } else if (prop.includes('Flammable range')) {
                                return `💥 **${prop}:** **The "Goldilocks zone" for explosions!** **Too little gas (under 5%):** Won't burn - not enough fuel. **Too much gas (over 15%):** Won't burn - not enough oxygen. **Just right (5-15%):** BOOM! **Real scenario:** A small leak (2-3%) smells but won't explode. A confined space leak can easily reach 10% and be deadly.`;
                            } else if (prop.includes('Odorless')) {
                                return `👃 **${prop}:** **The invisible danger!** Pure natural gas has no smell. **Solution:** Mercaptan (rotten egg smell) is added. **Detection threshold:** You can smell it at 1% concentration - well below the 5% explosive limit. **Safety margin:** Smell = warning, but still safe. **Emergency rule:** If you smell gas, assume it's getting stronger.`;
                            }
                            return `📊 **${prop}**`;
                        }).join('\n\n')}\n\n${content.chemicalComposition ? `**🧪 What's Actually IN Natural Gas:**\n\n${content.chemicalComposition.map(comp => {
                            if (comp.includes('Methane')) {
                                return `🔬 **${comp}:** The main ingredient! **What it is:** The simplest hydrocarbon (CH₄). **Why it matters:** This is the part that burns and produces heat. **Fun fact:** Methane is what makes gas stoves burn with that blue flame.`;
                            } else if (comp.includes('Ethane')) {
                                return `⚗️ **${comp}:** **Secondary fuel component.** Higher heating value than methane. **Impact:** Makes some natural gas burn hotter than others.`;
                            } else if (comp.includes('Propane')) {
                                return `🧴 **${comp}:** **Yes, the same propane in BBQ tanks!** Small amounts occur naturally in natural gas. **Heating value:** Much higher than methane.`;
                            } else if (comp.includes('Nitrogen')) {
                                return `💨 **${comp}:** **Inert gas - doesn't burn.** **Effect:** Dilutes the gas, slightly reducing heating value. **Source:** Natural geological process.`;
                            } else if (comp.includes('Carbon dioxide')) {
                                return `🌬️ **${comp}:** **Another inert component.** **Effect:** Reduces heating value and can cause corrosion in high concentrations. **Detection:** Makes gas smell slightly sour if present in high amounts.`;
                            }
                            return `🧪 **${comp}**`;
                        }).join('\n\n')}\n\n` : ''}**🎯 Why These Properties Matter for Gas Technicians:**\n\n**For Installation:**\n• **Specific Gravity:** Plan for upward gas movement\n• **Heating Value:** Calculate proper pipe sizes and burner orifices\n• **Flammable Range:** Understand explosion risks\n\n**For Safety:**\n• **Ignition Temp:** Identify heat sources that could ignite gas\n• **Odorization:** Trust your nose, but use detectors too\n• **Composition:** Understand regional variations in gas quality\n\n**🚨 Critical Safety Applications:**\n\n1. **Leak Detection Strategy:** Check high points first (ceiling, upper walls)\n2. **Ventilation Planning:** Natural draft works because gas rises\n3. **Heat Source Management:** Keep anything over 1000°F away from potential leaks\n4. **Emergency Response:** Small leaks smell strong, big leaks might not (odor fade)\n\n**💡 Pro Tips from Field Experience:**\n• "If it smells like gas, it probably is gas - don't ignore it"\n• "Gas rises, but it can get trapped in pockets and recesses"\n• "Different regions have different gas compositions - heating values vary"\n• "Old gas can lose its odor - always use electronic detectors"\n\n📚 **From:** ${chapter.title}\n\n**Ready to dive deeper?** Ask me about specific applications, regional gas variations, or how these properties affect appliance performance!`;
                    }
                    
                    // Check for code questions
                    if ((lowerMessage.includes('csa') || lowerMessage.includes('code')) && content.primaryCodes) {
                        return `**${moduleData.title} - Gas Codes and Standards**\n\n**Primary Codes:**\n${content.primaryCodes.map(code => `• ${code}`).join('\n')}\n\n${content.codeHierarchy ? `**Code Hierarchy:**\n${content.codeHierarchy.map(item => `• ${item}`).join('\n')}\n\n` : ''}**Important:** Always follow the most restrictive applicable code.\n\n📚 **From:** ${chapter.title}\n\nWhich code do you need help understanding?`;
                    }
                }
                
                // Generic module response if no specific match
                return `**${moduleData.title} Module**\n\n${moduleData.description}\n\n**Available Topics:**\n${Object.values(moduleData.chapters).map(ch => `• ${ch.title}`).join('\n')}\n\nI have detailed information about this module. Try asking about specific topics like safety procedures, equipment, or requirements.\n\nWhat would you like to know more about?`;
            }
            
            // Cross-module search if no specific module selected
            const searchResults = searchAllModules(lowerMessage);
            if (searchResults.length > 0) {
                let response = `**Found information across multiple modules:**\n\n`;
                searchResults.forEach(result => {
                    response += `📚 **Module ${result.moduleId}: ${result.title}**\n${result.content}\n\n`;
                });
                response += `💡 **Tip:** Select a specific module for more detailed information!`;
                return response;
            }
            
            // General response
            return `I'd be happy to help you with "${userMessage}"!\n\n**I can provide detailed information about:**\n\n🛡️ **Module 1 - Safety:**\n• PPE requirements and safety procedures\n• Hazard identification and risk assessment\n• Emergency response protocols\n\n🔧 **Module 2 - Tools & Equipment:**\n• Essential hand tools and specialized equipment\n• NPT vs BSP threading systems\n• Tool maintenance and calibration\n\n⚡ **Module 3 - Gas Properties:**\n• Natural gas composition and properties\n• Heating values and specific gravity\n• Flammable limits and safety characteristics\n\n📋 **Module 4 - Codes & Regulations:**\n• CSA B149.1 installation requirements\n• Code hierarchy and compliance\n• Permit and inspection procedures\n\n${selectedModule ? `**Current Module:** Module ${selectedModule}\n\n` : ''}Try asking about specific topics, procedures, or requirements. I have access to detailed chapter content from your course materials!\n\nWhat specific topic interests you?`;
        }

        // Search across all modules
        function searchAllModules(query) {
            const results = [];
            const lowerQuery = query.toLowerCase();
            
            Object.values(realModuleData).forEach(moduleData => {
                Object.values(moduleData.chapters).forEach(chapter => {
                    const content = chapter.content;
                    
                    // Search through different content types
                    if (content.keyTopics && content.keyTopics.some(topic => topic.toLowerCase().includes(lowerQuery))) {
                        results.push({
                            moduleId: moduleData.moduleId,
                            title: moduleData.title,
                            content: `Found in ${chapter.title}: ${content.overview}`
                        });
                    }
                });
            });
            
            return results;
        }

        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Hide welcome message if it exists
            const welcomeMessage = messagesContainer.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}
                </div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('sendBtn').disabled = true;
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
            document.getElementById('sendBtn').disabled = false;
        }

        // Update quick topics based on selected module
        function updateQuickTopics(moduleId) {
            const topicContainer = document.getElementById('topicButtons');
            
            if (!moduleId) {
                // Default general topics
                topicContainer.innerHTML = `
                    <button class="topic-btn" onclick="askQuestion('What PPE is required for gas technicians?')">PPE Requirements</button>
                    <button class="topic-btn" onclick="askQuestion('What are the primary hazards in gas work?')">Gas Hazards</button>
                    <button class="topic-btn" onclick="askQuestion('What tools are essential for gas work?')">Essential Tools</button>
                    <button class="topic-btn" onclick="askQuestion('What is NPT thread?')">NPT Threads</button>
                    <button class="topic-btn" onclick="askQuestion('What are natural gas properties?')">Gas Properties</button>
                    <button class="topic-btn" onclick="askQuestion('What is CSA B149.1?')">CSA Codes</button>
                    <button class="topic-btn" onclick="askQuestion('How do I perform leak testing?')">Leak Testing</button>
                    <button class="topic-btn" onclick="askQuestion('What are safety principles?')">Safety Principles</button>
                `;
                return;
            }
            
            const moduleData = realModuleData[moduleId];
            if (!moduleData) return;
            
            // Generate module-specific topics based on actual content
            let topicsHtml = '';
            const topicQuestions = getModuleSpecificQuestions(moduleId);
            
            topicQuestions.forEach(q => {
                topicsHtml += `<button class="topic-btn" onclick="askQuestion('${q.question}')">${q.label}</button>`;
            });
            
            topicContainer.innerHTML = topicsHtml;
        }

        // Get module-specific questions based on actual content
        function getModuleSpecificQuestions(moduleId) {
            const questionMap = {
                1: [
                    { question: 'What PPE is required for gas technicians?', label: 'PPE Requirements' },
                    { question: 'What are the primary hazards in gas work?', label: 'Gas Hazards' },
                    { question: 'What are the safety principles for gas work?', label: 'Safety Principles' },
                    { question: 'How do you assess risks in gas work?', label: 'Risk Assessment' },
                    { question: 'What are emergency procedures for gas incidents?', label: 'Emergency Procedures' },
                    { question: 'What specialized equipment is needed?', label: 'Specialized Equipment' }
                ],
                2: [
                    { question: 'What tools are essential for gas work?', label: 'Essential Tools' },
                    { question: 'What is NPT thread?', label: 'NPT Threads' },
                    { question: 'What are specialized gas tools?', label: 'Specialized Tools' },
                    { question: 'How do you maintain gas tools?', label: 'Tool Maintenance' },
                    { question: 'What thread sealants should be used?', label: 'Thread Sealants' },
                    { question: 'What are torque specifications?', label: 'Torque Specs' }
                ],
                3: [
                    { question: 'What are natural gas properties?', label: 'Gas Properties' },
                    { question: 'What is the heating value of natural gas?', label: 'Heating Value' },
                    { question: 'What is natural gas composition?', label: 'Gas Composition' },
                    { question: 'What are flammable limits?', label: 'Flammable Limits' },
                    { question: 'What is specific gravity of natural gas?', label: 'Specific Gravity' },
                    { question: 'How is natural gas odorized?', label: 'Gas Odorization' }
                ],
                4: [
                    { question: 'What is CSA B149.1?', label: 'CSA B149.1' },
                    { question: 'What codes govern gas work?', label: 'Gas Codes' },
                    { question: 'What is code hierarchy?', label: 'Code Hierarchy' },
                    { question: 'When are permits required?', label: 'Permit Requirements' },
                    { question: 'What are local amendments?', label: 'Local Amendments' },
                    { question: 'How are codes updated?', label: 'Code Updates' }
                ]
            };
            
            return questionMap[moduleId] || [];
        }

        // Enter key to send message
        document.getElementById('chatInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Module selection change
        document.getElementById('moduleSelect').addEventListener('change', function() {
            const selectedValue = this.value;
            const chatHeader = document.querySelector('.chat-header h2');
            
            if (selectedValue) {
                const module = realModuleData[selectedValue];
                if (module) {
                    chatHeader.textContent = `AI Tutor - ${module.title}`;
                    updateQuickTopics(selectedValue);
                }
            } else {
                chatHeader.textContent = 'AI Tutor Chat';
                updateQuickTopics(null);
            }
        });

        console.log('G3 AI Tutor with Real Data initialized successfully!');
    </script>
</body>
</html>