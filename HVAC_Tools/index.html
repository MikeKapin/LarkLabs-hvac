<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Pro Tools - Professional HVAC Calculators</title>
    <meta name="description" content="Professional HVAC calculators and tools for Canadian technicians. Load calculations, P-T charts, superheat/subcooling, unit conversions and more.">
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-180.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icon-192.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1em;
        }

        .nav-menu {
            display: flex;
            justify-content: center;
            background: rgba(0,0,0,0.1);
            padding: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 500;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .calculator {
            display: none;
            padding: 30px;
            max-width: 100%;
            min-height: calc(100vh - 200px);
        }

        .calculator.active {
            display: block;
        }

        .calc-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .calc-header h2 {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .calc-header p {
            color: #666;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .results {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            border-left: 5px solid #3498db;
        }

        .results.show {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e1e8ed;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .result-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #27ae60;
        }

        .status-good { color: #27ae60; }
        .status-warning { color: #f39c12; }
        .status-error { color: #e74c3c; }

        .chart-container {
            position: relative;
            height: 500px;
            margin: 30px 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(116, 185, 255, 0.3);
        }

        .info-card.warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }

        .info-card.success {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #3498db;
            margin-left: 5px;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .unit-toggle {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            border: none;
            border-radius: 25px;
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .unit-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .psychro-unit-btn {
            padding: 8px 16px;
            border: 2px solid #2196F3;
            background: white;
            color: #2196F3;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .psychro-unit-btn.active {
            background: #2196F3;
            color: white;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .nav-menu {
                padding: 10px;
                gap: 5px;
            }

            .nav-btn {
                padding: 8px 15px;
                font-size: 0.8em;
            }

            .calculator {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                min-width: auto;
            }

            .chart-container {
                height: 400px;
                padding: 15px;
            }
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            background: rgba(0,0,0,0.02);
            border-top: 1px solid #e1e8ed;
            margin-top: 40px;
        }

        .lark-logo {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🔧 HVAC Pro Tools</h1>
            <p>Professional-grade calculators for Canadian HVAC technicians</p>
            
            <!-- Navigation Menu -->
            <div class="nav-menu">
                <button class="nav-btn active" onclick="showCalculator('load-calc', this)">Load Calculator</button>
                <button class="nav-btn" onclick="showCalculator('superheat-subcool', this)">SuperHeat/SubCool</button>
                <button class="nav-btn" onclick="showCalculator('pt-chart', this)">P-T Chart</button>
                <button class="nav-btn" onclick="showCalculator('psychrometric', this)">Psychrometric</button>
                <button class="nav-btn" onclick="showCalculator('unit-converter', this)">Unit Converter</button>
                <button class="nav-btn" onclick="showCalculator('duct-sizing', this)">Duct Sizing</button>
            </div>
        </div>

        <!-- Load Calculator -->
        <div id="load-calc" class="calculator active">
            <div class="calc-header">
                <h2>🏠 Canadian HVAC Load Calculator</h2>
                <p>Professional heating and cooling load calculations for Canadian climates</p>
            </div>
            
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #2c3e50;">Building Information</h3>
                    <button class="unit-toggle" onclick="toggleUnits()">
                        📏 Switch to <span id="unit-display">Imperial</span>
                    </button>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="province">Province/Territory <span class="tooltip" data-tooltip="Climate data varies significantly across Canada">ℹ️</span></label>
                        <select id="province">
                            <option value="">Select Province/Territory</option>
                            <option value="BC">British Columbia</option>
                            <option value="AB">Alberta</option>
                            <option value="SK">Saskatchewan</option>
                            <option value="MB">Manitoba</option>
                            <option value="ON" selected>Ontario</option>
                            <option value="QC">Quebec</option>
                            <option value="NB">New Brunswick</option>
                            <option value="NS">Nova Scotia</option>
                            <option value="PE">Prince Edward Island</option>
                            <option value="NL">Newfoundland and Labrador</option>
                            <option value="YT">Yukon</option>
                            <option value="NT">Northwest Territories</option>
                            <option value="NU">Nunavut</option>
                        </select>
                    </div>
                    <div>
                        <label for="area">Floor Area <span id="area-unit">(ft²)</span></label>
                        <input type="number" id="area" placeholder="e.g., 1600" min="1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="ceiling-height">Ceiling Height <span id="height-unit">(ft)</span></label>
                        <input type="number" id="ceiling-height" placeholder="e.g., 8" min="6" max="16" step="0.1" value="8">
                    </div>
                    <div>
                        <label for="insulation">Insulation Level</label>
                        <select id="insulation">
                            <option value="poor">Poor (R-8 walls, R-20 attic)</option>
                            <option value="average" selected>Average (R-12 walls, R-30 attic)</option>
                            <option value="good">Good (R-20 walls, R-40 attic)</option>
                            <option value="excellent">Excellent (R-24+ walls, R-50+ attic)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="windows">Window Area <span id="window-unit">(ft²)</span></label>
                        <input type="number" id="windows" placeholder="e.g., 270" min="0">
                    </div>
                    <div>
                        <label for="window-type">Window Type</label>
                        <select id="window-type">
                            <option value="single">Single Pane</option>
                            <option value="double" selected>Double Pane</option>
                            <option value="triple">Triple Pane</option>
                            <option value="low-e">Low-E Double Pane</option>
                            <option value="low-e-triple">Low-E Triple Pane</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label for="occupants">Number of Occupants</label>
                        <input type="number" id="occupants" placeholder="e.g., 4" min="1" value="4">
                    </div>
                    <div>
                        <label for="building-age">Building Age</label>
                        <select id="building-age">
                            <option value="new">New (2010+)</option>
                            <option value="recent">Recent (1990-2009)</option>
                            <option value="older" selected>Older (1970-1989)</option>
                            <option value="old">Old (Pre-1970)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="calculateLoads()">🔥❄️ Calculate Heating & Cooling Loads</button>
                <button class="btn btn-secondary" onclick="clearLoadInputs()">Clear</button>
            </div>
            
            <div id="load-results" class="results"></div>
        </div>

        <!-- SuperHeat/SubCool Calculator -->
        <div id="superheat-subcool" class="calculator">
            <div class="calc-header">
                <h2>🌡️ SuperHeat & SubCool Calculator</h2>
                <p>Calculate superheat and subcooling for refrigeration systems</p>
            </div>
            
            <div class="form-row">
                <div>
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">🔥 SuperHeat Calculator</h3>
                    
                    <div class="form-group">
                        <label for="sh-refrigerant">Refrigerant Type:</label>
                        <select id="sh-refrigerant">
                            <option value="">Select Refrigerant</option>
                            <option value="R22">R-22 (HCFC)</option>
                            <option value="R134a">R-134a (HFC)</option>
                            <option value="R404A">R-404A (HFC)</option>
                            <option value="R407C">R-407C (HFC)</option>
                            <option value="R410A">R-410A (HFC)</option>
                            <option value="R32">R-32 (A2L)</option>
                            <option value="R454B">R-454B (A2L)</option>
                            <option value="R290">R-290 (Propane)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="suction-pressure">Suction Pressure (PSIG):</label>
                        <input type="number" id="suction-pressure" placeholder="Enter suction pressure">
                    </div>
                    
                    <div class="form-group">
                        <label for="suction-temp">Suction Line Temperature (°F):</label>
                        <input type="number" id="suction-temp" placeholder="Enter suction line temp">
                    </div>
                </div>
                
                <div>
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">❄️ SubCool Calculator</h3>
                    
                    <div class="form-group">
                        <label for="sc-refrigerant">Refrigerant Type:</label>
                        <select id="sc-refrigerant">
                            <option value="">Select Refrigerant</option>
                            <option value="R22">R-22 (HCFC)</option>
                            <option value="R134a">R-134a (HFC)</option>
                            <option value="R404A">R-404A (HFC)</option>
                            <option value="R407C">R-407C (HFC)</option>
                            <option value="R410A">R-410A (HFC)</option>
                            <option value="R32">R-32 (A2L)</option>
                            <option value="R454B">R-454B (A2L)</option>
                            <option value="R290">R-290 (Propane)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="discharge-pressure">Discharge Pressure (PSIG):</label>
                        <input type="number" id="discharge-pressure" placeholder="Enter discharge pressure">
                    </div>
                    
                    <div class="form-group">
                        <label for="liquid-temp">Liquid Line Temperature (°F):</label>
                        <input type="number" id="liquid-temp" placeholder="Enter liquid line temp">
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="calculateSuperheat()">Calculate SuperHeat</button>
                <button class="btn" onclick="calculateSubcooling()">Calculate SubCooling</button>
                <button class="btn btn-secondary" onclick="clearSuperheatInputs()">Clear</button>
            </div>
            
            <div id="superheat-results" class="results"></div>
        </div>

        <!-- P-T Chart Generator -->
        <div id="pt-chart" class="calculator">
            <div class="calc-header">
                <h2>🌡️ Refrigeration P-T Chart Generator</h2>
                <p>Interactive Pressure-Temperature charts for refrigeration analysis</p>
            </div>
            
            <div class="form-row">
                <div>
                    <label for="chart-refrigerant">Refrigerant Type:</label>
                    <select id="chart-refrigerant">
                        <optgroup label="Traditional HFCs/HCFCs">
                            <option value="R22" selected>R-22 (HCFC-22)</option>
                            <option value="R134a">R-134a (HFC-134a)</option>
                            <option value="R410A">R-410A (HFC-410A)</option>
                            <option value="R407C">R-407C (HFC-407C)</option>
                            <option value="R404A">R-404A (HFC-404A)</option>
                        </optgroup>
                        <optgroup label="A2L Refrigerants">
                            <option value="R32">R-32 (HFC-32) 🔥</option>
                            <option value="R454B">R-454B (HFO Blend) 🔥</option>
                            <option value="R452A">R-452A (HFC/HFO Blend) 🔥</option>
                        </optgroup>
                        <optgroup label="Natural Refrigerants">
                            <option value="R290">R-290 (Propane) 🔥</option>
                            <option value="R600a">R-600a (Isobutane) 🔥</option>
                            <option value="R717">R-717 (Ammonia) ⚠️</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label for="temp-min">Min Temperature (°C):</label>
                    <input type="number" id="temp-min" value="-40" step="5">
                </div>
                <div>
                    <label for="temp-max">Max Temperature (°C):</label>
                    <input type="number" id="temp-max" value="60" step="5">
                </div>
                <div>
                    <label for="chart-type">Chart Type:</label>
                    <select id="chart-type">
                        <option value="saturation" selected>Saturation Curve</option>
                        <option value="isotherms">Isotherms</option>
                        <option value="both">Both</option>
                    </select>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="generateChart()">📊 Generate P-T Chart</button>
                <button class="btn btn-secondary" onclick="clearChartInputs()">Clear</button>
            </div>
            
            <div class="chart-container">
                <canvas id="ptChart"></canvas>
            </div>
            
            <div id="chart-info" class="info-panel">
                <div class="info-card">
                    <h3>📊 Chart Information</h3>
                    <p id="chartInfo">Select a refrigerant and generate chart to see information</p>
                </div>
                <div class="info-card">
                    <h3>🧪 Refrigerant Properties</h3>
                    <p id="refProperties">Properties will be displayed after chart generation</p>
                </div>
            </div>
        </div>

        <!-- Advanced Psychrometric Calculator -->
        <div id="psychrometric" class="calculator">
            <div class="calc-header">
                <h2>🌫️ Advanced Refrigeration Psychrometric Calculator</h2>
                <p>Professional pressure chart analysis and air property calculations</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px; height: calc(100vh - 400px);">
                <!-- Controls Panel -->
                <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; overflow-y: auto;">
                    <div class="psychro-unit-toggle" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="psychro-unit-btn active" onclick="togglePsychroUnits('metric')">Metric</button>
                        <button class="psychro-unit-btn" onclick="togglePsychroUnits('imperial')">Imperial</button>
                    </div>

                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #1976D2; margin-bottom: 10px;">Refrigerant Properties</h4>
                        <div>
                            <label for="psychro-refrigerant" style="display: block; margin-bottom: 8px; font-weight: 600;">Refrigerant Type:</label>
                            <select id="psychro-refrigerant" onchange="updatePsychroRefrigerantInfo()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="R22">R-22 (HCFC-22)</option>
                                <option value="R134a">R-134a (HFC-134a)</option>
                                <option value="R410A">R-410A (HFC-410A)</option>
                                <option value="R404A">R-404A (HFC-404A)</option>
                                <option value="R507A">R-507A (HFC-507A)</option>
                                <option value="R407C">R-407C (HFC-407C)</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="psychro-temperature" style="display: block; margin-bottom: 8px; font-weight: 600;">Temperature (<span id="psychroTempUnit">°C</span>):</label>
                        <input type="number" id="psychro-temperature" value="25" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="psychro-pressure" style="display: block; margin-bottom: 8px; font-weight: 600;">Pressure (<span id="psychroPressureUnit">kPa</span>):</label>
                        <input type="number" id="psychro-pressure" value="101.325" step="0.001" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="psychro-humidity" style="display: block; margin-bottom: 8px; font-weight: 600;">Relative Humidity (%):</label>
                        <input type="number" id="psychro-humidity" value="50" min="0" max="100" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="psychro-elevation" style="display: block; margin-bottom: 8px; font-weight: 600;">Elevation (<span id="psychroElevationUnit">m</span>):</label>
                        <input type="number" id="psychro-elevation" value="0" step="1" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>

                    <button onclick="calculatePsychroProperties()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; margin-bottom: 20px;">Calculate Properties</button>

                    <div style="background: white; border-radius: 10px; padding: 20px;">
                        <h3 style="color: #333; margin-bottom: 15px; border-bottom: 2px solid #2196F3; padding-bottom: 8px;">Calculated Properties</h3>
                        <div id="psychroResultsContent">
                            <p>Enter values and click Calculate to see results</p>
                        </div>
                    </div>
                </div>

                <!-- Chart Panel -->
                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);">
                    <canvas id="psychrometricChart" style="width: 100%; height: 500px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Unit Converter -->
        <div id="unit-converter" class="calculator">
            <div class="calc-header">
                <h2>🔄 Universal Unit Converter</h2>
                <p>Convert between Imperial, Metric, Temperature, Pressure, Energy & Power units</p>
            </div>
            
            <div class="form-row">
                <!-- Length Conversion -->
                <div class="info-card">
                    <h3>📏 Length Conversion</h3>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: end; margin: 15px 0;">
                        <div>
                            <label>Feet</label>
                            <input type="number" id="length1" step="any" placeholder="Enter feet">
                        </div>
                        <button class="unit-toggle" onclick="swapLength()">⇄</button>
                        <div>
                            <label>Meters</label>
                            <input type="number" id="length2" step="any" placeholder="Enter meters">
                        </div>
                    </div>
                </div>
                
                <!-- Temperature Conversion -->
                <div class="info-card">
                    <h3>🌡️ Temperature Conversion</h3>
                    <div style="margin: 15px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label>Celsius</label>
                                <input type="number" id="temp1" step="any" placeholder="Enter °C">
                            </div>
                            <div>
                                <label>Fahrenheit</label>
                                <input type="number" id="temp2" step="any" placeholder="Enter °F">
                            </div>
                        </div>
                        <div>
                            <label>Kelvin</label>
                            <input type="number" id="temp3" step="any" placeholder="Enter K">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <!-- Pressure Conversion -->
                <div class="info-card">
                    <h3>🌪️ Pressure Conversion</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
                        <div>
                            <label>PSI</label>
                            <input type="number" id="pressure1" step="any" placeholder="Enter PSI">
                        </div>
                        <div>
                            <label>kPa</label>
                            <input type="number" id="pressure2" step="any" placeholder="Enter kPa">
                        </div>
                    </div>
                </div>
                
                <!-- Power Conversion -->
                <div class="info-card">
                    <h3>⚡ Power Conversion</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
                        <div>
                            <label>BTU/h</label>
                            <input type="number" id="power1" step="any" placeholder="Enter BTU/h">
                        </div>
                        <div>
                            <label>Watts</label>
                            <input type="number" id="power2" step="any" placeholder="Enter W">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="clearAllConverters()">Clear All</button>
            </div>
        </div>

        <!-- Duct Sizing Calculator -->
        <div id="duct-sizing" class="calculator">
            <div class="calc-header">
                <h2>🏠 Canadian HVAC Duct Sizing Calculator</h2>
                <p>Professional duct sizing based on CSA and NBC standards (Imperial Units)</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 30px; height: calc(100vh - 400px);">
                <!-- Input Section -->
                <div style="background: #f8f9fa; border-radius: 15px; padding: 30px; overflow-y: auto;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">System Parameters</h3>
                    
                    <div class="form-row">
                        <div>
                            <label for="climate-zone">Climate Zone</label>
                            <select id="climate-zone">
                                <option value="4">Zone 4 (Southern ON)</option>
                                <option value="5">Zone 5 (Central ON)</option>
                                <option value="6">Zone 6 (Northern ON)</option>
                                <option value="7a">Zone 7A (MB, SK)</option>
                                <option value="7b">Zone 7B (AB)</option>
                                <option value="8">Zone 8 (Northern Canada)</option>
                            </select>
                        </div>
                        <div>
                            <label for="building-type">Building Type</label>
                            <select id="building-type">
                                <option value="residential">Residential</option>
                                <option value="commercial">Commercial</option>
                                <option value="industrial">Industrial</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="furnace-capacity">Furnace/AHU Input (BTU/h)</label>
                            <input type="number" id="furnace-capacity" placeholder="e.g., 80000" value="80000">
                        </div>
                        <div>
                            <label for="fan-speed">Fan Capacity (CFM)</label>
                            <input type="number" id="fan-speed" placeholder="e.g., 1200" value="1200">
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="duct-material">Duct Material</label>
                            <select id="duct-material">
                                <option value="galvanized">Galvanized Steel</option>
                                <option value="aluminum">Aluminum</option>
                                <option value="flexible">Flexible Duct</option>
                                <option value="fiberglass">Fiberglass Board</option>
                            </select>
                        </div>
                        <div>
                            <label for="system-type">System Type</label>
                            <select id="system-type">
                                <option value="heating">Heating Only</option>
                                <option value="cooling">Cooling Only</option>
                                <option value="both">Heating & Cooling</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="duct-length">Total Equivalent Length (ft)</label>
                            <input type="number" id="duct-length" placeholder="e.g., 150" value="150">
                        </div>
                        <div>
                            <label for="fitting-count">Number of Fittings</label>
                            <input type="number" id="fitting-count" placeholder="e.g., 8" value="8">
                        </div>
                    </div>

                    <div style="background: white; border-radius: 10px; padding: 20px; margin-top: 20px; border: 2px solid #e9ecef;">
                        <h4 style="margin-bottom: 15px; color: #2c3e50;">Room Information</h4>
                        <div id="rooms-container">
                            <div class="room-input" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: end; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div>
                                    <label>Room Name</label>
                                    <input type="text" class="room-name" placeholder="e.g., Living Room" value="Living Room">
                                </div>
                                <div>
                                    <label>Area (sq ft)</label>
                                    <input type="number" class="room-area" placeholder="250" value="250">
                                </div>
                                <div>
                                    <label>Ceiling Height (ft)</label>
                                    <input type="number" class="room-height" placeholder="8" step="0.5" value="8">
                                </div>
                                <div>
                                    <label>Registers</label>
                                    <input type="number" class="room-registers" placeholder="1" min="1" value="2">
                                </div>
                            </div>
                        </div>
                        <button style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;" onclick="addRoom()">+ Add Room</button>
                    </div>

                    <button class="btn" onclick="calculateDuctSizing()" style="margin-top: 20px;">🏠 Calculate Duct Sizing</button>
                </div>

                <!-- Results Section -->
                <div style="background: white; border-radius: 15px; padding: 30px; overflow-y: auto;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">Calculation Results</h3>
                    
                    <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid #3498db;">
                        <h4 style="margin-bottom: 15px; color: #2c3e50;">System Summary</h4>
                        <div class="result-item">
                            <span class="result-label">Total Heating Load:</span>
                            <span class="result-value" id="total-load">- BTU/h</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Total Airflow Required:</span>
                            <span class="result-value" id="total-cfm">- CFM</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Static Pressure Loss:</span>
                            <span class="result-value" id="pressure-loss">- in. w.c.</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Cold Air Return Area:</span>
                            <span class="result-value" id="return-area">- sq in</span>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div style="background: white; border: 2px solid #3498db; border-radius: 10px; padding: 15px; text-align: center;">
                            <div style="font-size: 1.1em; font-weight: 600; color: #2c3e50; margin-bottom: 10px;">Main Trunk</div>
                            <div id="main-trunk-size">- inches</div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                Velocity: <span id="trunk-velocity">-</span> ft/min
                            </div>
                        </div>
                        <div style="background: white; border: 2px solid #3498db; border-radius: 10px; padding: 15px; text-align: center;">
                            <div style="font-size: 1.1em; font-weight: 600; color: #2c3e50; margin-bottom: 10px;">Sub-Trunk</div>
                            <div id="sub-trunk-size">- inches</div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                Velocity: <span id="sub-trunk-velocity">-</span> ft/min
                            </div>
                        </div>
                        <div style="background: white; border: 2px solid #3498db; border-radius: 10px; padding: 15px; text-align: center;">
                            <div style="font-size: 1.1em; font-weight: 600; color: #2c3e50; margin-bottom: 10px;">Branch Ducts</div>
                            <div id="branch-duct-range">- inches</div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                Round: <span id="round-duct-range">-</span>
                            </div>
                        </div>
                    </div>

                    <div id="duct-sizing-results">
                        <div style="text-align: center; color: #7f8c8d; margin-top: 50px; font-size: 1.1em;">
                            Enter room details and click calculate to see detailed duct sizing results.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Created by <span class="lark-logo">🐦 LARK Labs</span> - Professional HVAC Tools for Canadian Technicians</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Version 3.0 - Updated with correct calculator implementations</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Global variables
        let deferredPrompt;
        let currentChart = null;
        let isMetric = false;

        // Canadian climate data by province (heating degree days and cooling degree days)
        const climateData = {
            'BC': { hdd: 2800, cdd: 150, winterTemp: -8, summerTemp: 28, zone: 'Marine West Coast', winterTempF: 18, summerTempF: 82 },
            'AB': { hdd: 4500, cdd: 280, winterTemp: -25, summerTemp: 26, zone: 'Continental', winterTempF: -13, summerTempF: 79 },
            'SK': { hdd: 5200, cdd: 350, winterTemp: -28, summerTemp: 25, zone: 'Continental', winterTempF: -18, summerTempF: 77 },
            'MB': { hdd: 5100, cdd: 320, winterTemp: -27, summerTemp: 26, zone: 'Continental', winterTempF: -17, summerTempF: 79 },
            'ON': { hdd: 3800, cdd: 300, winterTemp: -18, summerTemp: 28, zone: 'Continental', winterTempF: 0, summerTempF: 82 },
            'QC': { hdd: 4200, cdd: 250, winterTemp: -22, summerTemp: 26, zone: 'Continental', winterTempF: -8, summerTempF: 79 },
            'NB': { hdd: 4100, cdd: 180, winterTemp: -18, summerTemp: 24, zone: 'Maritime', winterTempF: 0, summerTempF: 75 },
            'NS': { hdd: 3600, cdd: 120, winterTemp: -12, summerTemp: 23, zone: 'Maritime', winterTempF: 10, summerTempF: 73 },
            'PE': { hdd: 3800, cdd: 150, winterTemp: -14, summerTemp: 24, zone: 'Maritime', winterTempF: 7, summerTempF: 75 },
            'NL': { hdd: 4800, cdd: 80, winterTemp: -18, summerTemp: 20, zone: 'Maritime', winterTempF: 0, summerTempF: 68 },
            'YT': { hdd: 6500, cdd: 100, winterTemp: -35, summerTemp: 20, zone: 'Subarctic', winterTempF: -31, summerTempF: 68 },
            'NT': { hdd: 7200, cdd: 120, winterTemp: -35, summerTemp: 22, zone: 'Subarctic', winterTempF: -31, summerTempF: 72 },
            'NU': { hdd: 8500, cdd: 50, winterTemp: -40, summerTemp: 15, zone: 'Arctic', winterTempF: -40, summerTempF: 59 }
        };

        // Refrigerant P-T data
        const refrigerantData = {
            R22: {
                name: "R-22 (HCFC-22)",
                criticalTemp: 96.15,
                criticalPressure: 4990,
                molecularWeight: 86.47,
                globalWarmingPotential: 1810,
                boilingPoint: -40.8,
                safetyClass: "A1",
                antoine: { A: 8.2365, B: 1253.2, C: 230.0 },
                pressureTemp: {
                    20: 43.0, 25: 47.5, 30: 52.5, 35: 57.8, 40: 63.5, 45: 69.5, 50: 76.0,
                    55: 83.0, 60: 90.5, 65: 98.5, 70: 107.0, 75: 116.0, 80: 125.5, 85: 135.5,
                    90: 146.0, 95: 157.0, 100: 169.0, 105: 181.5, 110: 194.5, 115: 208.0,
                    120: 222.0, 125: 237.0, 130: 252.5
                }
            },
            R134a: {
                name: "R-134a (HFC-134a)",
                criticalTemp: 101.06,
                criticalPressure: 4059,
                molecularWeight: 102.03,
                globalWarmingPotential: 1430,
                boilingPoint: -26.3,
                safetyClass: "A1",
                antoine: { A: 8.0956, B: 1214.4, C: 233.86 },
                pressureTemp: {
                    20: 21.0, 25: 24.0, 30: 27.5, 35: 31.5, 40: 35.7, 45: 40.3, 50: 45.2,
                    55: 50.5, 60: 56.2, 65: 62.3, 70: 68.8, 75: 75.7, 80: 83.1, 85: 91.0,
                    90: 99.4, 95: 108.3, 100: 117.8, 105: 127.9, 110: 138.6, 115: 149.9,
                    120: 161.9, 125: 174.6, 130: 188.0
                }
            },
            R410A: {
                name: "R-410A (HFC-410A)",
                criticalTemp: 71.34,
                criticalPressure: 4901,
                molecularWeight: 72.58,
                globalWarmingPotential: 2088,
                boilingPoint: -51.6,
                safetyClass: "A1",
                antoine: { A: 8.1764, B: 1123.1, C: 231.4 },
                pressureTemp: {
                    20: 71.0, 25: 78.0, 30: 85.5, 35: 93.5, 40: 102.0, 45: 111.0, 50: 120.5,
                    55: 130.5, 60: 141.0, 65: 152.0, 70: 164.0, 75: 176.5, 80: 189.5, 85: 203.0,
                    90: 217.5, 95: 232.5, 100: 248.0, 105: 264.5, 110: 281.5, 115: 299.0,
                    120: 317.5, 125: 336.5, 130: 356.0
                }
            },
            R32: {
                name: "R-32 (HFC-32)",
                criticalTemp: 78.11,
                criticalPressure: 5782,
                molecularWeight: 52.02,
                globalWarmingPotential: 675,
                boilingPoint: -51.7,
                safetyClass: "A2L",
                antoine: { A: 8.3487, B: 1119.2, C: 231.2 },
                pressureTemp: {
                    20: 78.0, 25: 86.0, 30: 94.5, 35: 103.5, 40: 113.0, 45: 123.0, 50: 133.5,
                    55: 144.5, 60: 156.0, 65: 168.0, 70: 180.5, 75: 193.5, 80: 207.0, 85: 221.0,
                    90: 235.5, 95: 250.5, 100: 266.0, 105: 282.0, 110: 298.5, 115: 315.5,
                    120: 333.0, 125: 351.0, 130: 369.5
                }
            },
            R290: {
                name: "R-290 (Propane)",
                criticalTemp: 96.74,
                criticalPressure: 4251,
                molecularWeight: 44.1,
                globalWarmingPotential: 3,
                boilingPoint: -42.1,
                safetyClass: "A3",
                antoine: { A: 8.1126, B: 1050.2, C: 233.2 },
                pressureTemp: {
                    20: 36.0, 25: 41.0, 30: 46.5, 35: 52.5, 40: 59.0, 45: 66.0, 50: 73.5,
                    55: 81.5, 60: 90.0, 65: 99.0, 70: 108.5, 75: 118.5, 80: 129.0, 85: 140.0,
                    90: 151.5, 95: 163.5, 100: 176.0, 105: 189.0, 110: 202.5, 115: 216.5,
                    120: 231.0, 125: 246.0, 130: 261.5
                }
            }
        };

        // Insulation R-values
        const insulationValues = {
            'poor': { wall: 8, ceiling: 20, floor: 12 },
            'average': { wall: 12, ceiling: 30, floor: 20 },
            'good': { wall: 20, ceiling: 40, floor: 25 },
            'excellent': { wall: 24, ceiling: 50, floor: 30 }
        };

        // Window U-values
        const windowUValues = {
            'single': { imperial: 1.02, metric: 5.8 },
            'double': { imperial: 0.49, metric: 2.8 },
            'triple': { imperial: 0.32, metric: 1.8 },
            'low-e': { imperial: 0.35, metric: 2.0 },
            'low-e-triple': { imperial: 0.21, metric: 1.2 }
        };

        // Navigation functions
        function showCalculator(calcId, btn) {
            // Hide all calculators
            const calculators = document.querySelectorAll('.calculator');
            calculators.forEach(calc => calc.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(button => button.classList.remove('active'));
            
            // Show selected calculator
            document.getElementById(calcId).classList.add('active');
            btn.classList.add('active');
        }

        // Utility functions
        function showResults(elementId, content) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.classList.remove('show');
            element.style.display = 'block';
            setTimeout(() => element.classList.add('show'), 100);
        }

        function hideResults(elementId) {
            const element = document.getElementById(elementId);
            element.classList.remove('show');
            setTimeout(() => element.style.display = 'none', 300);
        }

        // Load Calculator Functions
        function toggleUnits() {
            isMetric = !isMetric;
            const unitDisplay = document.getElementById('unit-display');
            const areaUnit = document.getElementById('area-unit');
            const heightUnit = document.getElementById('height-unit');
            const windowUnit = document.getElementById('window-unit');
            
            const areaInput = document.getElementById('area');
            const heightInput = document.getElementById('ceiling-height');
            const windowInput = document.getElementById('windows');

            if (isMetric) {
                unitDisplay.textContent = 'Imperial';
                areaUnit.textContent = '(m²)';
                heightUnit.textContent = '(m)';
                windowUnit.textContent = '(m²)';
                
                if (areaInput.value) areaInput.value = Math.round(parseFloat(areaInput.value) * 0.092903);
                if (heightInput.value) heightInput.value = (parseFloat(heightInput.value) * 0.3048).toFixed(1);
                else heightInput.value = '2.4';
                if (windowInput.value) windowInput.value = Math.round(parseFloat(windowInput.value) * 0.092903);
                
                areaInput.placeholder = 'e.g., 150';
                heightInput.placeholder = 'e.g., 2.4';
                windowInput.placeholder = 'e.g., 25';
            } else {
                unitDisplay.textContent = 'Metric';
                areaUnit.textContent = '(ft²)';
                heightUnit.textContent = '(ft)';
                windowUnit.textContent = '(ft²)';
                
                if (areaInput.value) areaInput.value = Math.round(parseFloat(areaInput.value) / 0.092903);
                if (heightInput.value) heightInput.value = (parseFloat(heightInput.value) / 0.3048).toFixed(1);
                else heightInput.value = '8';
                if (windowInput.value) windowInput.value = Math.round(parseFloat(windowInput.value) / 0.092903);
                
                areaInput.placeholder = 'e.g., 1600';
                heightInput.placeholder = 'e.g., 8';
                windowInput.placeholder = 'e.g., 270';
            }
        }

        function calculateLoads() {
            const province = document.getElementById('province').value;
            let area = parseFloat(document.getElementById('area').value);
            let ceilingHeight = parseFloat(document.getElementById('ceiling-height').value);
            const insulation = document.getElementById('insulation').value;
            let windowArea = parseFloat(document.getElementById('windows').value);
            const windowType = document.getElementById('window-type').value;
            const occupants = parseInt(document.getElementById('occupants').value);
            const buildingAge = document.getElementById('building-age').value;

            if (!province || !area || isNaN(windowArea) || !occupants) {
                showResults('load-results', '<div class="error-message">Please fill in all required fields.</div>');
                return;
            }

            let areaM2 = isMetric ? area : area * 0.092903;
            let heightM = isMetric ? ceilingHeight : ceilingHeight * 0.3048;
            let windowAreaM2 = isMetric ? windowArea : windowArea * 0.092903;

            const climate = climateData[province];
            const insul = insulationValues[insulation];
            const windowU = windowUValues[windowType].metric;
            const volume = areaM2 * heightM;

            const wallArea = Math.sqrt(areaM2) * 4 * heightM - windowAreaM2;
            const ceilingArea = areaM2;
            const floorArea = areaM2;

            const wallLoss = (wallArea / insul.wall) * (21 - climate.winterTemp);
            const ceilingLoss = (ceilingArea / insul.ceiling) * (21 - climate.winterTemp);
            const floorLoss = (floorArea / insul.floor) * (21 - climate.winterTemp) * 0.5;
            const windowLoss = windowAreaM2 * windowU * (21 - climate.winterTemp);
            
            const infiltrationMultiplier = buildingAge === 'new' ? 0.3 : buildingAge === 'recent' ? 0.4 : buildingAge === 'older' ? 0.6 : 0.8;
            const infiltrationLoss = volume * infiltrationMultiplier * 1.2 * 1000 * (21 - climate.winterTemp) / 3600;

            const totalHeatLoss = wallLoss + ceilingLoss + floorLoss + windowLoss + infiltrationLoss;
            const designHeatLoad = totalHeatLoss * 1.2;
            const heatingCapacityBtu = designHeatLoad * 3.412;

            const coolingLoad = calculateCoolingLoad(areaM2, windowAreaM2, windowU, occupants, climate, insul);
            const coolingCapacityBtu = coolingLoad * 3.412;
            const coolingTons = coolingCapacityBtu / 12000;

            const areaUnit = isMetric ? 'm²' : 'ft²';
            const winterTemp = isMetric ? climate.winterTemp + '°C' : climate.winterTempF + '°F';
            const summerTemp = isMetric ? climate.summerTemp + '°C' : climate.summerTempF + '°F';

            const results = `
                <div class="result-item">
                    <span class="result-label">🔥 Heating Load:</span>
                    <span class="result-value">${Math.round(designHeatLoad).toLocaleString()} W (${Math.round(heatingCapacityBtu).toLocaleString()} BTU/h)</span>
                </div>
                <div class="result-item">
                    <span class="result-label">❄️ Cooling Load:</span>
                    <span class="result-value">${Math.round(coolingLoad).toLocaleString()} W (${coolingTons.toFixed(1)} Tons)</span>
                </div>
                <div class="result-item">
                    <span class="result-label">🌡️ Climate Zone:</span>
                    <span class="result-value">${climate.zone} (${province})</span>
                </div>
                <div class="result-item">
                    <span class="result-label">📊 Design Temperatures:</span>
                    <span class="result-value">Winter: ${winterTemp} | Summer: ${summerTemp}</span>
                </div>
                <div class="info-card warning" style="margin-top: 20px; padding: 15px;">
                    <strong>⚠️ Professional Note:</strong> These calculations provide estimates based on simplified methods. 
                    For final equipment sizing, consult with a licensed HVAC professional.
                </div>
            `;

            showResults('load-results', results);
        }

        function calculateCoolingLoad(areaM2, windowAreaM2, windowU, occupants, climate, insul) {
            const wallArea = Math.sqrt(areaM2) * 4 * 2.4 - windowAreaM2;
            const solarGain = windowAreaM2 * 300;
            const wallGain = (wallArea / insul.wall) * (climate.summerTemp - 21) * 0.7;
            const roofGain = (areaM2 / insul.ceiling) * (climate.summerTemp - 21 + 10);
            const occupantGain = occupants * 100;
            const applianceGain = areaM2 * 5;
            const ventilationGain = areaM2 * 2 * 1.2 * 1000 * (climate.summerTemp - 21) / 3600;
            
            return solarGain + wallGain + roofGain + occupantGain + applianceGain + ventilationGain;
        }

        function clearLoadInputs() {
            document.getElementById('area').value = '';
            document.getElementById('windows').value = '';
            document.getElementById('occupants').value = '4';
            document.getElementById('ceiling-height').value = '8';
            hideResults('load-results');
        }

        // SuperHeat/SubCool Calculator Functions
        function interpolateTemperature(pressure, pressureTempData) {
            const pressures = Object.keys(pressureTempData).map(Number).sort((a, b) => a - b);
            const temperatures = pressures.map(p => pressureTempData[p]);
            
            let lowerIndex = -1;
            for (let i = 0; i < temperatures.length - 1; i++) {
                if (pressure >= temperatures[i] && pressure <= temperatures[i + 1]) {
                    lowerIndex = i;
                    break;
                }
            }
            
            if (lowerIndex === -1) {
                if (pressure < temperatures[0]) {
                    return pressures[0];
                } else {
                    return pressures[pressures.length - 1];
                }
            }
            
            const p1 = temperatures[lowerIndex];
            const p2 = temperatures[lowerIndex + 1];
            const t1 = pressures[lowerIndex];
            const t2 = pressures[lowerIndex + 1];
            
            return t1 + (pressure - p1) * (t2 - t1) / (p2 - p1);
        }

        function calculateSuperheat() {
            const refrigerant = document.getElementById('sh-refrigerant').value;
            const suctionPressure = parseFloat(document.getElementById('suction-pressure').value);
            const suctionTemp = parseFloat(document.getElementById('suction-temp').value);

            if (!refrigerant || isNaN(suctionPressure) || isNaN(suctionTemp)) {
                showResults('superheat-results', '<div class="error-message">Please fill in all superheat fields.</div>');
                return;
            }

            const refData = refrigerantData[refrigerant];
            if (!refData) {
                showResults('superheat-results', '<div class="error-message">Refrigerant data not available.</div>');
                return;
            }

            const absolutePressure = suctionPressure + 14.7;
            const saturatedTemp = interpolateTemperature(absolutePressure, refData.pressureTemp);
            const superheat = suctionTemp - saturatedTemp;

            let statusClass = 'result-value';
            let statusText = '';

            if (superheat >= 5 && superheat <= 20) {
                statusClass = 'result-value status-good';
                statusText = '✓ GOOD';
            } else if (superheat >= 20 && superheat <= 30) {
                statusClass = 'result-value status-warning';
                statusText = '⚠️ HIGH';
            } else if (superheat < 5) {
                statusClass = 'result-value status-error';
                statusText = '❌ TOO LOW';
            } else {
                statusClass = 'result-value status-error';
                statusText = '❌ TOO HIGH';
            }

            const results = `
                <div class="result-item">
                    <span class="result-label">Refrigerant:</span>
                    <span class="result-value">${refData.name}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">SuperHeat:</span>
                    <span class="${statusClass}">${superheat.toFixed(1)}°F ${statusText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Saturated Temperature:</span>
                    <span class="result-value">${saturatedTemp.toFixed(1)}°F</span>
                </div>
            `;

            showResults('superheat-results', results);
        }

        function calculateSubcooling() {
            const refrigerant = document.getElementById('sc-refrigerant').value;
            const dischargePressure = parseFloat(document.getElementById('discharge-pressure').value);
            const liquidTemp = parseFloat(document.getElementById('liquid-temp').value);

            if (!refrigerant || isNaN(dischargePressure) || isNaN(liquidTemp)) {
                showResults('superheat-results', '<div class="error-message">Please fill in all subcooling fields.</div>');
                return;
            }

            const refData = refrigerantData[refrigerant];
            if (!refData) {
                showResults('superheat-results', '<div class="error-message">Refrigerant data not available.</div>');
                return;
            }

            const absolutePressure = dischargePressure + 14.7;
            const saturatedTemp = interpolateTemperature(absolutePressure, refData.pressureTemp);
            const subcooling = saturatedTemp - liquidTemp;

            let statusClass = 'result-value';
            let statusText = '';

            if (subcooling >= 5 && subcooling <= 20) {
                statusClass = 'result-value status-good';
                statusText = '✓ GOOD';
            } else if (subcooling >= 20 && subcooling <= 30) {
                statusClass = 'result-value status-warning';
                statusText = '⚠️ HIGH';
            } else if (subcooling < 5) {
                statusClass = 'result-value status-error';
                statusText = '❌ TOO LOW';
            } else {
                statusClass = 'result-value status-error';
                statusText = '❌ TOO HIGH';
            }

            const results = `
                <div class="result-item">
                    <span class="result-label">Refrigerant:</span>
                    <span class="result-value">${refData.name}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">SubCooling:</span>
                    <span class="${statusClass}">${subcooling.toFixed(1)}°F ${statusText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Saturated Temperature:</span>
                    <span class="result-value">${saturatedTemp.toFixed(1)}°F</span>
                </div>
            `;

            showResults('superheat-results', results);
        }

        function clearSuperheatInputs() {
            document.getElementById('sh-refrigerant').value = '';
            document.getElementById('sc-refrigerant').value = '';
            document.getElementById('suction-pressure').value = '';
            document.getElementById('suction-temp').value = '';
            document.getElementById('discharge-pressure').value = '';
            document.getElementById('liquid-temp').value = '';
            hideResults('superheat-results');
        }

        // P-T Chart Functions
        function calculateSaturationPressure(temp, antoine) {
            const logP = antoine.A - antoine.B / (antoine.C + temp);
            return Math.pow(10, logP);
        }

        function generateChart() {
            const refrigerant = document.getElementById('chart-refrigerant').value;
            const tempMin = parseFloat(document.getElementById('temp-min').value);
            const tempMax = parseFloat(document.getElementById('temp-max').value);
            const chartType = document.getElementById('chart-type').value;

            if (tempMin >= tempMax) {
                showResults('load-results', '<div class="error-message">Minimum temperature must be less than maximum temperature</div>');
                return;
            }

            const refData = refrigerantData[refrigerant];
            if (!refData) {
                showResults('load-results', '<div class="error-message">Refrigerant data not found</div>');
                return;
            }

            const temperatures = [];
            const step = (tempMax - tempMin) / 100;
            for (let i = 0; i <= 100; i++) {
                temperatures.push(tempMin + i * step);
            }
            
            const saturationData = temperatures.map(temp => {
                if (temp >= refData.criticalTemp) return null;
                const pressure = calculateSaturationPressure(temp, refData.antoine);
                return { x: temp, y: pressure };
            }).filter(point => point !== null);

            const datasets = [{
                label: 'Saturation Curve',
                data: saturationData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6
            }];

            if (currentChart) {
                currentChart.destroy();
            }

            const ctx = document.getElementById('ptChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `P-T Chart for ${refData.name}`,
                            font: { size: 18, weight: 'bold' },
                            color: '#2c3e50'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Temperature (°C)',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        y: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Pressure (kPa)',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });

            updateChartInfo(refData, tempMin, tempMax);
        }

        function updateChartInfo(refData, tempMin, tempMax) {
            const safetyIcon = refData.safetyClass === 'A2L' ? '🔥' : 
                             refData.safetyClass === 'A3' ? '🔥🔥' : '✅';

            document.getElementById('chartInfo').innerHTML = `
                <strong>Refrigerant:</strong> ${refData.name} ${safetyIcon}<br>
                <strong>Temperature Range:</strong> ${tempMin}°C to ${tempMax}°C<br>
                <strong>Critical Temperature:</strong> ${refData.criticalTemp.toFixed(1)}°C<br>
                <strong>Safety Class:</strong> ${refData.safetyClass}
            `;

            document.getElementById('refProperties').innerHTML = `
                <strong>Molecular Weight:</strong> ${refData.molecularWeight} g/mol<br>
                <strong>Boiling Point:</strong> ${refData.boilingPoint.toFixed(1)}°C<br>
                <strong>GWP:</strong> ${refData.globalWarmingPotential}<br>
                <strong>Safety Class:</strong> ${refData.safetyClass}
            `;
        }

        function clearChartInputs() {
            document.getElementById('temp-min').value = '-40';
            document.getElementById('temp-max').value = '60';
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            document.getElementById('chartInfo').textContent = 'Select a refrigerant and generate chart to see information';
            document.getElementById('refProperties').textContent = 'Properties will be displayed after chart generation';
        }

        // Advanced Psychrometric Calculator Functions
        let currentPsychroUnits = 'metric';
        let psychroChart = null;
        let psychroCalculatedData = [];

        // Refrigerant properties database
        const psychroRefrigerantData = {
            'R22': { name: 'R-22 (HCFC-22)', mw: 86.47, criticalTemp: 96.2, criticalPressure: 4990 },
            'R134a': { name: 'R-134a (HFC-134a)', mw: 102.03, criticalTemp: 101.1, criticalPressure: 4059 },
            'R410A': { name: 'R-410A (HFC-410A)', mw: 72.58, criticalTemp: 71.3, criticalPressure: 4901 },
            'R404A': { name: 'R-404A (HFC-404A)', mw: 97.6, criticalTemp: 72.1, criticalPressure: 3734 },
            'R507A': { name: 'R-507A (HFC-507A)', mw: 98.86, criticalTemp: 70.6, criticalPressure: 3705 },
            'R407C': { name: 'R-407C (HFC-407C)', mw: 86.2, criticalTemp: 86.7, criticalPressure: 4630 }
        };

        function togglePsychroUnits(unit) {
            currentPsychroUnits = unit;
            document.querySelectorAll('.psychro-unit-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updatePsychroUnitLabels();
            convertCurrentPsychroValues();
        }

        function updatePsychroUnitLabels() {
            if (currentPsychroUnits === 'metric') {
                document.getElementById('psychroTempUnit').textContent = '°C';
                document.getElementById('psychroPressureUnit').textContent = 'kPa';
                document.getElementById('psychroElevationUnit').textContent = 'm';
            } else {
                document.getElementById('psychroTempUnit').textContent = '°F';
                document.getElementById('psychroPressureUnit').textContent = 'psi';
                document.getElementById('psychroElevationUnit').textContent = 'ft';
            }
        }

        function convertCurrentPsychroValues() {
            const tempInput = document.getElementById('psychro-temperature');
            const pressureInput = document.getElementById('psychro-pressure');
            const elevationInput = document.getElementById('psychro-elevation');

            if (currentPsychroUnits === 'imperial') {
                tempInput.value = (parseFloat(tempInput.value) * 9/5 + 32).toFixed(1);
                pressureInput.value = (parseFloat(pressureInput.value) * 0.145038).toFixed(3);
                elevationInput.value = (parseFloat(elevationInput.value) * 3.28084).toFixed(0);
            } else {
                tempInput.value = ((parseFloat(tempInput.value) - 32) * 5/9).toFixed(1);
                pressureInput.value = (parseFloat(pressureInput.value) / 0.145038).toFixed(3);
                elevationInput.value = (parseFloat(elevationInput.value) / 3.28084).toFixed(0);
            }
        }

        function updatePsychroRefrigerantInfo() {
            const refrigerant = document.getElementById('psychro-refrigerant').value;
            const info = psychroRefrigerantData[refrigerant];
        }

        function calculatePsychroProperties() {
            const temperature = parseFloat(document.getElementById('psychro-temperature').value);
            const pressure = parseFloat(document.getElementById('psychro-pressure').value);
            const humidity = parseFloat(document.getElementById('psychro-humidity').value);
            const elevation = parseFloat(document.getElementById('psychro-elevation').value);
            const refrigerant = document.getElementById('psychro-refrigerant').value;

            let tempC = currentPsychroUnits === 'imperial' ? (temperature - 32) * 5/9 : temperature;
            let pressureKPa = currentPsychroUnits === 'imperial' ? pressure / 0.145038 : pressure;
            let elevationM = currentPsychroUnits === 'imperial' ? elevation / 3.28084 : elevation;

            const results = performAdvancedPsychrometricCalculations(tempC, pressureKPa, humidity, elevationM, refrigerant);
            
            displayPsychroResults(results);
            updatePsychroChart(results);
        }

        function performAdvancedPsychrometricCalculations(tempC, pressureKPa, humidity, elevationM, refrigerant) {
            const correctedPressure = pressureKPa * Math.pow((1 - 0.0065 * elevationM / 288.15), 5.257);
            const satVaporPressure = 0.61078 * Math.exp(17.27 * tempC / (tempC + 237.3));
            const vaporPressure = (humidity / 100) * satVaporPressure;
            const absoluteHumidity = 0.622 * vaporPressure / (correctedPressure - vaporPressure);
            const dewPoint = 237.3 * Math.log(vaporPressure / 0.61078) / (17.27 - Math.log(vaporPressure / 0.61078));
            const wetBulb = tempC * Math.atan(0.151977 * Math.sqrt(humidity + 8.313659)) + Math.atan(tempC + humidity) - Math.atan(humidity - 1.676331) + 0.00391838 * Math.pow(humidity, 1.5) * Math.atan(0.023101 * humidity) - 4.686035;
            const enthalpy = 1.006 * tempC + absoluteHumidity * (2501 + 1.86 * tempC);
            const specificVolume = (287.055 * (tempC + 273.15) * (1 + 1.607858 * absoluteHumidity)) / (correctedPressure * 1000);
            const refData = psychroRefrigerantData[refrigerant];
            const saturatedPressure = Math.exp(8.0 - 1500 / (tempC + 273.15 + 230));
            
            return { temperature: tempC, pressure: correctedPressure, humidity: humidity, absoluteHumidity: absoluteHumidity, dewPoint: dewPoint, wetBulb: wetBulb, enthalpy: enthalpy, specificVolume: specificVolume, vaporPressure: vaporPressure, saturatedPressure: saturatedPressure, refrigerant: refrigerant };
        }

        function displayPsychroResults(results) {
            const resultsContent = document.getElementById('psychroResultsContent');
            
            let displayTemp = currentPsychroUnits === 'imperial' ? results.temperature * 9/5 + 32 : results.temperature;
            let displayPressure = currentPsychroUnits === 'imperial' ? results.pressure * 0.145038 : results.pressure;
            let displayDewPoint = currentPsychroUnits === 'imperial' ? results.dewPoint * 9/5 + 32 : results.dewPoint;
            let displayWetBulb = currentPsychroUnits === 'imperial' ? results.wetBulb * 9/5 + 32 : results.wetBulb;
            
            const tempUnit = currentPsychroUnits === 'imperial' ? '°F' : '°C';
            const pressureUnit = currentPsychroUnits === 'imperial' ? 'psi' : 'kPa';
            const humidityUnit = currentPsychroUnits === 'imperial' ? 'lb/lb' : 'kg/kg';
            const enthalpyUnit = currentPsychroUnits === 'imperial' ? 'BTU/lb' : 'kJ/kg';
            const volumeUnit = currentPsychroUnits === 'imperial' ? 'ft³/lb' : 'm³/kg';

            resultsContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500; color: #555;">Dry Bulb Temperature:</span>
                    <span style="font-weight: 600; color: #2196F3;">${displayTemp.toFixed(2)} ${tempUnit}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500; color: #555;">Corrected Pressure:</span>
                    <span style="font-weight: 600; color: #2196F3;">${displayPressure.toFixed(3)} ${pressureUnit}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500; color: #555;">Relative Humidity:</span>
                    <span style="font-weight: 600; color: #2196F3;">${results.humidity.toFixed(1)} %</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500; color: #555;">Absolute Humidity:</span>
                    <span style="font-weight: 600; color: #2196F3;">${results.absoluteHumidity.toFixed(4)} ${humidityUnit}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500; color: #555;">Dew Point:</span>
                    <span style="font-weight: 600; color: #2196F3;">${displayDewPoint.toFixed(2)} ${tempUnit}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500; color: #555;">Wet Bulb Temperature:</span>
                    <span style="font-weight: 600; color: #2196F3;">${displayWetBulb.toFixed(2)} ${tempUnit}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500; color: #555;">Enthalpy:</span>
                    <span style="font-weight: 600; color: #2196F3;">${results.enthalpy.toFixed(2)} ${enthalpyUnit}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500; color: #555;">Specific Volume:</span>
                    <span style="font-weight: 600; color: #2196F3;">${results.specificVolume.toFixed(4)} ${volumeUnit}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500; color: #555;">Vapor Pressure:</span>
                    <span style="font-weight: 600; color: #2196F3;">${results.vaporPressure.toFixed(3)} kPa</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                    <span style="font-weight: 500; color: #555;">Refrigerant Sat. Pressure:</span>
                    <span style="font-weight: 600; color: #2196F3;">${results.saturatedPressure.toFixed(3)} kPa</span>
                </div>
            `;
            
            psychroCalculatedData.push(results);
        }

        function updatePsychroChart(results) {
            const ctx = document.getElementById('psychrometricChart').getContext('2d');
            
            const chartData = generatePsychroChartData(results);
            
            if (psychroChart) {
                psychroChart.destroy();
            }
            
            psychroChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Constant RH Lines',
                            data: chartData.rhLines,
                            borderColor: 'rgba(75, 192, 192, 0.6)',
                            backgroundColor: 'transparent',
                            showLine: true,
                            pointRadius: 0
                        },
                        {
                            label: 'Current State Point',
                            data: [{
                                x: results.temperature,
                                y: results.absoluteHumidity * 1000
                            }],
                            backgroundColor: 'rgba(255, 206, 86, 1)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            pointRadius: 8
                        },
                        {
                            label: 'Saturation Line',
                            data: chartData.saturationLine,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'transparent',
                            showLine: true,
                            pointRadius: 0,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: currentPsychroUnits === 'imperial' ? 'Dry Bulb Temperature (°F)' : 'Dry Bulb Temperature (°C)'
                            },
                            min: currentPsychroUnits === 'imperial' ? 32 : 0,
                            max: currentPsychroUnits === 'imperial' ? 140 : 60
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Absolute Humidity (g/kg dry air)'
                            },
                            min: 0,
                            max: 30
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Psychrometric Chart - ${results.refrigerant}`,
                            font: {
                                size: 18
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function generatePsychroChartData(results) {
            const rhLines = [];
            const saturationLine = [];
            
            const tempRange = currentPsychroUnits === 'imperial' ? 
                { min: 32, max: 140, step: 2 } : 
                { min: 0, max: 60, step: 1 };
            
            for (let t = tempRange.min; t <= tempRange.max; t += tempRange.step) {
                const tempC = currentPsychroUnits === 'imperial' ? (t - 32) * 5/9 : t;
                const satVaporPressure = 0.61078 * Math.exp(17.27 * tempC / (tempC + 237.3));
                const maxHumidity = 0.622 * satVaporPressure / (101.325 - satVaporPressure) * 1000;
                saturationLine.push({ x: t, y: maxHumidity });
            }
            
            [20, 40, 60, 80].forEach(rh => {
                const line = [];
                for (let t = tempRange.min; t <= tempRange.max; t += tempRange.step * 2) {
                    const tempC = currentPsychroUnits === 'imperial' ? (t - 32) * 5/9 : t;
                    const satVaporPressure = 0.61078 * Math.exp(17.27 * tempC / (tempC + 237.3));
                    const vaporPressure = (rh / 100) * satVaporPressure;
                    const humidity = 0.622 * vaporPressure / (101.325 - vaporPressure) * 1000;
                    if (humidity > 0 && humidity < 30) {
                        line.push({ x: t, y: humidity });
                    }
                }
                rhLines.push(...line);
            });
            
            return { rhLines, saturationLine };
        }

        // Unit Converter Functions
        document.getElementById('length1').addEventListener('input', function() {
            const feet = parseFloat(this.value);
            if (!isNaN(feet)) {
                document.getElementById('length2').value = (feet * 0.3048).toFixed(6);
            }
        });

        document.getElementById('length2').addEventListener('input', function() {
            const meters = parseFloat(this.value);
            if (!isNaN(meters)) {
                document.getElementById('length1').value = (meters / 0.3048).toFixed(6);
            }
        });

        document.getElementById('temp1').addEventListener('input', function() {
            const celsius = parseFloat(this.value);
            if (!isNaN(celsius)) {
                const f = (celsius * 9/5) + 32;
                const k = celsius + 273.15;
                document.getElementById('temp2').value = f.toFixed(2);
                document.getElementById('temp3').value = k.toFixed(2);
            }
        });

        document.getElementById('temp2').addEventListener('input', function() {
            const fahrenheit = parseFloat(this.value);
            if (!isNaN(fahrenheit)) {
                const c = (fahrenheit - 32) * 5/9;
                const k = c + 273.15;
                document.getElementById('temp1').value = c.toFixed(2);
                document.getElementById('temp3').value = k.toFixed(2);
            }
        });

        document.getElementById('temp3').addEventListener('input', function() {
            const kelvin = parseFloat(this.value);
            if (!isNaN(kelvin)) {
                const c = kelvin - 273.15;
                const f = (c * 9/5) + 32;
                document.getElementById('temp1').value = c.toFixed(2);
                document.getElementById('temp2').value = f.toFixed(2);
            }
        });

        document.getElementById('pressure1').addEventListener('input', function() {
            const psi = parseFloat(this.value);
            if (!isNaN(psi)) {
                document.getElementById('pressure2').value = (psi * 6.89476).toFixed(6);
            }
        });

        document.getElementById('pressure2').addEventListener('input', function() {
            const kpa = parseFloat(this.value);
            if (!isNaN(kpa)) {
                document.getElementById('pressure1').value = (kpa / 6.89476).toFixed(6);
            }
        });

        document.getElementById('power1').addEventListener('input', function() {
            const btuh = parseFloat(this.value);
            if (!isNaN(btuh)) {
                document.getElementById('power2').value = (btuh * 0.293071).toFixed(3);
            }
        });

        document.getElementById('power2').addEventListener('input', function() {
            const watts = parseFloat(this.value);
            if (!isNaN(watts)) {
                document.getElementById('power1').value = (watts / 0.293071).toFixed(2);
            }
        });

        function swapLength() {
            const val1 = document.getElementById('length1').value;
            const val2 = document.getElementById('length2').value;
            document.getElementById('length1').value = val2;
            document.getElementById('length2').value = val1;
        }

        function clearAllConverters() {
            document.getElementById('length1').value = '';
            document.getElementById('length2').value = '';
            document.getElementById('temp1').value = '';
            document.getElementById('temp2').value = '';
            document.getElementById('temp3').value = '';
            document.getElementById('pressure1').value = '';
            document.getElementById('pressure2').value = '';
            document.getElementById('power1').value = '';
            document.getElementById('power2').value = '';
        }

        // Advanced Duct Sizing Calculator Functions
        
        // Canadian climate zone heating factors (BTU/h per sq ft)
        const climateFactors = {
            '4': 35,    // Southern Ontario
            '5': 40,    // Central Ontario
            '6': 45,    // Northern Ontario
            '7a': 50,   // Manitoba, Saskatchewan
            '7b': 45,   // Alberta
            '8': 60     // Northern Canada
        };

        // Duct material friction factors (per 100 ft)
        const materialFriction = {
            'galvanized': 0.1,
            'aluminum': 0.08,
            'flexible': 0.25,
            'fiberglass': 0.12
        };

        // Standard duct sizes (rectangular W x H)
        const standardDuctSizes = [
            [6, 4], [8, 4], [10, 4], [12, 4], [14, 4], [16, 4], [18, 4], [20, 4],
            [6, 6], [8, 6], [10, 6], [12, 6], [14, 6], [16, 6], [18, 6], [20, 6], [22, 6], [24, 6],
            [8, 8], [10, 8], [12, 8], [14, 8], [16, 8], [18, 8], [20, 8], [22, 8], [24, 8], [26, 8], [28, 8],
            [10, 10], [12, 10], [14, 10], [16, 10], [18, 10], [20, 10], [22, 10], [24, 10], [26, 10], [28, 10], [30, 10],
            [12, 12], [14, 12], [16, 12], [18, 12], [20, 12], [22, 12], [24, 12], [26, 12], [28, 12], [30, 12], [32, 12], [36, 12]
        ];

        // Standard round duct sizes
        const roundDuctSizes = [4, 5, 6, 7, 8, 9, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30];

        let roomCount = 1;

        function addRoom() {
            roomCount++;
            const container = document.getElementById('rooms-container');
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-input';
            roomDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: end; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;';
            roomDiv.innerHTML = `
                <div>
                    <label>Room Name</label>
                    <input type="text" class="room-name" placeholder="e.g., Bedroom ${roomCount}">
                </div>
                <div>
                    <label>Area (sq ft)</label>
                    <input type="number" class="room-area" placeholder="150">
                </div>
                <div>
                    <label>Ceiling Height (ft)</label>
                    <input type="number" class="room-height" placeholder="8" step="0.5" value="8">
                </div>
                <div>
                    <label>Registers</label>
                    <input type="number" class="room-registers" placeholder="1" min="1" value="1">
                </div>
            `;
            container.appendChild(roomDiv);
        }

        function calculateEquivalentDiameter(width, height) {
            return 1.3 * Math.pow((width * height), 0.625) / Math.pow((width + height), 0.25);
        }

        function selectOptimalDuctSize(cfm, maxVelocity = 900) {
            const requiredArea = cfm / maxVelocity * 144; // Convert to sq in
            
            let bestSize = null;
            let bestVelocity = Infinity;
            
            // Check rectangular sizes
            for (let [w, h] of standardDuctSizes) {
                const area = w * h;
                if (area >= requiredArea) {
                    const velocity = (cfm / area) * 144;
                    if (velocity <= maxVelocity && velocity < bestVelocity) {
                        bestSize = [w, h, 'rect'];
                        bestVelocity = velocity;
                    }
                }
            }
            
            return bestSize;
        }

        function selectRoundDuct(cfm, maxVelocity = 800) {
            const requiredArea = cfm / maxVelocity * 144;
            const requiredDiameter = Math.sqrt(requiredArea * 4 / Math.PI);
            
            for (let diameter of roundDuctSizes) {
                const area = Math.PI * Math.pow(diameter / 2, 2);
                const velocity = (cfm / area) * 144;
                if (velocity <= maxVelocity) {
                    return diameter;
                }
            }
            return roundDuctSizes[roundDuctSizes.length - 1]; // Return largest if none fit
        }

        function calculatePressureLoss(cfm, ductSize, length, material, fittings = 0) {
            let equivalentDiameter;
            if (Array.isArray(ductSize)) {
                equivalentDiameter = calculateEquivalentDiameter(ductSize[0], ductSize[1]);
            } else {
                equivalentDiameter = ductSize;
            }
            
            // Friction loss calculation (simplified)
            const frictionFactor = materialFriction[material];
            const velocity = cfm / (Math.PI * Math.pow(equivalentDiameter / 24, 2)) * 4; // ft/min
            
            // Friction loss per 100 ft
            const frictionPer100 = frictionFactor * Math.pow(velocity / 1000, 1.9);
            const frictionLoss = (frictionPer100 * length) / 100;
            
            // Fitting losses (each fitting = approx 5 ft equivalent length)
            const fittingLoss = (frictionPer100 * fittings * 5) / 100;
            
            return frictionLoss + fittingLoss;
        }

        function calculateDuctSizing() {
            // Get system parameters
            const climateZone = document.getElementById('climate-zone').value;
            const buildingType = document.getElementById('building-type').value;
            const furnaceCapacity = parseFloat(document.getElementById('furnace-capacity').value) || 0;
            const fanSpeed = parseFloat(document.getElementById('fan-speed').value) || 0;
            const ductMaterial = document.getElementById('duct-material').value;
            const systemType = document.getElementById('system-type').value;
            const ductLength = parseFloat(document.getElementById('duct-length').value) || 150;
            const fittingCount = parseInt(document.getElementById('fitting-count').value) || 8;

            // Get room data
            const rooms = [];
            const roomInputs = document.querySelectorAll('.room-input');
            
            roomInputs.forEach(room => {
                const name = room.querySelector('.room-name').value || 'Unnamed Room';
                const area = parseFloat(room.querySelector('.room-area').value) || 0;
                const height = parseFloat(room.querySelector('.room-height').value) || 8;
                const registers = parseInt(room.querySelector('.room-registers').value) || 1;
                
                if (area > 0) {
                    rooms.push({ name, area, height, registers });
                }
            });

            if (rooms.length === 0) {
                document.getElementById('duct-sizing-results').innerHTML = '<div class="error-message">Please add at least one room with valid area.</div>';
                return;
            }

            // Calculate heating load for each room
            const heatingFactor = climateFactors[climateZone];
            let totalLoad = 0;
            let totalCFM = 0;
            
            rooms.forEach(room => {
                // Calculate heat load (BTU/h)
                room.heatLoad = room.area * heatingFactor;
                
                // Calculate required CFM (400-500 BTU/h per CFM for heating, 350-400 for cooling)
                const cfmPerBtu = systemType === 'cooling' ? 400 : 450;
                room.cfm = room.heatLoad / cfmPerBtu;
                
                // Distribute CFM across registers
                room.cfmPerRegister = room.cfm / room.registers;
                
                totalLoad += room.heatLoad;
                totalCFM += room.cfm;
            });

            // Calculate main trunk sizing (1000-1200 ft/min)
            const mainTrunkSize = selectOptimalDuctSize(totalCFM, 1100);
            const mainTrunkVelocity = mainTrunkSize ? 
                (totalCFM / (mainTrunkSize[0] * mainTrunkSize[1])) * 144 : 0;

            // Calculate sub-trunk sizing (800-1000 ft/min)
            const subTrunkCFM = totalCFM * 0.6; // Assume 60% of total flow through sub-trunk
            const subTrunkSize = selectOptimalDuctSize(subTrunkCFM, 900);
            const subTrunkVelocity = subTrunkSize ? 
                (subTrunkCFM / (subTrunkSize[0] * subTrunkSize[1])) * 144 : 0;

            // Calculate branch duct sizes for rooms
            rooms.forEach(room => {
                room.ductSize = selectOptimalDuctSize(room.cfm, 800);
                room.roundDuct = selectRoundDuct(room.cfm, 750);
                
                // Register sizing - standard 4"x10" or 3"x10"
                if (room.cfmPerRegister <= 60) {
                    room.registerSize = "3\" × 10\"";
                } else {
                    room.registerSize = "4\" × 10\"";
                }
            });

            // Calculate total pressure loss
            const mainTrunkPressure = calculatePressureLoss(totalCFM, mainTrunkSize, ductLength * 0.4, ductMaterial, fittingCount * 0.3);
            const subTrunkPressure = calculatePressureLoss(subTrunkCFM, subTrunkSize, ductLength * 0.3, ductMaterial, fittingCount * 0.3);
            const branchPressure = Math.max(...rooms.map(room => 
                calculatePressureLoss(room.cfm, room.ductSize, ductLength * 0.3 / rooms.length, ductMaterial, fittingCount * 0.4 / rooms.length)
            ));
            
            const totalPressureLoss = mainTrunkPressure + subTrunkPressure + branchPressure;

            // Calculate cold air return area (80% of supply CFM, 500 ft/min face velocity)
            const returnCFM = totalCFM * 0.8;
            const returnArea = (returnCFM / 500) * 144; // sq in

            // Update results
            document.getElementById('total-load').textContent = `${Math.round(totalLoad).toLocaleString()} BTU/h`;
            document.getElementById('total-cfm').textContent = `${Math.round(totalCFM)} CFM`;
            document.getElementById('pressure-loss').textContent = `${totalPressureLoss.toFixed(3)} in. w.c.`;
            document.getElementById('return-area').textContent = `${Math.round(returnArea)} sq in`;

            // Update trunk specifications
            if (mainTrunkSize) {
                document.getElementById('main-trunk-size').textContent = `${mainTrunkSize[0]}" × ${mainTrunkSize[1]}"`;
                document.getElementById('trunk-velocity').textContent = `${Math.round(mainTrunkVelocity)}`;
            }

            if (subTrunkSize) {
                document.getElementById('sub-trunk-size').textContent = `${subTrunkSize[0]}" × ${subTrunkSize[1]}"`;
                document.getElementById('sub-trunk-velocity').textContent = `${Math.round(subTrunkVelocity)}`;
            }

            // Branch duct range
            const branchSizes = rooms.map(room => `${room.ductSize[0]}"×${room.ductSize[1]}"`);
            const roundSizes = rooms.map(room => `${room.roundDuct}"`);
            document.getElementById('branch-duct-range').textContent = `${Math.min(...rooms.map(r => r.ductSize[0]))}-${Math.max(...rooms.map(r => r.ductSize[0]))} inch`;
            document.getElementById('round-duct-range').textContent = `${Math.min(...rooms.map(r => r.roundDuct))}-${Math.max(...rooms.map(r => r.roundDuct))}"`;

            // Generate detailed room table
            generateDuctSizingTable(rooms);

            // Check for warnings
            checkSystemWarnings(furnaceCapacity, totalLoad, fanSpeed, totalCFM, totalPressureLoss);
        }

        function generateDuctSizingTable(rooms) {
            const resultsDiv = document.getElementById('duct-sizing-results');
            
            let tableHTML = `
                <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid #3498db;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">Individual Room Duct Sizing</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); font-size: 14px;">
                            <thead>
                                <tr>
                                    <th style="padding: 8px 6px; text-align: center; border-bottom: 1px solid #e9ecef; background: #34495e; color: white; font-weight: 600; font-size: 12px;">Room</th>
                                    <th style="padding: 8px 6px; text-align: center; border-bottom: 1px solid #e9ecef; background: #34495e; color: white; font-weight: 600; font-size: 12px;">Area<br>(sq ft)</th>
                                    <th style="padding: 8px 6px; text-align: center; border-bottom: 1px solid #e9ecef; background: #34495e; color: white; font-weight: 600; font-size: 12px;">Heat Load<br>(BTU/h)</th>
                                    <th style="padding: 8px 6px; text-align: center; border-bottom: 1px solid #e9ecef; background: #34495e; color: white; font-weight: 600; font-size: 12px;">CFM<br>Required</th>
                                    <th style="padding: 8px 6px; text-align: center; border-bottom: 1px solid #e9ecef; background: #34495e; color: white; font-weight: 600; font-size: 12px;">Registers</th>
                                    <th style="padding: 8px 6px; text-align: center; border-bottom: 1px solid #e9ecef; background: #34495e; color: white; font-weight: 600; font-size: 12px;">CFM/<br>Register</th>
                                    <th style="padding: 8px 6px; text-align: center; border-bottom: 1px solid #e9ecef; background: #34495e; color: white; font-weight: 600; font-size: 12px;">Rectangular<br>Duct Size</th>
                                    <th style="padding: 8px 6px; text-align: center; border-bottom: 1px solid #e9ecef; background: #34495e; color: white; font-weight: 600; font-size: 12px;">Round Duct<br>Size</th>
                                    <th style="padding: 8px 6px; text-align: center; border-bottom: 1px solid #e9ecef; background: #34495e; color: white; font-weight: 600; font-size: 12px;">Register<br>Size</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            rooms.forEach(room => {
                tableHTML += `
                    <tr style="border-bottom: 1px solid #e9ecef;">
                        <td style="padding: 8px 6px; text-align: center;">${room.name}</td>
                        <td style="padding: 8px 6px; text-align: center;">${room.area}</td>
                        <td style="padding: 8px 6px; text-align: center;">${Math.round(room.heatLoad).toLocaleString()}</td>
                        <td style="padding: 8px 6px; text-align: center;">${Math.round(room.cfm)}</td>
                        <td style="padding: 8px 6px; text-align: center;">${room.registers}</td>
                        <td style="padding: 8px 6px; text-align: center;">${Math.round(room.cfmPerRegister)}</td>
                        <td style="padding: 8px 6px; text-align: center;">${room.ductSize[0]}" × ${room.ductSize[1]}"</td>
                        <td style="padding: 8px 6px; text-align: center;">${room.roundDuct}" ∅</td>
                        <td style="padding: 8px 6px; text-align: center;">${room.registerSize}</td>
                    </tr>
                `;
            });

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Add cold air return specifications
            const returnCFM = rooms.reduce((sum, room) => sum + room.cfm, 0) * 0.8;
            const returnArea = (returnCFM / 500) * 144;
            const recommendedReturns = Math.ceil(returnArea / 200); // 200 sq in per return

            tableHTML += `
                <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid #3498db;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">Cold Air Return Requirements</h4>
                    <div class="result-item">
                        <span class="result-label">Return Air CFM:</span>
                        <span class="result-value">${Math.round(returnCFM)} CFM</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total Return Area Required:</span>
                        <span class="result-value">${Math.round(returnArea)} sq in</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Recommended Number of Returns:</span>
                        <span class="result-value">${recommendedReturns}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Return Grille Size (each):</span>
                        <span class="result-value">${recommendedReturns === 1 ? '20" × 20"' : '16" × 20"'}</span>
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = tableHTML;
        }

        function checkSystemWarnings(furnaceCapacity, totalLoad, fanSpeed, totalCFM, pressureLoss) {
            const resultsDiv = document.getElementById('duct-sizing-results');
            let warnings = [];
            let errors = [];

            if (furnaceCapacity > 0 && furnaceCapacity < totalLoad) {
                errors.push('🚨 Furnace capacity is insufficient for calculated heating load.');
            }

            if (fanSpeed > 0 && fanSpeed < totalCFM) {
                errors.push('🚨 Fan capacity is insufficient for required airflow.');
            }

            if (pressureLoss > 0.5) {
                errors.push(`🚨 Static pressure loss (${pressureLoss.toFixed(3)}" w.c.) exceeds maximum allowable (0.5" w.c.).`);
            }

            if (totalCFM > 2000) {
                warnings.push('⚠️ High airflow requirements may require zoning or larger equipment.');
            }

            if (pressureLoss > 0.4) {
                warnings.push('⚠️ Static pressure approaching maximum limit. Consider larger ducts.');
            }

            if (errors.length > 0) {
                const errorHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <strong>System Errors - Must Be Addressed:</strong><br>
                        ${errors.join('<br>')}
                    </div>
                `;
                resultsDiv.innerHTML += errorHTML;
            }

            if (warnings.length > 0) {
                const warningHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <strong>System Warnings:</strong><br>
                        ${warnings.join('<br>')}
                    </div>
                `;
                resultsDiv.innerHTML += warningHTML;
            }
        }

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            deferredPrompt = e;
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ HVAC Pro Tools 3.0 - Advanced Duct Sizing Implementation loaded successfully');
        });
    </script>
</body>
</html>