<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HVAC Jack">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#E85A4F">
    <title>HVAC Jack - Your Jack of All Trades HVAC AI Assistant</title>
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1A1F2E;
            min-height: 100vh;
            color: #E2E8F0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Password Protection Styles */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1A1F2E;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 2rem;
        }

        .password-container {
            background: #2D3748;
            border: 2px solid #E85A4F;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(232, 90, 79, 0.3);
        }

        .password-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem auto;
            background-image: url('icon-192.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .password-title {
            color: #E85A4F;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .password-subtitle {
            color: #A0AEC0;
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        .password-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #4A5568;
            border-radius: 12px;
            background: #1A1F2E;
            color: #E2E8F0;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .password-input:focus {
            outline: none;
            border-color: #E85A4F;
            box-shadow: 0 0 0 3px rgba(232, 90, 79, 0.2);
        }

        .password-input::placeholder {
            color: #718096;
        }

        .password-button {
            width: 100%;
            padding: 1rem;
            background: #E85A4F;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(232, 90, 79, 0.4);
        }

        .password-button:hover {
            background: #C53030;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 90, 79, 0.6);
        }

        .password-button:active {
            transform: translateY(0);
        }

        .password-error {
            color: #F56565;
            font-size: 0.9rem;
            margin-top: 1rem;
            padding: 0.5rem;
            background: rgba(245, 101, 101, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(245, 101, 101, 0.3);
        }

        .beta-badge {
            background: linear-gradient(135deg, #E85A4F, #C53030);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .hidden {
            display: none !important;
        }

        /* Main App Styles - OPTIMIZED HEADER */
        .mobile-header {
            background: rgba(26, 31, 46, 0.95);
            padding: 0.75rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            min-height: 70px;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #2D3748;
        }

        .mobile-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            position: relative;
            margin-bottom: 0.5rem;
        }

        .header-settings-btn {
            width: 40px;
            height: 40px;
            background: #E85A4F;
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: all 0.3s;
            touch-action: manipulation;
            flex-shrink: 0;
        }

        .header-settings-btn:active {
            transform: scale(0.9);
            background: #C53030;
        }

        /* HVAC Jack Text Logo - Replaces Image Logo */
        .header-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #E85A4F;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex: 1;
            text-align: center;
        }

        .header-title::before {
            content: "üîß";
            font-size: 1.6rem;
        }

        .mobile-mode-toggle {
            display: flex;
            background: #2D3748;
            border-radius: 20px;
            padding: 2px;
            flex-shrink: 0;
            border: 1px solid #4A5568;
        }

        .mobile-mode-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            background: transparent;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            min-height: 36px;
            touch-action: manipulation;
            color: #A0AEC0;
        }

        .mobile-mode-btn.active {
            background: #E85A4F;
            color: white;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-status {
            font-size: 0.65rem;
            color: #A0AEC0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            width: 100%;
        }

        .mobile-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #48BB78;
            animation: pulse 2s infinite;
        }

        .mobile-status-dot.error {
            background: #F56565;
        }

        .mobile-status-dot.connecting {
            background: #ED8936;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-container {
            padding: 0;
            height: calc(100vh - 70px);
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 240px;
        }

        .mobile-chat-container {
            flex: 1;
            background: #1A1F2E;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .mobile-context-bar {
            background: linear-gradient(135deg, #E85A4F 0%, #C53030 100%);
            color: white;
            padding: 0.4rem;
            font-size: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 1px solid #C53030;
            flex-shrink: 0;
        }

        .mobile-context-bar.expanded {
            padding: 0.8rem 0.4rem;
        }

        .context-toggle {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .mobile-context-details {
            display: none;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .mobile-context-details.show {
            display: block;
        }

        .mobile-messages {
            flex: 1;
            padding: 1rem 0.75rem 20px 0.75rem;
            overflow-y: auto;
            background: #1A1F2E;
            -webkit-overflow-scrolling: touch;
        }

        .mobile-message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mobile-message.user {
            justify-content: flex-end;
        }

        .mobile-message.ai {
            justify-content: flex-start;
        }

        .mobile-message-content {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            position: relative;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .mobile-message.user .mobile-message-content {
            background: #E85A4F;
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-message.ai .mobile-message-content {
            background: #2D3748;
            border: 1px solid #4A5568;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: #E2E8F0;
        }

        .mobile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .mobile-avatar.user {
            background: #E85A4F;
            color: white;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-avatar.ai {
            background: #2D3748;
            color: #E85A4F;
            border: 1px solid #4A5568;
        }

        /* Manual Search Results Styling */
        .manual-search-results {
            background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%);
            border: 2px solid #38B2AC;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 8px 24px rgba(56, 178, 172, 0.3);
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #4A5568;
        }

        .search-icon {
            width: 48px;
            height: 48px;
            background: #38B2AC;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .search-title {
            color: #38B2AC;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .search-subtitle {
            color: #A0AEC0;
            font-size: 0.85rem;
        }

        .manual-link {
            display: block;
            background: rgba(56, 178, 172, 0.1);
            border: 1px solid #38B2AC;
            border-radius: 12px;
            padding: 1rem;
            margin: 0.8rem 0;
            text-decoration: none;
            color: #E2E8F0;
            transition: all 0.3s;
        }

        .manual-link:hover {
            background: rgba(56, 178, 172, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(56, 178, 172, 0.3);
        }

        .manual-title {
            color: #38B2AC;
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .manual-description {
            color: #A0AEC0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .search-loading {
            background: rgba(56, 178, 172, 0.1);
            border: 1px solid #38B2AC;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            color: #38B2AC;
        }

        .search-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #4A5568;
            border-top: 2px solid #38B2AC;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .mobile-input-container {
            padding: 0.75rem;
            background: #2D3748;
            border-top: 1px solid #4A5568;
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            min-height: 140px;
        }

        .mobile-quick-actions {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .mobile-quick-actions::-webkit-scrollbar {
            display: none;
        }

        .mobile-quick-btn {
            padding: 0.4rem 0.8rem;
            background: #1A1F2E;
            border: 1px solid #4A5568;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.3s;
            min-height: 36px;
            touch-action: manipulation;
            color: #A0AEC0;
        }

        .mobile-quick-btn:active {
            background: #E85A4F;
            color: white;
            border-color: #E85A4F;
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .mobile-input-field {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #4A5568;
            border-radius: 20px;
            font-size: 1rem;
            min-height: 44px;
            resize: none;
            max-height: 100px;
            transition: border-color 0.3s;
            background: #1A1F2E;
            color: #E2E8F0;
        }

        .mobile-input-field:focus {
            outline: none;
            border-color: #E85A4F;
            box-shadow: 0 0 0 3px rgba(232, 90, 79, 0.2);
        }

        .mobile-input-field::placeholder {
            color: #718096;
        }

        .mobile-send-btn {
            width: 44px;
            height: 44px;
            background: #E85A4F;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .mobile-send-btn:active {
            transform: scale(0.9);
            background: #C53030;
        }

        .mobile-send-btn:disabled {
            background: #4A5568;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Photo Upload Styles */
        .photo-upload-btn {
            width: 44px;
            height: 44px;
            background: #38B2AC;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(56, 178, 172, 0.4);
            margin-right: 0.5rem;
        }

        .photo-upload-btn:active {
            transform: scale(0.9);
            background: #319795;
        }

        .photo-upload-input {
            display: none;
        }

        .photo-preview-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9998;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .photo-preview {
            max-width: 90%;
            max-height: 60%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .photo-preview-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .photo-action-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .photo-action-btn.analyze {
            background: #E85A4F;
            color: white;
            box-shadow: 0 4px 16px rgba(232, 90, 79, 0.4);
        }

        .photo-action-btn.cancel {
            background: #4A5568;
            color: white;
        }

        .photo-action-btn:active {
            transform: scale(0.95);
        }

        .analysis-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 31, 46, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #4A5568;
            border-top: 4px solid #E85A4F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #E2E8F0;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .loading-subtitle {
            color: #A0AEC0;
            font-size: 0.9rem;
            text-align: center;
        }

        .rating-plate-info {
            background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%);
            border: 2px solid #E85A4F;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 8px 24px rgba(232, 90, 79, 0.2);
        }

        .rating-plate-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #4A5568;
        }

        .rating-plate-icon {
            width: 48px;
            height: 48px;
            background: #E85A4F;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .rating-plate-title {
            color: #E85A4F;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .rating-plate-subtitle {
            color: #A0AEC0;
            font-size: 0.85rem;
        }

        .info-section {
            margin-bottom: 1.5rem;
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        .info-section-title {
            color: #E85A4F;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
        }

        .info-item {
            background: rgba(74, 85, 104, 0.3);
            padding: 0.8rem;
            border-radius: 8px;
            border-left: 3px solid #E85A4F;
        }

        .info-item-label {
            color: #A0AEC0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .info-item-value {
            color: #E2E8F0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .warranty-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            margin-top: 0.5rem;
        }

        .warranty-active {
            background: linear-gradient(135deg, #48BB78, #38A169);
            color: white;
        }

        .warranty-expired {
            background: linear-gradient(135deg, #F56565, #E53E3E);
            color: white;
        }

        .warranty-expiring {
            background: linear-gradient(135deg, #ED8936, #DD6B20);
            color: white;
        }

        .capacitor-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .capacitor-item {
            background: rgba(56, 178, 172, 0.1);
            border: 1px solid #38B2AC;
            border-radius: 8px;
            padding: 0.6rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .capacitor-component {
            color: #38B2AC;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .capacitor-specs {
            color: #E2E8F0;
            font-size: 0.8rem;
        }

        .mobile-typing {
            display: none;
            padding: 0.5rem 0.75rem;
            color: #A0AEC0;
            font-size: 0.8rem;
            align-items: center;
            gap: 0.5rem;
            position: fixed;
            bottom: 220px;
            left: 0;
            right: 0;
            background: rgba(26, 31, 46, 0.95);
            z-index: 1001;
            backdrop-filter: blur(10px);
        }

        .mobile-typing-dots {
            display: flex;
            gap: 0.2rem;
        }

        .mobile-typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #E85A4F;
            animation: typing 1.4s infinite ease-in-out;
        }

        .mobile-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .mobile-typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .mobile-fab {
            display: none;
        }

        .mobile-footer {
            background: rgba(26, 31, 46, 0.95);
            border-top: 1px solid #2D3748;
            padding: 0.75rem;
            text-align: center;
            backdrop-filter: blur(10px);
            position: sticky;
            bottom: 0;
            z-index: 1000;
        }

        .footer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            font-size: 0.75rem;
            color: #A0AEC0;
        }

        .footer-logo {
            width: 20px;
            height: 20px;
            cursor: pointer;
            background: #E85A4F;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
        }

        .footer-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .footer-text {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .copyright {
            margin-top: 0.25rem;
            font-size: 0.65rem;
            color: #718096;
        }

        /* Connection error styling */
        .connection-error {
            background: rgba(245, 101, 101, 0.2);
            border: 1px solid #F56565;
            color: #FEB2B2;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            font-size: 0.8rem;
        }

        /* Scrollbar styling for webkit browsers */
        .mobile-messages::-webkit-scrollbar {
            width: 4px;
        }

        .mobile-messages::-webkit-scrollbar-track {
            background: #1A1F2E;
        }

        .mobile-messages::-webkit-scrollbar-thumb {
            background: #4A5568;
            border-radius: 2px;
        }

        .mobile-messages::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* Enhanced glow effects for interactive elements */
        .mobile-send-btn:hover,
        .mobile-fab:hover,
        .photo-upload-btn:hover {
            box-shadow: 0 4px 16px rgba(232, 90, 79, 0.6);
        }

        .mobile-mode-btn.active {
            box-shadow: 0 2px 12px rgba(232, 90, 79, 0.5);
        }

        /* Quick button hover effects */
        .mobile-quick-btn:hover {
            background: #2D3748;
            border-color: #E85A4F;
            color: #E85A4F;
        }

        /* Input field focus glow */
        .mobile-input-field:focus {
            box-shadow: 0 0 0 3px rgba(232, 90, 79, 0.3), 0 0 20px rgba(232, 90, 79, 0.1);
        }

        /* Message content styling improvements */
        .mobile-message.ai .mobile-message-content strong {
            color: #E85A4F;
        }

        /* Enhanced context bar gradient */
        .mobile-context-bar {
            background: linear-gradient(135deg, #E85A4F 0%, #C53030 50%, #9C2A2A 100%);
            box-shadow: 0 2px 10px rgba(232, 90, 79, 0.3);
        }

        /* Improved header styling */
        .mobile-header {
            background: linear-gradient(180deg, rgba(26, 31, 46, 0.98) 0%, rgba(26, 31, 46, 0.95) 100%);
            border-bottom: 1px solid #E85A4F;
        }

        .analysis-text-result {
            color: #E2E8F0;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div class="password-overlay" id="passwordOverlay">
        <div class="password-container">
            <div class="beta-badge">üîí BETA ACCESS</div>
            <div class="password-logo"></div>
            <h1 class="password-title">HVAC Jack</h1>
            <p class="password-subtitle">Beta Testing - Enter access code to continue</p>
            
            <input 
                type="password" 
                class="password-input" 
                id="passwordInput" 
                placeholder="Enter password..."
                autocomplete="new-password"
            />
            
            <button class="password-button" onclick="checkPassword()">
                üöÄ Access HVAC Jack
            </button>
            
            <div class="password-error hidden" id="passwordError">
                ‚ùå Incorrect password. Please try again.
            </div>
        </div>
    </div>

    <!-- Photo Preview Overlay -->
    <div class="photo-preview-container hidden" id="photoPreviewContainer">
        <img id="photoPreview" class="photo-preview" alt="Rating plate photo" />
        <div class="photo-preview-actions">
            <button class="photo-action-btn analyze" onclick="analyzeRatingPlate()">
                üîç Analyze Rating Plate
            </button>
            <button class="photo-action-btn cancel" onclick="cancelPhotoPreview()">
                ‚ùå Cancel
            </button>
        </div>
    </div>

    <!-- Analysis Loading Overlay -->
    <div class="analysis-loading hidden" id="analysisLoading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Analyzing Rating Plate...</div>
        <div class="loading-subtitle">Reading text and looking up equipment data</div>
    </div>

    <!-- Main App Content (hidden initially) -->
    <div class="main-app hidden" id="mainApp">
        <div class="mobile-header">
            <div class="mobile-header-content">
                <!-- Mode toggle removed - single mode only -->
                <div class="mobile-mode-title">
                    üè† HVAC Assistant
                </div>
                <div class="header-title">HVAC Jack</div>
                <button class="header-settings-btn" onclick="showMobileMenu()">‚öôÔ∏è</button>
            </div>
            <div class="mobile-status">
                <div class="mobile-status-dot connecting" id="mobileStatusDot"></div>
                <span id="mobileStatusText">Connecting to Jack...</span>
            </div>
        </div>

        <div class="main-container">
            <div class="mobile-chat-container">
                <div class="mobile-messages" id="mobileMessages">
                    <div class="mobile-message ai">
                        <div class="mobile-avatar ai">üîß</div>
                        <div class="mobile-message-content" id="mobileWelcomeMessage">
                            <strong>Hey! I'm HVAC Jack!</strong><br><br>
                            üè† <strong>Homeowner Mode</strong> - I'll explain things simply and focus on safe DIY steps.<br><br>
                            üì∏ <strong>NEW: Rating Plate Analysis!</strong> - Take a photo of your equipment's rating plate for detailed specs, warranty info, and capacitor requirements!<br><br>
                            üîç <strong>Manual Search!</strong> - Give me a make/model/serial number and I'll find manuals and diagnostic data online!<br><br>
                            üí≠ <strong>I Remember Everything</strong> - No need to repeat yourself as we chat!<br><br>
                            <strong>What's wrong with your heating or cooling?</strong>
                        </div>
                    </div>
                </div>
                <div class="mobile-context-bar" id="mobileContextBar" onclick="toggleContext()">
                    <div id="mobileContextSummary">üß† New conversation - Jack is learning about your system</div>
                    <div class="context-toggle">Tap to expand memory</div>
                    <div class="mobile-context-details" id="mobileContextDetails">
                        <strong>System:</strong> <span id="mobileSystemType">Unknown</span><br>
                        <strong>Problem:</strong> <span id="mobileProblemType">Diagnosing</span><br>
                        <strong>Messages:</strong> <span id="mobileMessageCount">0</span>
                    </div>
                </div>

                <div class="mobile-typing" id="mobileTyping">
                    <span>Jack is thinking</span>
                    <div class="mobile-typing-dots">
                        <div class="mobile-typing-dot"></div>
                        <div class="mobile-typing-dot"></div>
                        <div class="mobile-typing-dot"></div>
                    </div>
                </div>

                <div class="mobile-input-container">
                    <div class="mobile-quick-actions">
                        <button class="mobile-quick-btn" onclick="quickQuestion('No heat from furnace')">üî• No Heat</button>
                        <button class="mobile-quick-btn" onclick="quickQuestion('AC not cooling')">‚ùÑÔ∏è No Cool</button>
                        <button class="mobile-quick-btn" onclick="quickQuestion('Strange noises')">üîä Noise</button>
                        <button class="mobile-quick-btn" onclick="quickQuestion('System short cycling')">üîÑ Cycling</button>
                        <button class="mobile-quick-btn" onclick="quickQuestion('Frozen AC coil')">üßä Frozen</button>
                        <button class="mobile-quick-btn" onclick="quickQuestion('Find manual for my Carrier 58MXA')">üìö Manual</button>
                        <button class="mobile-quick-btn" onclick="triggerPhotoUpload()">üì∏ Photo</button>
                    </div>
                    
                    <div class="mobile-input-group">
                        <button class="photo-upload-btn" onclick="triggerPhotoUpload()" title="Take photo of rating plate">
                            üì∏
                        </button>
                        <input type="file" id="photoUpload" class="photo-upload-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event)" />
                        <textarea class="mobile-input-field" id="mobileInput" placeholder="Tell Jack what's wrong..." rows="1" onkeypress="handleMobileKeyPress(event)" oninput="adjustTextareaHeight(this)"></textarea>
                        <button class="mobile-send-btn" id="mobileSendBtn" onclick="sendMobileMessage()">
                            <span>‚û§</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mobile-footer">
            <div class="footer-content">
                <div class="footer-text">
                    Created by 
                    <div class="footer-logo">
                        üîß
                    </div>
                    LARK Labs
                </div>
            </div>
            <div class="copyright">
                ¬© 2025 LARK Labs. All rights reserved. HVAC Jack is a trademark of LARK Labs.
            </div>
        </div>

        <button class="mobile-fab" id="mobileFab" style="display: none;" onclick="showMobileMenu()">‚öôÔ∏è</button>
    </div>

    <script>
        // Password Protection System
        const BETA_PASSWORD = 'HVACJACK2025';
        const SESSION_KEY = 'hvacjack_beta_session';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const errorDiv = document.getElementById('passwordError');
            const password = input.value.trim();

            if (password === BETA_PASSWORD) {
                const session = {
                    authenticated: true,
                    timestamp: Date.now()
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(session));
                
                document.getElementById('passwordOverlay').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                initializeMainApp();
                
                console.log('‚úÖ Beta access granted - Welcome to HVAC Jack!');
            } else {
                errorDiv.classList.remove('hidden');
                input.value = '';
                input.focus();
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 3000);
            }
        }

        function checkExistingSession() {
            const stored = localStorage.getItem(SESSION_KEY);
            if (stored) {
                try {
                    const session = JSON.parse(stored);
                    const timeElapsed = Date.now() - session.timestamp;
                    
                    if (session.authenticated && timeElapsed < SESSION_DURATION) {
                        document.getElementById('passwordOverlay').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        initializeMainApp();
                        return true;
                    } else {
                        localStorage.removeItem(SESSION_KEY);
                    }
                } catch (error) {
                    localStorage.removeItem(SESSION_KEY);
                }
            }
            return false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            
            passwordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    checkPassword();
                }
            });
            
            if (!checkExistingSession()) {
                setTimeout(() => passwordInput.focus(), 100);
            }
        });

        function initializeMainApp() {
            const mobileHvacJack = new SecureMobileHVACJack();
            window.mobileHvacJack = mobileHvacJack;
        }

        let photoProcessor;
        
        function initPhotoProcessor() {
            if (!photoProcessor) {
                photoProcessor = new PhotoProcessor();
            }
            return photoProcessor;
        }

        function triggerPhotoUpload() {
            document.getElementById('photoUpload').click();
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const processor = initPhotoProcessor();
            
            const validation = processor.validateFile(file);
            if (!validation.valid) {
                alert('Invalid file: ' + validation.errors.join(', '));
                event.target.value = '';
                return;
            }

            processor.processImage(file)
                .then(result => {
                    const preview = document.getElementById('photoPreview');
                    preview.src = result.dataUrl;
                    preview.dataset.processedImage = result.dataUrl;
                    
                    document.getElementById('photoPreviewContainer').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Photo processing error:', error);
                    alert('Failed to process image: ' + error.message);
                    event.target.value = '';
                });
        }

        function cancelPhotoPreview() {
            document.getElementById('photoPreviewContainer').classList.add('hidden');
            document.getElementById('photoUpload').value = '';
        }

        async function analyzeRatingPlate() {
            document.getElementById('photoPreviewContainer').classList.add('hidden');
            document.getElementById('analysisLoading').classList.remove('hidden');

            try {
                const preview = document.getElementById('photoPreview');
                const imageData = preview.dataset.processedImage || preview.src;
                
                if (!imageData) {
                    throw new Error('No image data available');
                }

                const mode = window.mobileHvacJack ? window.mobileHvacJack.currentMode : 'homeowner';
                const sessionId = window.mobileHvacJack ? window.mobileHvacJack.sessionId : 'unknown';

                console.log('Sending photo to Claude API for analysis...');
                
                const analysisResult = await sendPhotoForAnalysis(imageData, mode, sessionId);
                
                document.getElementById('analysisLoading').classList.add('hidden');

                if (!analysisResult.success) {
                    throw new Error(analysisResult.message || 'Analysis failed');
                }

                displayClaudeAnalysisResult(analysisResult, mode);

                if (window.mobileHvacJack) {
                    await window.mobileHvacJack.trackUsage('photo_analyzed', {
                        analysisMethod: 'claude_api',
                        mode: mode,
                        success: true,
                        responseTime: analysisResult.responseTime
                    });
                }

            } catch (error) {
                console.error('Photo analysis error:', error);
                document.getElementById('analysisLoading').classList.add('hidden');
                
                addMobileMessage(`‚ùå **Photo Analysis Failed**\n\n${error.message}\n\nPlease try:\n‚Ä¢ Taking a clearer photo\n‚Ä¢ Better lighting\n‚Ä¢ Getting closer to the rating plate\n‚Ä¢ Ask me manually about your equipment`, 'ai');
                
                if (window.mobileHvacJack) {
                    await window.mobileHvacJack.trackUsage('photo_analysis_failed', {
                        error: error.message,
                        analysisMethod: 'claude_api'
                    });
                }
            }

            document.getElementById('photoUpload').value = '';
        }

        async function sendPhotoForAnalysis(imageData, mode, sessionId) {
            const photoAnalysisEndpoint = '../../../.netlify/functions/analyze-photo';
            
            let base64Data = imageData;
            if (imageData.startsWith('data:')) {
                base64Data = imageData.split(',')[1];
            }

            const requestBody = {
                imageData: base64Data,
                mode: mode,
                sessionId: sessionId
            };

            console.log('Sending to photo analysis endpoint:', photoAnalysisEndpoint);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);

            try {
                const response = await fetch(photoAnalysisEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Analysis server error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('Photo analysis result received:', {
                    success: result.success,
                    hasStructuredData: !!result.structuredData,
                    responseTime: result.responseTime
                });

                return result;
                
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    throw new Error('Analysis timed out. Please try again with a clearer photo.');
                }
                
                throw error;
            }
        }

       // Enhanced photo analysis function with automatic manual search
function displayClaudeAnalysisResult(analysisResult, mode) {
    // First, display the analysis results
    addMobileMessage('üì∏ **Rating Plate Analysis Complete!**\n\nClaude has analyzed your equipment photo:', 'ai');
    
    // Check if capacitor data was enhanced via database lookup
    if (analysisResult.capacitorLookup && analysisResult.capacitorLookup.enhanced) {
        const capacitorSource = analysisResult.capacitorLookup.lookupSource;
        const confidence = analysisResult.capacitorLookup.confidence;
        addMobileMessage(`üîã **Capacitor Data Enhanced!**\n\nCapacitor specifications found via ${capacitorSource} (${confidence}% confidence)`, 'ai');
    }
    
    const formattedResult = AnalysisFormatter.formatAnalysisResult(analysisResult, mode);
    
    if (!formattedResult.success) {
        addMobileMessage(`‚ùå **Analysis Error**\n\n${formattedResult.error}`, 'ai');
        return;
    }

    const messagesContainer = document.getElementById('mobileMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mobile-message ai';
    
    const avatar = document.createElement('div');
    avatar.className = 'mobile-avatar ai';
    avatar.textContent = 'üîç';
    
    const messageContent = document.createElement('div');
    messageContent.className = 'mobile-message-content';
    messageContent.innerHTML = formattedResult.formatted;
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(messageContent);
    messagesContainer.appendChild(messageDiv);
    
    if (window.mobileHvacJack) {
        window.mobileHvacJack.scrollToBottom();
        
        // Update system context with equipment details
        if (formattedResult.structured && formattedResult.structured.equipment) {
            const equipment = formattedResult.structured.equipment;
            window.mobileHvacJack.systemContext.equipmentType = equipment.type?.toLowerCase() || null;
            window.mobileHvacJack.systemContext.brand = equipment.brand || null;
            window.mobileHvacJack.systemContext.model = equipment.model || null;
            window.mobileHvacJack.updateMobileMemoryDisplay();
        }
    }

    // **NEW: Automatically search for manuals if we have equipment details**
    const equipment = formattedResult.structured?.equipment;
    if (equipment && equipment.brand && equipment.model) {
        console.log('Auto-triggering manual search for:', equipment.brand, equipment.model);
        
        // Show that we're searching for manuals
        setTimeout(() => {
            addMobileMessage('üîç **Searching for official manuals and documentation...**', 'ai');
            performAutomaticManualSearch(equipment, analysisResult, mode);
        }, 1500);
    } else {
        // If no equipment details, show the standard follow-up
        setTimeout(() => {
            const followUpMessage = mode === 'technician' 
                ? 'üîß **Technical Analysis Complete!** I have the specifications. What diagnostic issue are you working on?'
                : '‚úÖ **Analysis Complete!** I now know about your equipment. What problem are you experiencing?';
                
            addMobileMessage(followUpMessage, 'ai');
        }, 1000);
    }
}

// NEW: Automatic manual search function
async function performAutomaticManualSearch(equipment, analysisResult, mode) {
    try {
        // Construct the manual search message
        const searchMessage = `Find installation guides, service manuals, and user manuals for ${equipment.brand} model ${equipment.model} ${equipment.type || 'equipment'}`;
        
        console.log('Performing automatic manual search:', searchMessage);
        
        // Use the existing manual search infrastructure
        const requestBody = {
            message: searchMessage,
            mode: mode,
            conversationHistory: [], // Fresh context for manual search
            systemContext: {
                equipmentType: equipment.type || 'equipment',
                brand: equipment.brand,
                model: equipment.model,
                isManualSearch: true,
                searchType: 'auto_photo_manual_search'
            },
            photoAnalysisData: analysisResult, // Include the photo analysis context
            sessionId: window.mobileHvacJack ? window.mobileHvacJack.sessionId : 'unknown'
        };

        const response = await fetch('../../../.netlify/functions/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        if (response.ok) {
            const result = await response.json();
            
            if (result.response && result.response.trim()) {
                // Display the manual search results
                addMobileMessage(result.response, 'ai');
                
                // Add a helpful follow-up message
                const followUpMessage = mode === 'technician'
                    ? 'üìã **Complete Equipment Profile Ready!** I have the specifications, manuals, and documentation. What specific diagnostic issue are you working on?'
                    : 'üéØ **Everything Ready!** I have your equipment details and manuals. What specific problem are you experiencing with this unit?';
                
                setTimeout(() => {
                    addMobileMessage(followUpMessage, 'ai');
                    
                    // Run the text selection fix after manual results are displayed
                    setTimeout(() => {
                        if (typeof makeTextSelectableAndClickable === 'function') {
                            makeTextSelectableAndClickable();
                        }
                    }, 500);
                }, 2000);
                
                // Track successful auto manual search
                if (window.mobileHvacJack) {
                    await window.mobileHvacJack.trackUsage('auto_manual_search_success', {
                        brand: equipment.brand,
                        model: equipment.model,
                        equipmentType: equipment.type,
                        mode: mode
                    });
                }
            } else {
                throw new Error('Empty response from manual search');
            }
        } else {
            throw new Error(`Manual search failed: ${response.status}`);
        }

    } catch (error) {
        console.error('Automatic manual search failed:', error);
        
        // Fallback message with manual search tips
        const fallbackMessage = generateManualSearchFallback(equipment, mode);
        addMobileMessage(fallbackMessage, 'ai');
        
        // Track failure
        if (window.mobileHvacJack) {
            await window.mobileHvacJack.trackUsage('auto_manual_search_failed', {
                brand: equipment.brand,
                model: equipment.model,
                error: error.message,
                mode: mode
            });
        }
    }
}

// Generate fallback manual search response
function generateManualSearchFallback(equipment, mode) {
    const brand = equipment.brand || 'Equipment';
    const model = equipment.model || '';
    
    let response = `üìö **Manual Search for ${brand} ${model}**\n\n`;
    response += `I'll help you find official documentation:\n\n`;
    
    // Brand-specific manual sources
    const manualSources = {
        'generac': 'https://www.generac.com/support/product-support/owner-support',
        'kohler': 'https://kohlerpower.com/support',
        'carrier': 'https://www.carrier.com/residential/en/us/support/',
        'trane': 'https://www.trane.com/residential/en/support/',
        'lennox': 'https://www.lennox.com/support',
        'york': 'https://www.york.com/residential-equipment/support',
        'rheem': 'https://www.rheem.com/support',
        'goodman': 'https://www.goodman-mfg.com/support'
    };
    
    const brandLower = brand.toLowerCase();
    if (manualSources[brandLower]) {
        response += `üîó **Official ${brand} Support:** ${manualSources[brandLower]}\n`;
        response += `‚Ä¢ Search for model: ${model}\n`;
        response += `‚Ä¢ Download installation guides\n`;
        response += `‚Ä¢ Find service manuals\n\n`;
    }
    
    response += `**General Manual Resources:**\n`;
    response += `üîó **ManualsLib:** https://www.manualslib.com/\n`;
    response += `üîó **RepairClinic:** https://www.repairclinic.com/\n`;
    response += `üîó **AppliancePartsPros:** https://www.appliancepartspros.com/\n\n`;
    
    response += `**Search Tips:**\n`;
    response += `‚Ä¢ Use exact model: "${brand} ${model}"\n`;
    response += `‚Ä¢ Try: "${brand} ${model} installation manual"\n`;
    response += `‚Ä¢ Try: "${brand} ${model} service manual"\n`;
    response += `‚Ä¢ Try: "${brand} ${model} user guide"\n\n`;
    
    const followUp = mode === 'technician'
        ? 'üîß **Ready for Diagnostics!** What specific issue are you troubleshooting?'
        : 'üè† **Equipment Profile Complete!** What problem are you experiencing?';
    
    response += followUp;
    
    return response;
}

        class AnalysisFormatter {
            static formatAnalysisResult(analysisData, mode = 'homeowner') {
                if (!analysisData.success) {
                    return {
                        success: false,
                        error: analysisData.message || 'Analysis failed',
                        fallback: analysisData.fallback || false
                    };
                }

                const { analysis, structuredData } = analysisData;

                if (structuredData && mode === 'technician') {
                    return {
                        success: true,
                        formatted: this.formatTechnicalAnalysis(structuredData, analysis),
                        raw: analysis,
                        structured: structuredData
                    };
                }

                return {
                    success: true,
                    formatted: this.formatTextAnalysis(analysis, mode),
                    raw: analysis
                };
            }

            static formatTechnicalAnalysis(data, rawText) {
                let formatted = `<div class="rating-plate-info">`;
                
                if (data.equipment) {
                    formatted += `
                        <div class="rating-plate-header">
                            <div class="rating-plate-icon">üìã</div>
                            <div>
                                <div class="rating-plate-title">${data.equipment.brand || 'Unknown'} ${data.equipment.type || 'Equipment'}</div>
                                <div class="rating-plate-subtitle">Model: ${data.equipment.model || 'N/A'} ‚Ä¢ Age: ${data.equipment.age || 'Unknown'}</div>
                            </div>
                        </div>`;
                }

                if (data.equipment) {
                    formatted += `
                        <div class="info-section">
                            <div class="info-section-title">üîß Equipment Specifications</div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-item-label">Model Number</div>
                                    <div class="info-item-value">${data.equipment.model || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-item-label">Serial Number</div>
                                    <div class="info-item-value">${data.equipment.serial || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-item-label">Capacity</div>
                                    <div class="info-item-value">${data.equipment.capacity || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-item-label">Manufacturing Date</div>
                                    <div class="info-item-value">${data.equipment.manufacturingDate || 'N/A'}</div>
                                </div>
                            </div>
                        </div>`;
                }

                if (data.electrical) {
                    formatted += `
                        <div class="info-section">
                            <div class="info-section-title">‚ö° Electrical Specifications</div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-item-label">Voltage</div>
                                    <div class="info-item-value">${data.electrical.voltage || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-item-label">FLA</div>
                                    <div class="info-item-value">${data.electrical.fla || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-item-label">LRA</div>
                                    <div class="info-item-value">${data.electrical.lra || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-item-label">MCA</div>
                                    <div class="info-item-value">${data.electrical.mca || 'N/A'}</div>
                                </div>
                            </div>
                        </div>`;
                }

                if (data.capacitors && data.capacitors.length > 0) {
                    const capacitorTitle = data.capacitorLookupSource ? 
                        `üîã Capacitor Requirements <span style="font-size: 0.75em; color: #A0AEC0;">(${data.capacitorLookupSource})</span>` :
                        'üîã Capacitor Requirements';
                        
                    formatted += `
                        <div class="info-section">
                            <div class="info-section-title">${capacitorTitle}</div>
                            <div class="capacitor-list">`;
                    
                    data.capacitors.forEach(cap => {
                        const specs = cap.mfd ? `${cap.mfd} MFD, ${cap.voltage} ${cap.type}` : `${cap.voltage} ${cap.type}`;
                        const notes = cap.notes ? `<div style="font-size: 0.7em; color: #A0AEC0; margin-top: 2px;">${cap.notes}</div>` : '';
                        
                        formatted += `
                            <div class="capacitor-item">
                                <div class="capacitor-component">${cap.component}</div>
                                <div class="capacitor-specs">${specs}${notes}</div>
                            </div>`;
                    });
                    
                    formatted += `</div>`;
                    
                    // Add database lookup confidence if available
                    if (data.capacitorConfidence && data.capacitorConfidence < 80) {
                        formatted += `<div style="font-size: 0.75em; color: #FBD38D; margin-top: 8px;">
                            ‚ö†Ô∏è Verify these specifications with your equipment manual or existing capacitor labels
                        </div>`;
                    }
                    
                    formatted += `</div>`;
                }

                if (data.warranty) {
                    const statusClass = data.warranty.status === 'active' ? 'warranty-active' : 
                                       data.warranty.status === 'expiring' ? 'warranty-expiring' : 'warranty-expired';
                    
                    formatted += `
                        <div class="info-section">
                            <div class="info-section-title">üõ°Ô∏è Warranty Status</div>
                            <div class="warranty-status ${statusClass}">
                                ${data.warranty.status === 'active' ? '‚úÖ WARRANTY ACTIVE' : 
                                  data.warranty.status === 'expiring' ? '‚ö†Ô∏è WARRANTY EXPIRING' : 
                                  '‚ùå WARRANTY EXPIRED'}
                            </div>
                            <div style="margin-top: 0.5rem; color: #A0AEC0; font-size: 0.85rem;">
                                ${data.warranty.coverage || 'Standard manufacturer warranty terms apply'}
                            </div>
                        </div>`;
                }

                if (data.technicalNotes) {
                    formatted += `
                        <div class="info-section">
                            <div class="info-section-title">üìù Technical Notes</div>
                            <div style="color: #A0AEC0; font-size: 0.85rem; line-height: 1.4;">
                                ${data.technicalNotes.replace(/\n/g, '<br>')}
                            </div>
                        </div>`;
                }

                formatted += `</div>`;
                return formatted;
            }

            static formatTextAnalysis(text, mode) {
                let formatted = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');

                return `<div class="analysis-text-result">${formatted}</div>`;
            }
        }

        class PhotoProcessor {
            constructor() {
                this.maxFileSize = 10 * 1024 * 1024;
                this.maxDimension = 2048;
                this.compressionQuality = 0.85;
                this.allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
            }

            validateFile(file) {
                const errors = [];

                if (!file) {
                    errors.push('No file selected');
                    return { valid: false, errors };
                }

                if (!this.allowedTypes.includes(file.type)) {
                    errors.push('Please upload a JPEG, PNG, or WebP image');
                }

                if (file.size > this.maxFileSize) {
                    errors.push(`File too large. Maximum size is ${this.maxFileSize / 1024 / 1024}MB`);
                }

                return {
                    valid: errors.length === 0,
                    errors
                };
            }

            async processImage(file) {
                return new Promise((resolve, reject) => {
                    const validation = this.validateFile(file);
                    if (!validation.valid) {
                        reject(new Error(validation.errors.join(', ')));
                        return;
                    }

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    img.onload = () => {
                        try {
                            const { width, height } = this.calculateOptimalSize(
                                img.width, 
                                img.height, 
                                this.maxDimension
                            );

                            canvas.width = width;
                            canvas.height = height;

                            ctx.drawImage(img, 0, 0, width, height);

                            const compressedDataUrl = canvas.toDataURL('image/jpeg', this.compressionQuality);
                            
                            console.log('Image processed:', {
                                originalSize: `${img.width}x${img.height}`,
                                processedSize: `${width}x${height}`,
                                originalFileSize: `${(file.size / 1024).toFixed(1)}KB`,
                                compressedSize: `${(compressedDataUrl.length * 0.75 / 1024).toFixed(1)}KB`
                            });

                            resolve({
                                dataUrl: compressedDataUrl,
                                width,
                                height,
                                originalWidth: img.width,
                                originalHeight: img.height,
                                compressionRatio: file.size / (compressedDataUrl.length * 0.75)
                            });
                        } catch (error) {
                            reject(new Error('Failed to process image: ' + error.message));
                        }
                    };

                    img.onerror = () => {
                        reject(new Error('Failed to load image. Please try a different file.'));
                    };

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        img.src = e.target.result;
                    };
                    reader.onerror = () => {
                        reject(new Error('Failed to read file'));
                    };
                    reader.readAsDataURL(file);
                });
            }

            calculateOptimalSize(originalWidth, originalHeight, maxDimension) {
                if (originalWidth <= maxDimension && originalHeight <= maxDimension) {
                    return { width: originalWidth, height: originalHeight };
                }

                const scaleFactor = Math.min(
                    maxDimension / originalWidth,
                    maxDimension / originalHeight
                );

                return {
                    width: Math.round(originalWidth * scaleFactor),
                    height: Math.round(originalHeight * scaleFactor)
                };
            }
        }

        // Enhanced Mobile HVAC Jack with Web Search for Manuals and Diagnostic Data
        class SecureMobileHVACJack {
            constructor() {
                this.diagnosticsRun = 0;
                this.conversationHistory = [];
                this.currentMode = 'homeowner'; // Single mode - always homeowner
                this.systemContext = {
                    equipmentType: null,
                    brand: null,
                    model: null,
                    serial: null,
                    symptoms: [],
                    previousActions: [],
                    currentProblem: null
                };
                // Backend API endpoints - Netlify Functions
                this.apiEndpoint = '../../../.netlify/functions/chat';
                this.healthEndpoint = '../../../.netlify/functions/health';
                this.trackingEndpoint = '../../../.netlify/functions/track-usage';
                this.photoAnalysisEndpoint = '../../../.netlify/functions/analyze-photo';
                // Note: Manual search now uses the main chat endpoint, not a separate endpoint
                this.isConnected = false;
                this.isProcessing = false;
                this.connectionAttempts = 0;
                this.maxConnectionAttempts = 3;
                
                // Basic rate limiting only
                this.maxMessageLength = 500;
                this.rateLimitWindow = 60000;
                this.maxMessagesPerWindow = 10;
                this.messageTimestamps = [];
                this.sessionId = this.generateSessionId();
                
                // Equipment detection patterns
                this.modelPatterns = [
                    /\b[A-Z]{2,}\d{2,}[A-Z]?\d*[A-Z]?\b/g, // Standard model patterns like 58MXA080, TEM4A0B30H
                    /\b\d{4,}[A-Z]{0,3}\d*\b/g, // Patterns like 0044563, 2000ABV123
                    /\b[A-Z]+\d{2,}[A-Z]*\d*\b/g, // Flexible patterns
                    /\bModel\s*#?\s*:?\s*([A-Z0-9\-]+)/gi, // "Model # 0044563"
                    /\bSerial\s*#?\s*:?\s*([A-Z0-9\-]+)/gi, // "Serial# 4350808"
                    /\b([A-Z]{2,}\d{4,}[A-Z]?)\b/g, // Brand + numbers
                    /\b(#\s*\d{4,})\b/g // # followed by numbers
                ];

                // Brand detection patterns - expanded for all gas appliance manufacturers
                this.brandPatterns = {
                    'carrier': /\b(carrier|bryant)\b/i,
                    'trane': /\b(trane|american standard)\b/i,
                    'lennox': /\b(lennox)\b/i,
                    'york': /\b(york|luxaire|coleman|champion|guardian)\b/i,
                    'rheem': /\b(rheem|ruud|richmond)\b/i,
                    'goodman': /\b(goodman|amana|daikin)\b/i,
                    'coleman': /\b(coleman|evcon)\b/i,
                    'heil': /\b(heil|tempstar|comfortmaker|keeprite)\b/i,
                    'payne': /\b(payne)\b/i,
                    'ducane': /\b(ducane)\b/i,
                    'generac': /\b(generac|guardian|honeywell)\b/i,
                    'kohler': /\b(kohler)\b/i,
                    'briggs': /\b(briggs|stratton)\b/i,
                    'honda': /\b(honda)\b/i,
                    'champion': /\b(champion power)\b/i,
                    'westinghouse': /\b(westinghouse)\b/i,
                    'ao smith': /\b(ao smith|a\.?o\.? smith|smith)\b/i,
                    'bradford white': /\b(bradford white|bradford)\b/i,
                    'state': /\b(state water|state select)\b/i,
                    'whirlpool': /\b(whirlpool)\b/i,
                    'ge': /\b(general electric|ge)\b/i,
                    'american water heater': /\b(american water heater|american standard water)\b/i,
                    'noritz': /\b(noritz)\b/i,
                    'rinnai': /\b(rinnai)\b/i,
                    'navien': /\b(navien)\b/i,
                    'takagi': /\b(takagi)\b/i,
                    'bosch': /\b(bosch|thermotechnology)\b/i,
                    'lochinvar': /\b(lochinvar)\b/i,
                    'weil mclain': /\b(weil mclain|weil-mclain)\b/i,
                    'burnham': /\b(burnham)\b/i,
                    'crown boiler': /\b(crown boiler|crown)\b/i,
                    'peerless': /\b(peerless)\b/i,
                    'slant fin': /\b(slant fin|slant-fin)\b/i,
                    'new yorker': /\b(new yorker)\b/i,
                    'dunkirk': /\b(dunkirk)\b/i,
                    'embassy': /\b(embassy)\b/i,
                    'modine': /\b(modine)\b/i,
                    'sterling': /\b(sterling)\b/i,
                    'reznor': /\b(reznor)\b/i,
                    'trane unit heater': /\b(trane unit heater)\b/i
                };
                
                this.init();
                this.trackSessionStart();
            }

            checkRateLimit() {
                const now = Date.now();
                
                this.messageTimestamps = this.messageTimestamps.filter(
                    timestamp => now - timestamp < this.rateLimitWindow
                );

                if (this.messageTimestamps.length >= this.maxMessagesPerWindow) {
                    return false;
                }

                this.messageTimestamps.push(now);
                return true;
            }

            sanitizeInput(input) {
                return input
                    .replace(/[<>]/g, '')
                    .replace(/javascript:/gi, '')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .substring(0, this.maxMessageLength);
            }

            async trackUsage(eventType, data = {}) {
                try {
                    await fetch(this.trackingEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            eventType,
                            data: {
                                ...data,
                                mode: this.currentMode,
                                conversationLength: this.conversationHistory.length
                            },
                            sessionId: this.sessionId,
                            timestamp: new Date().toISOString()
                        })
                    });
                } catch (error) {
                    console.warn('Usage tracking failed:', error);
                }
            }

            async trackSessionStart() {
                try {
                    await this.trackUsage('session_start', {
                        mode: this.currentMode,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent.substring(0, 50)
                    });
                    console.log('‚úÖ Session started and tracked:', this.sessionId);
                } catch (error) {
                    console.warn('Session tracking failed:', error);
                }
            }

            initializeContentFilters() {
                // Model/Serial number patterns for equipment identification
                this.modelPatterns = [
                    /\b[A-Z]{2,}\d{2,}[A-Z]?\d*[A-Z]?\b/g, // Standard model patterns like 58MXA080, TEM4A0B30H
                    /\b\d{4,}[A-Z]{0,3}\d*\b/g, // Patterns like 0044563, 2000ABV123
                    /\b[A-Z]+\d{2,}[A-Z]*\d*\b/g, // Flexible patterns
                    /\bModel\s*#?\s*:?\s*([A-Z0-9\-]+)/gi, // "Model # 0044563"
                    /\bSerial\s*#?\s*:?\s*([A-Z0-9\-]+)/gi, // "Serial# 4350808"
                    /\b([A-Z]{2,}\d{4,}[A-Z]?)\b/g, // Brand + numbers
                    /\b(#\s*\d{4,})\b/g // # followed by numbers
                ];

                // Brand detection patterns
                this.brandPatterns = {
                    'carrier': /\b(carrier|bryant)\b/i,
                    'trane': /\b(trane|american standard)\b/i,
                    'lennox': /\blennox\b/i,
                    'york': /\byork\b/i,
                    'rheem': /\b(rheem|ruud)\b/i,
                    'goodman': /\b(goodman|amana|daikin)\b/i,
                    'coleman': /\bcoleman\b/i,
                    'heil': /\bheil\b/i,
                    'payne': /\bpayne\b/i,
                    'ducane': /\bducane\b/i,
                    'generac': /\bgenerac\b/i,
                    'kohler': /\bkohler\b/i,
                    'briggs': /\bbriggs\b/i,
                    'honda': /\bhonda\b/i,
                    'champion': /\bchampion\b/i,
                    'westinghouse': /\bwestinghouse\b/i
                };
            }

            // Detect if input contains model/serial numbers that warrant a manual search
            detectEquipmentIdentifiers(input) {
                const identifiers = {
                    models: [],
                    serials: [],
                    brands: [],
                    hasManualRequest: false
                };

                // Check for explicit manual requests
                if (/\b(manual|service manual|installation guide|troubleshooting guide|wiring diagram|schematic|parts list)\b/i.test(input)) {
                    identifiers.hasManualRequest = true;
                }

                // Extract model numbers
                this.modelPatterns.forEach(pattern => {
                    const matches = input.match(pattern);
                    if (matches) {
                        identifiers.models.push(...matches);
                    }
                });

                // Extract brands
                for (const [brand, pattern] of Object.entries(this.brandPatterns)) {
                    if (pattern.test(input)) {
                        identifiers.brands.push(brand);
                    }
                }

                // Look for serial number context
                const serialMatch = input.match(/\bserial\s*:?\s*([A-Z0-9\-]+)/gi);
                if (serialMatch) {
                    identifiers.serials.push(...serialMatch.map(match => 
                        match.replace(/serial\s*:?\s*/gi, '').trim()
                    ));
                }

                return identifiers;
            }

            // Fixed manual search functionality with proper error handling
            async searchForManuals(identifiers, input) {
                let searchAttempted = false;
                
                try {
                    console.log('Manual search triggered - using chat endpoint for web search');
                    console.log('Identifiers found:', identifiers);

                    if (searchAttempted) {
                        console.warn('Manual search already attempted, preventing infinite loop');
                        return this.generateOfflineManualResponse(identifiers, input);
                    }
                    searchAttempted = true;

                    // Show loading message
                    this.showManualSearchLoading();

                    // Format the search as a natural language query for Claude with web search
                    const searchQuery = this.formatManualSearchQuery(identifiers, input);
                    
                    const requestBody = {
                        message: searchQuery,
                        mode: this.currentMode,
                        conversationHistory: [], // Fresh context for manual search
                        systemContext: {
                            equipmentType: identifiers.brands.includes('generac') || identifiers.brands.includes('kohler') ? 'generator' : 'hvac',
                            brand: identifiers.brands[0] || null,
                            model: identifiers.models[0] || null,
                            isManualSearch: true,
                            searchType: 'web_manual_search'
                        },
                        sessionId: this.sessionId
                    };

                    console.log('Sending manual search to chat endpoint:', this.apiEndpoint);
                    console.log('Search query:', searchQuery.substring(0, 100) + '...');

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        console.warn('Manual search timed out after 30 seconds');
                        controller.abort();
                    }, 30000);

                    let response;
                    try {
                        response = await fetch(this.apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(requestBody),
                            signal: controller.signal
                        });
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        throw new Error(`Network request failed: ${fetchError.message}`);
                    }

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text().catch(() => 'Unknown error');
                        throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                    }

                    let result;
                    try {
                        result = await response.json();
                    } catch (parseError) {
                        throw new Error(`Invalid JSON response: ${parseError.message}`);
                    }
                    
                    // Remove loading indicator
                    this.removeManualSearchLoading();
                    
                    console.log('Manual search response received from chat endpoint');
                    
                    // Track successful manual search
                    await this.trackUsage('manual_search_success', {
                        brands: identifiers.brands,
                        models: identifiers.models,
                        usedChatEndpoint: true,
                        responseLength: result.response?.length || 0
                    }).catch(trackError => console.warn('Tracking failed:', trackError));

                    // Display the result from Claude with web search
                    if (result.response && result.response.trim()) {
                        this.addMobileMessage(result.response, 'ai');
                        return result.response;
                    } else {
                        throw new Error('Empty response received from chat endpoint');
                    }

                } catch (error) {
                    console.error('Manual search error (using offline fallback):', error);
                    
                    // Remove loading indicator
                    this.removeManualSearchLoading();
                    
                    // Track failure but don't let tracking errors break the flow
                    this.trackUsage('manual_search_failed', {
                        error: error.message.substring(0, 100),
                        brands: identifiers.brands,
                        models: identifiers.models,
                        endpoint: 'chat',
                        fallbackUsed: true
                    }).catch(trackError => console.warn('Error tracking failed:', trackError));

                    // Use offline fallback
                    const offlineResponse = this.generateOfflineManualResponse(identifiers, input);
                    this.addMobileMessage(offlineResponse, 'ai');
                    return offlineResponse;
                }
            }

            // Helper method to safely remove loading indicator
            removeManualSearchLoading() {
                try {
                    const loading = document.getElementById('manual-search-loading');
                    if (loading && loading.parentNode) {
                        loading.parentNode.removeChild(loading);
                    }
                } catch (error) {
                    console.warn('Failed to remove loading indicator:', error);
                }
            }

            // Format the manual search as a natural language query for Claude with web search
            formatManualSearchQuery(identifiers, originalInput) {
                let query = "Please search the web to find official service manuals, installation guides, and technical documentation for ";
                
                if (identifiers.brands.length > 0 && identifiers.models.length > 0) {
                    query += `${identifiers.brands[0]} model ${identifiers.models[0]}`;
                } else if (identifiers.brands.length > 0) {
                    query += `${identifiers.brands[0]} equipment`;
                } else if (identifiers.models.length > 0) {
                    query += `model ${identifiers.models[0]}`;
                } else {
                    query += "the equipment mentioned";
                }
                
                if (identifiers.serials.length > 0) {
                    query += ` (serial number: ${identifiers.serials[0]})`;
                }
                
                // Enhanced equipment type detection for gas appliances
                let equipmentType = 'equipment';
                if (identifiers.brands.includes('generac') || identifiers.brands.includes('kohler') || /generator/i.test(originalInput)) {
                    equipmentType = 'backup generator system';
                } else if (/\b(furnace|heating|heat)\b/i.test(originalInput)) {
                    equipmentType = 'gas furnace';
                } else if (/\b(water heater|hot water)\b/i.test(originalInput)) {
                    equipmentType = 'gas water heater';
                } else if (/\b(boiler|steam|hydronic)\b/i.test(originalInput)) {
                    equipmentType = 'gas boiler';
                } else if (/\b(unit heater|garage heater|space heater)\b/i.test(originalInput)) {
                    equipmentType = 'gas unit heater';
                } else if (/\b(air condition|ac|cooling|condenser)\b/i.test(originalInput)) {
                    equipmentType = 'air conditioning system';
                } else if (/\b(heat pump|dual fuel)\b/i.test(originalInput)) {
                    equipmentType = 'heat pump system';
                }
                
                query += `. This is a ${equipmentType}`;
                
                query += ". Please search for and provide direct links to:";
                query += "\n‚Ä¢ Official manufacturer service manuals";
                query += "\n‚Ä¢ Installation guides and specifications";
                query += "\n‚Ä¢ Wiring diagrams and schematics";
                query += "\n‚Ä¢ Parts lists and diagrams";
                query += "\n‚Ä¢ Troubleshooting guides";
                query += "\n‚Ä¢ Technical bulletins";
                query += "\n‚Ä¢ Gas connection and venting requirements";
                query += "\n‚Ä¢ Electrical specifications and requirements";
                
                query += "\n\nPlease focus on official manufacturer websites and authoritative technical resources. Provide working download links when available.";
                
                console.log('Formatted manual search query:', query);
                return query;
            }

            showManualSearchLoading() {
                const loadingHtml = `
                    <div class="search-loading">
                        <div class="search-spinner"></div>
                        Searching for manuals and diagnostic data...
                    </div>
                `;
                
                const messagesContainer = document.getElementById('mobileMessages');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = loadingHtml;
                tempDiv.id = 'manual-search-loading';
                messagesContainer.appendChild(tempDiv);
                this.scrollToBottom();

                // Remove loading after 10 seconds max
                setTimeout(() => {
                    const loading = document.getElementById('manual-search-loading');
                    if (loading) loading.remove();
                }, 10000);
            }

            formatManualSearchResults(result, identifiers) {
                // Remove loading indicator
                const loading = document.getElementById('manual-search-loading');
                if (loading) loading.remove();

                if (!result.success || !result.manuals || result.manuals.length === 0) {
                    return this.generateOfflineManualResponse(identifiers, '');
                }

                // Create manual search results display
                const searchResultsHtml = this.createManualSearchResultsHtml(result, identifiers);
                
                // Add to chat
                const messagesContainer = document.getElementById('mobileMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'mobile-message ai';
                
                const avatar = document.createElement('div');
                avatar.className = 'mobile-avatar ai';
                avatar.textContent = 'üìö';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'mobile-message-content';
                messageContent.innerHTML = searchResultsHtml;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                messagesContainer.appendChild(messageDiv);
                
                this.scrollToBottom();

                return `Found ${result.manuals.length} manual(s) and diagnostic resources for your equipment. Check the links above!`;
            }

            createManualSearchResultsHtml(result, identifiers) {
                const brandText = identifiers.brands.length > 0 ? identifiers.brands.join(', ') : 'Equipment';
                const modelText = identifiers.models.length > 0 ? identifiers.models[0] : 'Model';

                let html = `
                    <div class="manual-search-results">
                        <div class="search-header">
                            <div class="search-icon">üìö</div>
                            <div>
                                <div class="search-title">Manual Search Results</div>
                                <div class="search-subtitle">Found ${result.manuals.length} resource(s) for ${brandText} ${modelText}</div>
                            </div>
                        </div>
                `;

                result.manuals.forEach((manual, index) => {
                    html += `
                        <a href="${manual.url}" target="_blank" rel="noopener noreferrer" class="manual-link">
                            <div class="manual-title">
                                ${manual.title || `Manual ${index + 1}`}
                            </div>
                            <div class="manual-description">
                                ${manual.description || manual.type || 'Equipment manual and diagnostic information'}
                                ${manual.fileType ? ` ‚Ä¢ ${manual.fileType.toUpperCase()}` : ''}
                                ${manual.size ? ` ‚Ä¢ ${manual.size}` : ''}
                            </div>
                        </a>
                    `;
                });

                if (result.diagnosticTips) {
                    html += `
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(56, 178, 172, 0.1); border-radius: 8px;">
                            <strong style="color: #38B2AC;">üí° Diagnostic Tips:</strong><br>
                            <div style="color: #A0AEC0; font-size: 0.9rem; margin-top: 0.5rem;">
                                ${result.diagnosticTips.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`;
                return html;
            }

            generateOfflineManualResponse(identifiers, input) {
                const brandText = identifiers.brands.length > 0 ? identifiers.brands[0] : 'your equipment';
                const modelText = identifiers.models.length > 0 ? identifiers.models[0] : '';

                let response = `üîç **Manual Search Results**\n\n`;
                
                if (identifiers.brands.length > 0 || identifiers.models.length > 0) {
                    response += `I detected you're looking for manuals for **${brandText}** ${modelText}.\n\n`;
                    
                    response += `**Recommended Manual Sources:**\n\n`;
                    
                    if (identifiers.brands.includes('generac')) {
                        response += `üîó **Generac Support:** https://www.generac.com/support\n`;
                        response += `‚Ä¢ Official manuals and parts diagrams\n`;
                        response += `‚Ä¢ Troubleshooting guides by model\n\n`;
                    }
                    
                    if (identifiers.brands.includes('kohler')) {
                        response += `üîó **Kohler Power:** https://kohlerpower.com/support\n`;
                        response += `‚Ä¢ Service manuals and parts lists\n`;
                        response += `‚Ä¢ Installation guides\n\n`;
                    }
                    
                    if (identifiers.brands.includes('carrier')) {
                        response += `üîó **Carrier Literature:** https://www.carrier.com/residential/en/us/support/\n`;
                        response += `‚Ä¢ Installation and service manuals\n`;
                        response += `‚Ä¢ Wiring diagrams and specs\n\n`;
                    }
                    
                    if (identifiers.brands.includes('trane')) {
                        response += `üîó **Trane Literature:** https://www.trane.com/residential/en/support/\n`;
                        response += `‚Ä¢ Technical documentation\n`;
                        response += `‚Ä¢ Service and parts manuals\n\n`;
                    }
                    
                    response += `**General Resources:**\n`;
                    response += `üîó **ManualsLib:** https://www.manualslib.com/\n`;
                    response += `üîó **RepairClinic:** https://www.repairclinic.com/\n`;
                    response += `üîó **AppliancePartsPros:** https://www.appliancepartspros.com/\n\n`;
                    
                    if (modelText) {
                        response += `**Search Tips:**\n`;
                        response += `‚Ä¢ Search for "${brandText} ${modelText} manual"\n`;
                        response += `‚Ä¢ Try "${brandText} ${modelText} service manual"\n`;
                        response += `‚Ä¢ Look for "${brandText} ${modelText} installation guide"\n\n`;
                    }
                } else {
                    response += `**To find your equipment manual:**\n\n`;
                    response += `1. **Find your model number** - Usually on the rating plate\n`;
                    response += `2. **Note the brand** - Carrier, Trane, Generac, etc.\n`;
                    response += `3. **Visit manufacturer website** - Most have searchable databases\n`;
                    response += `4. **Try general manual sites** - ManualsLib, RepairClinic\n\n`;
                }
                
                response += `**What I can help with while you search:**\n`;
                response += `‚Ä¢ Common troubleshooting steps\n`;
                response += `‚Ä¢ Safety procedures\n`;
                response += `‚Ä¢ Basic diagnostics\n`;
                response += `‚Ä¢ Parts identification\n\n`;
                response += `Just tell me what specific issue you're having!`;

                return response;
            }

            generateSessionId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            validateInput(input) {
                const validation = {
                    isValid: true,
                    reason: '',
                    category: '',
                    sanitizedInput: input.trim()
                };

                // 1. Length check
                if (input.length > this.maxMessageLength) {
                    validation.isValid = false;
                    validation.reason = `Message too long (${input.length}/${this.maxMessageLength} characters). Please keep questions concise.`;
                    validation.category = 'length';
                    return validation;
                }

                // 2. Rate limiting
                if (!this.checkRateLimit()) {
                    validation.isValid = false;
                    validation.reason = 'Too many messages. Please wait a moment before sending another question.';
                    validation.category = 'rate_limit';
                    return validation;
                }

                // 3. Empty input check
                if (input.trim().length < 3) {
                    validation.isValid = false;
                    validation.reason = 'Please ask a specific question.';
                    validation.category = 'empty';
                    return validation;
                }

                // 4. Check for prohibited content (only serious violations)
                if (/\b(porn|sex|nude|naked|explicit|adult|xxx|nsfw)\b/i.test(input)) {
                    validation.isValid = false;
                    validation.reason = 'Inappropriate content detected.';
                    validation.category = 'prohibited';
                    return validation;
                }

                // 5. Check for large coding requests only
                if (/\b(write|create|build|develop|generate)\s+(large|complex|full|complete|entire)\s+(application|database|website|system)\b/i.test(input)) {
                    validation.isValid = false;
                    validation.reason = 'I can help with HVAC systems rather than large software development projects.';
                    validation.category = 'prohibited';
                    return validation;
                }

                // 6. Check for obvious spam only (very long repeated patterns)
                if (/(.)\1{20,}/.test(input) || /(.{1,5})\1{10,}/.test(input)) {
                    validation.isValid = false;
                    validation.reason = 'This message appears to be spam. Please ask a normal question.';
                    validation.category = 'suspicious';
                    return validation;
                }

                // 7. Basic sanitization
                validation.sanitizedInput = this.sanitizeInput(input);

                return validation;
            }

            sanitizeInput(input) {
                return input
                    .replace(/[<>]/g, '')
                    .replace(/javascript:/gi, '')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .substring(0, this.maxMessageLength);
            }

            checkRateLimit() {
                const now = Date.now();
                
                this.messageTimestamps = this.messageTimestamps.filter(
                    timestamp => now - timestamp < this.rateLimitWindow
                );

                if (this.messageTimestamps.length >= this.maxMessagesPerWindow) {
                    return false;
                }

                this.messageTimestamps.push(now);
                return true;
            }

            generateValidationErrorResponse(validation) {
                const responses = {
                    length: "‚ö†Ô∏è **Message Too Long**\n\nPlease keep your questions shorter and more specific. Try asking about one issue at a time!",
                    
                    rate_limit: "‚è≥ **Slow Down!**\n\nYou're asking questions too quickly. Take a moment to try my suggestions, then come back with updates!",
                    
                    empty: "ü§î **Need More Details**\n\nI need a specific question to help you! Try asking about your heating, cooling, or gas appliance issue.",
                    
                    prohibited: "üîß **Content Restriction**\n\nI can help with HVAC systems, heating, cooling, generators, and gas appliances. Please ask about those topics.",
                    
                    suspicious: "üö® **Invalid Message**\n\nThat message appears to be spam. Please ask a normal question about your equipment."
                };

                return responses[validation.category] || responses.prohibited;
            }

            async trackUsage(eventType, data = {}) {
                try {
                    await fetch(this.trackingEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            eventType,
                            data: {
                                ...data,
                                mode: this.currentMode,
                                conversationLength: this.conversationHistory.length
                            },
                            sessionId: this.sessionId,
                            timestamp: new Date().toISOString()
                        })
                    });
                } catch (error) {
                    console.warn('Usage tracking failed:', error);
                }
            }

            async init() {
                this.setupMobileFeatures();
                this.loadSavedConversation();
                await this.checkBackendConnection();
            }

            setupMobileFeatures() {
                document.addEventListener('touchstart', function() {}, {passive: true});
                
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', this.handleViewportChange.bind(this));
                }
                
                document.addEventListener('touchmove', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, {passive: false});
                
                this.setupAutoScroll();
                this.setupHapticFeedback();
            }

            handleViewportChange() {
                const viewport = window.visualViewport;
                document.documentElement.style.setProperty('--viewport-height', `${viewport.height}px`);
                
                setTimeout(() => {
                    document.getElementById('mobileInput').scrollIntoView({behavior: 'smooth', block: 'nearest'});
                }, 100);
            }

            setupAutoScroll() {
                this.messagesContainer = document.getElementById('mobileMessages');
                this.observer = new MutationObserver(() => {
                    this.scrollToBottom();
                });
                this.observer.observe(this.messagesContainer, {childList: true});
            }

            setupHapticFeedback() {
                this.hapticFeedback = (type = 'light') => {
                    if (navigator.vibrate) {
                        const patterns = {
                            light: [10],
                            medium: [20],
                            heavy: [30],
                            success: [10, 50, 10]
                        };
                        navigator.vibrate(patterns[type] || patterns.light);
                    }
                };
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }, 100);
            }

            loadSavedConversation() {
                const saved = localStorage.getItem('hvacJackMobileConversation');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.conversationHistory = data.history || [];
                        this.systemContext = data.context || this.systemContext;
                        this.updateMobileMemoryDisplay();
                    } catch (error) {
                        console.log('Could not load saved conversation');
                    }
                }
            }

            saveConversation() {
                const data = {
                    history: this.conversationHistory,
                    context: this.systemContext,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('hvacJackMobileConversation', JSON.stringify(data));
            }

            addToConversation(role, content) {
                this.conversationHistory.push({
                    role: role,
                    content: content,
                    timestamp: new Date().toISOString(),
                    mode: this.currentMode
                });
                
                if (this.conversationHistory.length > 20) {
                    this.conversationHistory = this.conversationHistory.slice(-20);
                }
                
                this.updateMobileMemoryDisplay();
                this.saveConversation();
            }

            updateMobileMemoryDisplay() {
                document.getElementById('mobileMessageCount').textContent = this.conversationHistory.length;
                document.getElementById('mobileSystemType').textContent = this.systemContext.equipmentType || 'Unknown';
                document.getElementById('mobileProblemType').textContent = this.systemContext.currentProblem || 'Diagnosing';
                
                const summary = this.conversationHistory.length > 0 
                    ? `üß† Remembering: ${this.systemContext.equipmentType || 'system'} ${this.systemContext.currentProblem || 'issue'}`
                    : 'üß† New conversation - Jack is learning about your system';
                    
                document.getElementById('mobileContextSummary').textContent = summary;
            }

            extractSystemContext(userInput) {
                const input = userInput.toLowerCase();
                
                // Enhanced equipment type detection for all gas appliances
                if (input.includes('furnace') || input.includes('heating unit')) this.systemContext.equipmentType = 'gas furnace';
                else if (input.includes('water heater') || input.includes('hot water')) this.systemContext.equipmentType = 'gas water heater';
                else if (input.includes('boiler') || input.includes('steam') || input.includes('hydronic')) this.systemContext.equipmentType = 'gas boiler';
                else if (input.includes('unit heater') || input.includes('garage heater') || input.includes('space heater')) this.systemContext.equipmentType = 'gas unit heater';
                else if (input.includes('air condition') || input.includes('ac ') || input.includes('cooling')) this.systemContext.equipmentType = 'air conditioner';
                else if (input.includes('heat pump') || input.includes('dual fuel')) this.systemContext.equipmentType = 'heat pump';
                else if (input.includes('generator') || input.includes('standby') || input.includes('backup power')) this.systemContext.equipmentType = 'generator';
                else if (input.includes('range') || input.includes('stove') || input.includes('cooktop')) this.systemContext.equipmentType = 'gas range';
                else if (input.includes('dryer') || input.includes('clothes dryer')) this.systemContext.equipmentType = 'gas dryer';
                else if (input.includes('fireplace') || input.includes('gas log')) this.systemContext.equipmentType = 'gas fireplace';
                
                // Enhanced problem detection
                if (input.includes('no heat') || input.includes('not heating')) this.systemContext.currentProblem = 'no heat';
                else if (input.includes('no hot water') || input.includes('cold water')) this.systemContext.currentProblem = 'no hot water';
                else if (input.includes('no cool') || input.includes('not cooling')) this.systemContext.currentProblem = 'no cooling';
                else if (input.includes('noise') || input.includes('sound') || input.includes('loud')) this.systemContext.currentProblem = 'strange noises';
                else if (input.includes('frozen') || input.includes('ice')) this.systemContext.currentProblem = 'frozen system';
                else if (input.includes('cycling') || input.includes('short cycle')) this.systemContext.currentProblem = 'short cycling';
                else if (input.includes('won\'t start') || input.includes('not starting') || input.includes('no ignition')) this.systemContext.currentProblem = 'won\'t start';
                else if (input.includes('gas smell') || input.includes('smell gas')) this.systemContext.currentProblem = 'gas odor - SAFETY ISSUE';
                else if (input.includes('pilot') || input.includes('flame')) this.systemContext.currentProblem = 'pilot/flame issue';
                else if (input.includes('leak') || input.includes('water')) this.systemContext.currentProblem = 'water leak';
                else if (input.includes('error') || input.includes('code') || input.includes('fault')) this.systemContext.currentProblem = 'error code';
            }

            async checkBackendConnection() {
                this.updateMobileStatus('connecting', 'Connecting to Jack...');
                this.connectionAttempts++;
                
                try {
                    console.log(`Attempting to connect to: ${this.healthEndpoint}`);
                    console.log(`Connection attempt ${this.connectionAttempts}/${this.maxConnectionAttempts}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    const response = await fetch(this.healthEndpoint, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Health check response:', data);
                        
                        if (data.claudeConfigured) {
                            this.isConnected = true;
                            this.connectionAttempts = 0;
                            this.updateMobileStatus('connected', 'Jack is ready!');
                            this.hapticFeedback('success');
                            
                            await this.trackUsage('connection_success', {
                                attempts: this.connectionAttempts
                            });
                            
                            const existingErrors = document.querySelectorAll('.connection-error');
                            existingErrors.forEach(error => error.remove());
                        } else {
                            throw new Error('Claude API not configured on server');
                        }
                        
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Connection error details:', {
                        name: error.name,
                        message: error.message,
                        endpoint: this.healthEndpoint,
                        attempt: this.connectionAttempts
                    });
                    this.handleConnectionFailure(error);
                }
            }

            handleConnectionFailure(error) {
                this.isConnected = false;
                
                if (this.connectionAttempts < this.maxConnectionAttempts) {
                    this.updateMobileStatus('connecting', `Retrying... (${this.connectionAttempts}/${this.maxConnectionAttempts})`);
                    setTimeout(() => this.checkBackendConnection(), 3000);
                    return;
                }
                
                this.updateMobileStatus('error', 'Connection Failed');
                
                this.trackUsage('connection_failed', {
                    error: error.message,
                    attempts: this.connectionAttempts
                });
                
                let errorMessage = '‚ö†Ô∏è **Cannot Connect to HVAC Jack Server**\n\n';
                
                if (error.name === 'AbortError') {
                    errorMessage += '**Issue:** Connection timeout\n';
                    errorMessage += '**Using offline mode with built-in HVAC knowledge**\n\n';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage += '**Issue:** Network connection failed\n';
                    errorMessage += '**Using offline mode with built-in HVAC knowledge**\n\n';
                } else if (error.message.includes('Claude API not configured')) {
                    errorMessage += '**Issue:** Server running but Claude API not configured\n';
                    errorMessage += '**Using offline mode with built-in HVAC knowledge**\n\n';
                } else {
                    errorMessage += `**Issue:** ${error.message}\n\n`;
                }
                
                errorMessage += '**I can still help you!** I have extensive built-in HVAC knowledge for common problems.\n\n';
                errorMessage += '**Ask me about:**\n';
                errorMessage += '‚Ä¢ No heat or cooling issues\n';
                errorMessage += '‚Ä¢ Strange noises or smells\n';
                errorMessage += '‚Ä¢ Thermostat problems\n';
                errorMessage += '‚Ä¢ Basic troubleshooting steps\n';
                errorMessage += '‚Ä¢ Manual searches (offline mode)\n\n';
                errorMessage += '*AI features will return when connection is restored*';
                
                this.addMobileMessage(errorMessage, 'ai');
            }

            updateMobileStatus(status, message) {
                const dot = document.getElementById('mobileStatusDot');
                const text = document.getElementById('mobileStatusText');
                
                dot.className = `mobile-status-dot ${status}`;
                text.textContent = message;
            }

            // Robust processUserInput method with comprehensive error handling
            async processUserInput(input) {
                if (this.isProcessing) {
                    console.warn('Already processing input, ignoring duplicate request');
                    return { text: "Please wait for the current request to complete.", isError: true };
                }

                // Set processing flag immediately to prevent race conditions
                this.isProcessing = true;
                let processingStarted = true;

                try {
                    // Basic validation only - length, rate limiting, empty check
                    if (input.length > this.maxMessageLength) {
                        const errorResponse = `‚ö†Ô∏è **Message Too Long**\n\nPlease keep your questions shorter (${input.length}/${this.maxMessageLength} characters).`;
                        this.addMobileMessage(errorResponse, 'ai');
                        return { text: errorResponse, isError: true };
                    }

                    if (!this.checkRateLimit()) {
                        const errorResponse = "‚è≥ **Slow Down!**\n\nToo many messages. Please wait a moment before sending another question.";
                        this.addMobileMessage(errorResponse, 'ai');
                        return { text: errorResponse, isError: true };
                    }

                    if (input.trim().length < 3) {
                        const errorResponse = "ü§î **Need More Details**\n\nPlease ask a specific question about your HVAC system, generator, or gas appliance.";
                        this.addMobileMessage(errorResponse, 'ai');
                        return { text: errorResponse, isError: true };
                    }

                    const sanitizedInput = this.sanitizeInput(input);

                    // Track message being sent
                    try {
                        await this.trackUsage('message_sent', {
                            inputLength: sanitizedInput.length,
                            mode: this.currentMode,
                            messageCount: this.conversationHistory.length,
                            message: sanitizedInput.substring(0, 100)
                        });
                    } catch (trackError) {
                        console.warn('Message tracking failed:', trackError);
                    }

                    this.showMobileTyping();
                    this.addToConversation('user', sanitizedInput);
                    this.extractSystemContext(sanitizedInput);
                    
                    const startTime = Date.now();
                    
                    // Check if input contains equipment identifiers for manual search
                    const identifiers = this.detectEquipmentIdentifiers(sanitizedInput);
                    const shouldSearchManuals = identifiers.hasManualRequest || 
                                              identifiers.models.length > 0 || 
                                              (identifiers.brands.length > 0 && 
                                               /\b(manual|service|installation|troubleshooting|diagnostic|wiring|schematic)\b/i.test(sanitizedInput));

                    let response;
                    let manualSearchPerformed = false;

                    if (shouldSearchManuals) {
                        // Manual search path
                        console.log('Manual search triggered for:', identifiers);
                        manualSearchPerformed = true;
                        
                        this.hideMobileTyping();
                        
                        try {
                            // Perform manual search - displays results directly
                            const searchResult = await this.searchForManuals(identifiers, sanitizedInput);
                            
                            // Add follow-up message
                            const followUpMessage = this.generateManualSearchFollowUp(identifiers);
                            this.addMobileMessage(followUpMessage, 'ai');
                            
                            this.addToConversation('assistant', `Manual search completed. ${followUpMessage}`);
                            
                            this.diagnosticsRun++;
                            this.hapticFeedback('success');
                            
                            const responseTime = (Date.now() - startTime) / 1000;
                            
                            try {
                                await this.trackUsage('response_received', {
                                    responseTime: responseTime,
                                    responseLength: followUpMessage.length,
                                    usingAI: this.isConnected,
                                    mode: this.currentMode,
                                    manualSearchPerformed: true
                                });
                            } catch (trackError) {
                                console.warn('Response tracking failed:', trackError);
                            }
                            
                            return { text: followUpMessage, isError: false, manualSearchPerformed: true };
                            
                        } catch (searchError) {
                            console.error('Manual search failed completely:', searchError);
                            
                            // Fall back to regular processing if manual search fails
                            if (this.isConnected) {
                                response = await this.sendToBackend(sanitizedInput);
                            } else {
                                response = await this.processWithFallbackKnowledge(sanitizedInput);
                            }
                        }
                        
                    } else {
                        // Regular processing path
                        try {
                            if (this.isConnected) {
                                response = await this.sendToBackend(sanitizedInput);
                            } else {
                                response = await this.processWithFallbackKnowledge(sanitizedInput);
                            }
                        } catch (backendError) {
                            console.error('Backend processing failed:', backendError);
                            // Use fallback knowledge as last resort
                            response = await this.processWithFallbackKnowledge(sanitizedInput);
                        }
                        
                        const responseTime = (Date.now() - startTime) / 1000;
                        
                        this.addToConversation('assistant', response);
                        this.hideMobileTyping();
                        this.diagnosticsRun++;
                        this.hapticFeedback('success');
                        
                        try {
                            await this.trackUsage('response_received', {
                                responseTime: responseTime,
                                responseLength: response.length,
                                usingAI: this.isConnected,
                                mode: this.currentMode,
                                manualSearchPerformed: false
                            });
                        } catch (trackError) {
                            console.warn('Response tracking failed:', trackError);
                        }
                        
                        return { text: response, isError: false, manualSearchPerformed: false };
                    }
                    
                } catch (error) {
                    console.error('Critical processing error:', error);
                    this.hideMobileTyping();
                    this.hapticFeedback('heavy');
                    
                    const responseTime = processingStarted ? (Date.now() - Date.now()) / 1000 : 0;
                    
                    try {
                        await this.trackUsage('processing_error', {
                            error: error.message.substring(0, 200),
                            responseTime: responseTime,
                            usingAI: this.isConnected
                        });
                    } catch (trackError) {
                        console.warn('Error tracking failed:', trackError);
                    }
                    
                    // Connection recovery logic
                    if (this.isConnected && error.message.includes('fetch')) {
                        this.isConnected = false;
                        this.updateMobileStatus('error', 'Connection lost');
                        setTimeout(() => this.checkBackendConnection(), 2000);
                    }
                    
                    // Generate safe fallback response
                    let fallback;
                    try {
                        fallback = await this.processWithFallbackKnowledge(input);
                    } catch (fallbackError) {
                        console.error('Even fallback failed:', fallbackError);
                        fallback = "I'm having technical difficulties. Please try asking your question again, or check your network connection.";
                    }
                    
                    this.addToConversation('assistant', fallback + '\n\n*Note: Using offline mode due to technical issue.*');
                    return { text: fallback, isError: false };
                    
                } finally {
                    // Always reset processing flag
                    this.isProcessing = false;
                }
            }

            // Generate a follow-up response after manual search
            generateManualSearchFollowUp(identifiers) {
                const brandText = identifiers.brands.length > 0 ? identifiers.brands[0] : 'equipment';
                const modelText = identifiers.models.length > 0 ? identifiers.models[0] : '';

                if (this.currentMode === 'technician') {
                    return `üìö **Manual search completed for ${brandText} ${modelText}**\n\nNow that you have the documentation, what specific diagnostic issue are you working on?\n\n**Common areas to check:**\n‚Ä¢ Control board error codes\n‚Ä¢ Electrical measurements\n‚Ä¢ Gas pressure readings\n‚Ä¢ Safety switch operations\n‚Ä¢ Sensor calibrations\n\nWhat symptoms or fault codes are you seeing?`;
                } else {
                    return `üìö **Found manuals for your ${brandText} ${modelText}**\n\nWith the documentation above, I can help you with:\n\n**Safe troubleshooting steps**\n‚Ä¢ Understanding error codes\n‚Ä¢ Basic maintenance procedures\n‚Ä¢ When to call for service\n‚Ä¢ Safety precautions\n\nWhat specific problem are you experiencing with this unit?`;
                }
            }

            // Robust backend communication with comprehensive error handling
            async sendToBackend(input) {
                const requestBody = {
                    message: input,
                    mode: this.currentMode,
                    conversationHistory: this.conversationHistory.slice(-10),
                    systemContext: this.systemContext,
                    sessionId: this.sessionId
                };

                console.log('Sending to backend:', this.apiEndpoint);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.warn('Backend request timed out');
                    controller.abort();
                }, 30000);
                
                try {
                    const response = await fetch(this.apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        let errorText;
                        try {
                            errorText = await response.text();
                        } catch (textError) {
                            errorText = `HTTP ${response.status}`;
                        }
                        throw new Error(`Backend error: ${response.status} ${response.statusText} - ${errorText.substring(0, 200)}`);
                    }

                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        throw new Error(`Invalid JSON response from backend: ${parseError.message}`);
                    }
                    
                    console.log('Backend response received:', {
                        responseLength: data.response?.length || 0,
                        sessionId: data.sessionId,
                        usingAI: data.usingAI,
                        responseTime: data.responseTime
                    });
                    
                    if (data.fallback) {
                        console.warn('Server returned fallback response');
                    }
                    
                    const responseText = data.response || data.message;
                    if (!responseText || !responseText.trim()) {
                        throw new Error('Empty response received from backend');
                    }
                    
                    return responseText;
                } catch (error) {
                    clearTimeout(timeoutId);
                    
                    if (error.name === 'AbortError') {
                        throw new Error('Backend request timed out after 30 seconds');
                    }
                    
                    throw error;
                }
            }

            async processWithFallbackKnowledge(input) {
                await this.delay(1000);
                
                const analysis = this.analyzeInput(input);
                return this.generateFallbackResponse(analysis, input);
            }

            analyzeInput(input) {
                const inputLower = input.toLowerCase();
                return {
                    systemType: this.detectSystemType(inputLower),
                    problemType: this.detectProblemType(inputLower),
                    isFollowUp: this.conversationHistory.length > 1
                };
            }

            detectSystemType(input) {
                if (input.includes('furnace')) return 'furnace';
                if (input.includes('ac ') || input.includes('air condition')) return 'airConditioner';
                if (input.includes('water heater')) return 'waterHeater';
                if (input.includes('generator')) return 'generator';
                return this.systemContext.equipmentType;
            }

            detectProblemType(input) {
                if (input.includes('no heat')) return 'noHeat';
                if (input.includes('no cool') || input.includes('not cooling')) return 'noCooling';
                if (input.includes('noise')) return 'noise';
                if (input.includes('frozen')) return 'frozenCoil';
                if (input.includes('cycling')) return 'shortCycling';
                if (input.includes('won\'t start')) return 'wontStart';
                return 'general';
            }

            generateFallbackResponse(analysis, input) {
                const contextInfo = this.conversationHistory.length > 1 
                    ? `(I remember: ${this.systemContext.equipmentType || 'your system'} with ${this.systemContext.currentProblem || 'issues'}) `
                    : '';

                if (this.currentMode === 'homeowner') {
                    return this.generateFallbackHomeownerResponse(analysis, contextInfo);
                } else {
                    return this.generateFallbackTechResponse(analysis, contextInfo);
                }
            }

            generateFallbackHomeownerResponse(analysis, contextInfo) {
                const responses = {
                    noHeat: `**No heat problem! ${contextInfo}**

**Quick checks:**
üì± Set thermostat 5¬∞F higher
üîã Replace thermostat batteries
‚ö° Check circuit breaker
üå™Ô∏è Replace air filter
üîß Listen for startup sounds

**STOP if you smell gas!** Call gas company immediately.

**Most likely:** Dead batteries (30% of my calls!) or dirty filter.

Try these and tell me what happens! üëç`,

                    noCooling: `**AC not cooling! ${contextInfo}**

**Start here:**
‚ùÑÔ∏è Set thermostat to COOL, 5¬∞F lower
üå™Ô∏è Replace dirty air filter (BIG cause!)
‚ö° Check both circuit breakers 
üè† Clean outdoor unit with hose
üëÄ All vents open and unblocked?

**Red flag:** Ice anywhere = turn OFF cooling!

**Quick test:** Any cool air from vents at all?

What did you find? üîç`,

                    wontStart: `**Equipment won't start! ${contextInfo}**

**Safety first:**
üö® Gas smell = call gas company immediately
‚ö° No power = check main breaker

**For generators:**
üîã Check battery connections
‚õΩ Verify fuel levels
üîß Oil level check
üîå Transfer switch position

**For HVAC:**
üì± Thermostat settings
üîã Battery replacement
üå™Ô∏è Air filter check

What type of equipment and what happens when you try to start it?`,

                    general: `**HVAC/Generator issue! ${contextInfo}**

**Tell me:**
üîß What type of system?
‚ùì What's it doing (or not doing)?
üìÖ When did this start?
üëÇ Any weird sounds or smells?

**Safety first:**
üö® Gas smell = call gas company
üíß Water leaking = turn off system  
‚ö° Sparks/burning = turn off power

**I can help with:**
üì∏ Photo analysis of rating plates
üîç Manual searches for service documentation
üõ†Ô∏è Troubleshooting steps

What's going on? I'm here to help! üòä`
                };

                return responses[analysis.problemType] || responses.general;
            }

            generateFallbackTechResponse(analysis, contextInfo) {
                const responses = {
                    noHeat: `**No heat diagnostic ${contextInfo}**

**Sequence check:**
‚ö° 24VAC R-W at unit
üî• HSI: 11-200Œ©, 3.2-3.6A draw  
üìä Gas: 3.5"WC NG, 11"WC LP
üëÅÔ∏è Flame sensor: 2-5ŒºA DC
üå™Ô∏è Pressure switch closure timing
üö® Limit switch continuity

**Tools:** DMM, manometer, ŒºA meter

**Common failures:**
- Control board fuses
- HSI cracked/high resistance  
- Flame sensor contamination
- Pressure switch tubing

Current symptoms and test results?`,

                    noCooling: `**No cooling diagnostic ${contextInfo}**

**Power/electrical:**
‚ö° 240VAC at disconnect
üìä Compressor/fan amp draws
üîã Start/run capacitor ŒºF
üîå Contactor pull-in voltage

**Refrigerant (EPA req'd):**
‚ùÑÔ∏è Suction/discharge pressures
üå°Ô∏è Superheat/subcooling calc
üíß Leak detection (oil spots)

**Airflow:**
üìè Static pressure measurement
üå™Ô∏è CFM verification
üîß Blower wheel/motor inspection

Current readings and observations?`,

                    wontStart: `**No start diagnostic ${contextInfo}**

**For generators:**
üîã Battery voltage (12.6V+ no load)
‚ö° Control panel display codes
üîß Engine oil pressure switch
‚õΩ Fuel solenoid operation
üì° Transfer switch signals

**For HVAC:**
‚ö° Control voltage (24VAC)
üîß Safety switch positions
üìä Thermostat call verification
üîã Low voltage transformer output

**Common causes:**
- Dead battery (generators)
- Control transformer failure
- Open safety switches
- Loose wire connections

What equipment and what are your readings?`,

                    general: `**Tech diagnostic mode ${contextInfo}**

**Need:**
üîã Model/serial numbers
üìä Current measurements
üîß Specific failure point
‚ö° Test equipment available

**Standard approach:**
1. Electrical verification
2. Pressure/temperature readings  
3. Sequence timing analysis
4. Component isolation testing

What's your current diagnostic status?`
                };

                return responses[analysis.problemType] || responses.general;
            }

            showMobileTyping() {
                document.getElementById('mobileTyping').style.display = 'flex';
                document.getElementById('mobileSendBtn').disabled = true;
                this.scrollToBottom();
            }

            hideMobileTyping() {
                document.getElementById('mobileTyping').style.display = 'none';
                document.getElementById('mobileSendBtn').disabled = false;
            }

            // switchMode method removed - single homeowner mode only

            updateWelcomeMessage(mode) {
                const welcomeElement = document.getElementById('mobileWelcomeMessage');
                if (welcomeElement) {
                    if (mode === 'homeowner') {
                        welcomeElement.innerHTML = `
                            <strong>Hey! I'm HVAC Jack!</strong><br><br>
                            üè† <strong>Homeowner Mode</strong> - I'll explain things simply and focus on safe DIY steps.<br><br>
                            üì∏ <strong>NEW: Rating Plate Analysis!</strong> - Take a photo of your equipment's rating plate for detailed specs, warranty info, and capacitor requirements!<br><br>
                            üîç <strong>Manual Search!</strong> - Give me a make/model/serial number and I'll find manuals and diagnostic data online!<br><br>
                            üí≠ <strong>I Remember Everything</strong> - No need to repeat yourself as we chat!<br><br>
                            <strong>What's wrong with your heating or cooling?</strong>
                        `;
                    } else {
                        welcomeElement.innerHTML = `
                            <strong>HVAC Jack - Technician Mode</strong><br><br>
                            üîß <strong>Professional Mode</strong> - Technical specs, measurements, and diagnostic procedures.<br><br>
                            üì∏ <strong>Rating Plate Analysis</strong> - Photo analysis provides exact capacitor specs, warranty status, and equipment details.<br><br>
                            üîç <strong>Manual Search</strong> - Automatic web search for service manuals, wiring diagrams, and diagnostic data when you provide model numbers.<br><br>
                            üí≠ <strong>Conversation Memory</strong> - I'll build on our diagnostic history.<br><br>
                            <strong>What system are you diagnosing? Include model info and current readings.</strong>
                        `;
                    }
                }
            }

            addMobileMessage(content, sender) {
                const messagesContainer = document.getElementById('mobileMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `mobile-message ${sender}`;
                
                const avatar = document.createElement('div');
                avatar.className = `mobile-avatar ${sender}`;
                avatar.textContent = sender === 'user' ? 'üë§' : 'üîß';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'mobile-message-content';
                
                if (sender === 'ai') {
                    let formattedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n\n/g, '<br><br>')
                        .replace(/\n/g, '<br>');
                    messageContent.innerHTML = formattedContent;
                } else {
                    messageContent.textContent = content;
                }
                
                if (sender === 'user') {
                    messageDiv.appendChild(messageContent);
                    messageDiv.appendChild(avatar);
                } else {
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(messageContent);
                }
                
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            async delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Mobile-specific functions
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function handleMobileKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMobileMessage();
            }
        }

        // Enhanced message sending with better error handling and iframe prevention
        async function sendMobileMessage() {
            if (!window.mobileHvacJack) {
                console.error('HVAC Jack not initialized');
                return;
            }
            
            const input = document.getElementById('mobileInput');
            if (!input) {
                console.error('Input element not found');
                return;
            }
            
            const message = input.value.trim();
            
            if (!message || window.mobileHvacJack.isProcessing) return;

            // Prevent potential iframe navigation issues by sanitizing input
            const sanitizedMessage = message.replace(/javascript:/gi, '').replace(/data:/gi, '');

            window.mobileHvacJack.hapticFeedback('light');
            addMobileMessage(sanitizedMessage, 'user');
            input.value = '';
            input.style.height = 'auto';

            try {
                const response = await window.mobileHvacJack.processUserInput(sanitizedMessage);
                
                // Manual search handles its own messaging, only add for non-manual-search responses
                if (!response.manualSearchPerformed && !response.isError) {
                    addMobileMessage(response.text, 'ai');
                } else if (response.isError) {
                    // Error messages are already added by processUserInput
                    console.warn('Input validation error:', response.text);
                }
                
            } catch (error) {
                console.error('Critical error in sendMobileMessage:', error);
                addMobileMessage('‚ùå Sorry! Something went wrong. Please try again or refresh the page.', 'ai');
                window.mobileHvacJack.hapticFeedback('heavy');
                
                // Reset processing state if it gets stuck
                if (window.mobileHvacJack.isProcessing) {
                    window.mobileHvacJack.isProcessing = false;
                }
            }
        }

        // Enhanced message display with better error handling
        function addMobileMessage(content, sender) {
            if (!content || typeof content !== 'string') {
                console.warn('Invalid message content:', content);
                return;
            }

            try {
                const messagesContainer = document.getElementById('mobileMessages');
                if (!messagesContainer) {
                    console.error('Messages container not found');
                    return;
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `mobile-message ${sender}`;
                messageDiv.setAttribute('data-timestamp', Date.now());
                
                const avatar = document.createElement('div');
                avatar.className = `mobile-avatar ${sender}`;
                avatar.textContent = sender === 'user' ? 'üë§' : 'üîß';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'mobile-message-content';
                
                if (sender === 'ai') {
                    // Safely format AI messages, preventing any potential script injection
                    let formattedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n\n/g, '<br><br>')
                        .replace(/\n/g, '<br>')
                        .replace(/javascript:/gi, '')
                        .replace(/data:/gi, '');
                    messageContent.innerHTML = formattedContent;
                } else {
                    // Use textContent for user messages to prevent any script execution
                    messageContent.textContent = content;
                }
                
                if (sender === 'user') {
                    messageDiv.appendChild(messageContent);
                    messageDiv.appendChild(avatar);
                } else {
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(messageContent);
                }
                
                messagesContainer.appendChild(messageDiv);
                
                if (window.mobileHvacJack && typeof window.mobileHvacJack.scrollToBottom === 'function') {
                    window.mobileHvacJack.scrollToBottom();
                }
            } catch (error) {
                console.error('Error adding mobile message:', error);
            }
        }

        function quickQuestion(question) {
            document.getElementById('mobileInput').value = question;
            sendMobileMessage();
        }

        // switchMode function removed - single mode only

        function toggleContext() {
            const details = document.getElementById('mobileContextDetails');
            const bar = document.getElementById('mobileContextBar');
            
            details.classList.toggle('show');
            bar.classList.toggle('expanded');
            if (window.mobileHvacJack) {
                window.mobileHvacJack.hapticFeedback('light');
            }
        }

        function showMobileMenu() {
            if (confirm('Clear conversation and start fresh?')) {
                clearMobileConversation();
            }
        }

        function clearMobileConversation() {
            if (!window.mobileHvacJack) return;
            
            window.mobileHvacJack.trackUsage('conversation_cleared', {
                messageCount: window.mobileHvacJack.conversationHistory.length
            });
            
            window.mobileHvacJack.conversationHistory = [];
            window.mobileHvacJack.systemContext = {
                equipmentType: null,
                brand: null,
                model: null,
                serial: null,
                symptoms: [],
                previousActions: [],
                currentProblem: null
            };
            
            localStorage.removeItem('hvacJackMobileConversation');
            
            document.getElementById('mobileMessages').innerHTML = `
                <div class="mobile-message ai">
                    <div class="mobile-avatar ai">üîß</div>
                    <div class="mobile-message-content" id="mobileWelcomeMessage">
                        ${window.mobileHvacJack.currentMode === 'homeowner' ? 
                            '<strong>Hey! I\'m HVAC Jack!</strong><br><br>üè† <strong>Homeowner Mode</strong> - I\'ll explain things simply and focus on safe DIY steps.<br><br>üì∏ <strong>NEW: Rating Plate Analysis!</strong> - Take a photo of your equipment\'s rating plate for detailed specs, warranty info, and capacitor requirements!<br><br>üîç <strong>Manual Search!</strong> - Give me a make/model/serial number and I\'ll find manuals and diagnostic data online!<br><br>üí≠ <strong>I Remember Everything</strong> - No need to repeat yourself as we chat!<br><br><strong>What\'s wrong with your heating or cooling?</strong>' :
                            '<strong>HVAC Jack - Technician Mode</strong><br><br>üîß <strong>Professional Mode</strong> - Technical specs, measurements, and diagnostic procedures.<br><br>üì∏ <strong>Rating Plate Analysis</strong> - Photo analysis provides exact capacitor specs, warranty status, and equipment details.<br><br>üîç <strong>Manual Search</strong> - Automatic web search for service manuals, wiring diagrams, and diagnostic data when you provide model numbers.<br><br>üí≠ <strong>Conversation Memory</strong> - I\'ll build on our diagnostic history.<br><br><strong>What system are you diagnosing? Include model info and current readings.</strong>'
                        }
                    </div>
                </div>
            `;
            
            window.mobileHvacJack.updateMobileMemoryDisplay();
            window.mobileHvacJack.hapticFeedback('success');
        }
    </script>
    <!-- Enhanced fix for clickable and selectable manual links -->
<style>
/* Override the global user-select: none for manual search results */
.mobile-message-content {
    -webkit-user-select: text !important;
    user-select: text !important;
}

.mobile-message-content a {
    color: #4A90E2 !important;
    text-decoration: underline !important;
    cursor: pointer !important;
    -webkit-user-select: text !important;
    user-select: text !important;
}

/* Make manual URLs specifically selectable */
.mobile-message-content *[href],
.mobile-message-content a,
.mobile-message-content .manual-url {
    -webkit-user-select: text !important;
    user-select: text !important;
    cursor: text !important;
}

/* Override for any text that contains "http" */
.mobile-message-content *:contains("http") {
    -webkit-user-select: text !important;
    user-select: text !important;
}
</style>

<script>
// Enhanced text selection and link creation
function makeTextSelectableAndClickable() {
  console.log('Making text selectable and clickable...');
  
  // Find all message containers
  const messageContainers = document.querySelectorAll('.mobile-message-content');
  
  messageContainers.forEach(container => {
    // Force text selection
    container.style.userSelect = 'text';
    container.style.webkitUserSelect = 'text';
    container.style.mozUserSelect = 'text';
    container.style.msUserSelect = 'text';
    container.style.cursor = 'text';
    
    // Find all text nodes and make URLs clickable
    const walker = document.createTreeWalker(
      container,
      NodeFilter.SHOW_TEXT,
      null,
      false
    );
    
    const textNodes = [];
    let node;
    while (node = walker.nextNode()) {
      textNodes.push(node);
    }
    
    textNodes.forEach(textNode => {
      const text = textNode.textContent;
      const urlRegex = /(https?:\/\/[^\s\)\]]+)/g;
      
      if (urlRegex.test(text)) {
        console.log('Found URL in text:', text);
        
        // Create a span to replace the text node
        const span = document.createElement('span');
        span.style.userSelect = 'text';
        span.style.webkitUserSelect = 'text';
        
        // Replace URLs with clickable links
        const newHTML = text.replace(urlRegex, (url) => {
          return `<a href="${url}" target="_blank" style="color: #4A90E2 !important; text-decoration: underline !important; cursor: pointer !important; user-select: text !important; -webkit-user-select: text !important;">${url}</a>`;
        });
        
        span.innerHTML = newHTML;
        textNode.parentNode.replaceChild(span, textNode);
      }
    });
    
    // Make the entire container selectable
    container.addEventListener('selectstart', function(e) {
      e.stopPropagation();
    });
  });
}

// Run immediately and on any changes
function runEnhancement() {
  makeTextSelectableAndClickable();
  
  // Also try to override the global CSS
  const style = document.createElement('style');
  style.textContent = `
    .mobile-message-content, 
    .mobile-message-content * {
      -webkit-user-select: text !important;
      user-select: text !important;
    }
  `;
  document.head.appendChild(style);
}

// Multiple triggers to ensure it works
document.addEventListener('DOMContentLoaded', runEnhancement);
setTimeout(runEnhancement, 1000);
setTimeout(runEnhancement, 3000);

// Watch for new messages
const observer = new MutationObserver(function(mutations) {
  let shouldRun = false;
  mutations.forEach(function(mutation) {
    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
      shouldRun = true;
    }
  });
  
  if (shouldRun) {
    setTimeout(runEnhancement, 200);
  }
});

// Start observing
const chatContainer = document.getElementById('mobileMessages');
if (chatContainer) {
  observer.observe(chatContainer, { childList: true, subtree: true });
}

// Double-check every 5 seconds
setInterval(runEnhancement, 5000);
</script>
</body>
</html>