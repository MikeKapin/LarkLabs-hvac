<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HVAC Jack 5.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#E85A4F">
    <title>HVAC Jack 5.0 - AI HVAC Troubleshooting Assistant</title>
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="hvac-jack-icon.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- Maintenance Form Styles -->
    <link rel="stylesheet" href="./components/MaintenanceForm/maintenanceForm.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1A1F2E 0%, #16213E 100%);
            min-height: 100vh;
            color: #E2E8F0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Beta Access Overlay */
        .beta-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 31, 46, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        .beta-container {
            background: linear-gradient(135deg, #1A1F2E 0%, #16213E 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(232, 90, 79, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .beta-logo {
            font-size: 3rem;
            color: #E85A4F;
            margin-bottom: 20px;
        }

        .beta-title {
            font-size: 1.8rem;
            color: #E2E8F0;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .beta-subtitle {
            font-size: 1rem;
            color: #94A3B8;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .beta-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #E2E8F0;
            text-align: center;
            font-family: monospace;
            letter-spacing: 2px;
            outline: none;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .beta-input:focus {
            border-color: #E85A4F;
            box-shadow: 0 0 0 3px rgba(232, 90, 79, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .beta-input::placeholder {
            color: #64748B;
            letter-spacing: 1px;
        }

        .beta-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #E85A4F 0%, #FF6B5B 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(232, 90, 79, 0.3);
        }

        .beta-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(232, 90, 79, 0.4);
        }

        .beta-submit:active {
            transform: translateY(0);
        }

        .beta-error {
            color: #EF4444;
            font-size: 0.9rem;
            margin-top: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .beta-error.show {
            opacity: 1;
        }

        .beta-info {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #A5B4FC;
        }

        .beta-request {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .beta-request p {
            color: #94A3B8;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .beta-request-link {
            display: inline-block;
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(34, 197, 94, 0.3);
        }

        .beta-request-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
            text-decoration: none;
            color: white;
        }

        /* Tier Selection Styles */
        .tier-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .tier-btn {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
        }

        .tier-btn:hover {
            transform: translateY(-3px);
            border-color: #E85A4F;
            background: rgba(232, 90, 79, 0.1);
            box-shadow: 0 5px 20px rgba(232, 90, 79, 0.3);
        }

        .tier-free {
            border-color: rgba(148, 163, 184, 0.3);
        }

        .tier-free:hover {
            border-color: #94A3B8;
            background: rgba(148, 163, 184, 0.1);
            box-shadow: 0 5px 20px rgba(148, 163, 184, 0.3);
        }

        .tier-pro {
            border-color: rgba(232, 90, 79, 0.5);
            background: rgba(232, 90, 79, 0.08);
        }

        .tier-pro:hover {
            border-color: #E85A4F;
            background: rgba(232, 90, 79, 0.15);
        }

        .tier-student {
            border-color: rgba(99, 102, 241, 0.3);
        }

        .tier-student:hover {
            border-color: #6366F1;
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.3);
        }

        .tier-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .tier-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #E2E8F0;
            margin-bottom: 8px;
        }

        .tier-limits {
            font-size: 0.95rem;
            color: #94A3B8;
            margin-bottom: 12px;
        }

        .tier-price {
            font-size: 1.1rem;
            font-weight: 600;
            color: #22C55E;
        }

        .tier-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #E85A4F 0%, #FF6B5B 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(232, 90, 79, 0.4);
        }

        .back-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #94A3B8;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            color: #E2E8F0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #E85A4F;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(232, 90, 79, 0.3);
        }

        .tagline {
            font-size: 1.1rem;
            color: #94A3B8;
            font-weight: 500;
        }

        .main-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .photo-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .photo-upload {
            position: relative;
            border: 2px dashed #E85A4F;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(232, 90, 79, 0.05);
        }

        .photo-upload:hover {
            background: rgba(232, 90, 79, 0.1);
            border-color: #FF6B5B;
        }

        .photo-upload.drag-over {
            background: rgba(232, 90, 79, 0.15);
            border-color: #FF6B5B;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #E85A4F;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #E2E8F0;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: #94A3B8;
        }

        #photo-input {
            display: none;
        }

        .preview-container {
            margin-top: 20px;
            display: none;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .query-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .query-label {
            font-size: 1.3rem;
            color: #E85A4F;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .query-input {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.05);
            color: #E2E8F0;
            font-size: 1.1rem;
            resize: vertical;
            font-family: inherit;
            outline: none;
            transition: all 0.3s ease;
        }

        .query-input:focus {
            border-color: #E85A4F;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(232, 90, 79, 0.2);
        }

        .query-input::placeholder {
            color: #64748B;
        }

        .analyze-btn {
            width: 100%;
            padding: 18px;
            margin-top: 20px;
            background: linear-gradient(135deg, #E85A4F 0%, #FF6B5B 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(232, 90, 79, 0.3);
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(232, 90, 79, 0.4);
        }

        .analyze-btn:active {
            transform: translateY(0);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .photo-analyze-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(99, 102, 241, 0.3);
        }

        .photo-analyze-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        .photo-analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .response-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            margin-top: 20px;
            display: none;
            max-height: 70vh;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid;
        }

        .chat-message.photo-analysis {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: #6366F1;
        }

        .chat-message.user-question {
            background: rgba(232, 90, 79, 0.1);
            border-left-color: #E85A4F;
        }

        .chat-message.ai-response {
            background: rgba(34, 197, 94, 0.1);
            border-left-color: #22C55E;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .message-timestamp {
            font-size: 0.8rem;
            color: #94A3B8;
            margin-left: auto;
        }

        .message-content {
            color: #E2E8F0;
            line-height: 1.6;
        }

        .response-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .response-icon {
            font-size: 1.5rem;
            color: #E85A4F;
        }

        .response-title {
            font-size: 1.3rem;
            color: #E85A4F;
            font-weight: 600;
            flex: 1;
        }

        .clear-chat-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-chat-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }

        .response-content {
            color: #E2E8F0;
            line-height: 1.6;
            font-size: 1rem;
        }

        .response-content h1,
        .response-content h2,
        .response-content h3 {
            color: #E85A4F;
            margin: 20px 0 10px 0;
        }

        .response-content ul,
        .response-content ol {
            margin: 10px 0 10px 20px;
        }

        .response-content li {
            margin-bottom: 5px;
        }

        .response-content strong {
            color: #FFF;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94A3B8;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(232, 90, 79, 0.3);
            border-top: 2px solid #E85A4F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-connected {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* PWA Install Button */
        .install-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
        }

        .install-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 30px rgba(99, 102, 241, 0.5);
        }

        .install-btn.show {
            display: flex;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .photo-upload {
                padding: 30px 15px;
            }
            
            .upload-icon {
                font-size: 2.5rem;
            }
            
            .query-input {
                min-height: 100px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Access Selection Overlay -->
    <div class="beta-overlay" id="beta-overlay">
        <div class="beta-container" id="tier-selection-view">
            <div class="beta-logo">🔧</div>
            <h1 class="beta-title">HVAC Jack 5.0</h1>
            <p class="beta-subtitle">Choose Your Access Level</p>

            <!-- Tier Selection Buttons -->
            <div class="tier-options">
                <button class="tier-btn tier-free" id="btn-free-tier">
                    <div class="tier-icon">✨</div>
                    <div class="tier-name">Free Version</div>
                    <div class="tier-limits">10 photos • 15 text queries</div>
                    <div class="tier-price">$0 / month</div>
                </button>

                <button class="tier-btn tier-pro" id="btn-pro-tier">
                    <div class="tier-icon">🚀</div>
                    <div class="tier-name">Pro Version</div>
                    <div class="tier-limits">250 photos • 250 text queries</div>
                    <div class="tier-price">$16.99 / month</div>
                    <div class="tier-badge">BEST VALUE</div>
                </button>

                <button class="tier-btn tier-student" id="btn-student-tier">
                    <div class="tier-icon">🎓</div>
                    <div class="tier-name">Student Access</div>
                    <div class="tier-limits">Pro features for 12 months</div>
                    <div class="tier-price">Access code required</div>
                </button>
            </div>
        </div>

        <!-- Student Access Code Entry (Hidden by default) -->
        <div class="beta-container" id="student-code-view" style="display: none;">
            <div class="beta-logo">🎓</div>
            <h1 class="beta-title">Student Access</h1>
            <p class="beta-subtitle">Enter your LARK Labs student access code</p>

            <form id="student-form">
                <input
                    type="password"
                    id="student-passkey"
                    class="beta-input"
                    placeholder="Enter Access Code (LARK####)"
                    autocomplete="off"
                    maxlength="12"
                />
                <button type="submit" class="beta-submit">Activate Student Access</button>
            </form>

            <div class="beta-error" id="student-error">
                Invalid student code. Please check your LARK Labs student access code and try again.
            </div>

            <button class="back-btn" id="btn-back-to-tiers">← Back to Access Options</button>

            <div class="beta-request">
                <p>Don't have student access?</p>
                <a href="mailto:lark_labs@outlook.com?subject=HVAC%20Jack%205.0%20Student%20Access%20Request&body=Hello,%0A%0AI%20would%20like%20to%20request%20student%20access%20to%20HVAC%20Jack%205.0.%0A%0AThank%20you!" class="beta-request-link">
                    📧 Request Student Access
                </a>
            </div>
        </div>
    </div>

    <!-- PWA Install Button -->
    <button class="install-btn" id="install-btn">
        📱 Install App
    </button>

    <div class="container">
        <div class="status-indicator" id="status-indicator">🟢 Connected</div>

        <header class="header">
            <div class="logo">🔧 HVAC Jack 5.0</div>
            <div class="tagline">AI-Powered HVAC Troubleshooting Assistant - Student Edition</div>
        </header>

        <main class="main-interface">
            <section class="photo-section">
                <div class="photo-upload" id="photo-upload">
                    <div class="upload-icon">📷</div>
                    <div class="upload-text">Take or Upload Equipment Photo</div>
                    <div class="upload-subtext">Optional - helps provide better troubleshooting</div>
                    <input type="file" id="photo-input" accept="image/*" capture="environment">
                </div>
                <div class="preview-container" id="preview-container">
                    <img id="photo-preview" class="photo-preview" alt="Equipment photo">
                    <button class="photo-analyze-btn" id="photo-analyze-btn">
                        📋 Analyze Photo Only (Extract Rating Plate Data)
                    </button>
                </div>
            </section>

            <section class="query-section">
                <div class="query-label">🔍 Describe Your HVAC Issue</div>
                <textarea 
                    class="query-input" 
                    id="query-input"
                    placeholder="Describe the problem you're experiencing with your HVAC equipment. Be as detailed as possible - what's not working, any sounds, error codes, symptoms, etc."
                ></textarea>
                <button class="analyze-btn" id="analyze-btn">
                    🎓 Get Expert Analysis & Troubleshooting
                </button>
            </section>

            <section class="response-section" id="response-section">
                <div class="response-header">
                    <div class="response-icon">🎓</div>
                    <div class="response-title">Expert Analysis Chat</div>
                    <button class="clear-chat-btn" id="clear-chat-btn" title="Clear Chat History">🗑️ Clear</button>
                </div>
                <div class="response-content" id="response-content"></div>
            </section>
        </main>
    </div>

    <script>
        // 3-Tier Access Authentication System
        class TierAuth {
            constructor() {
                this.storageKey = 'hvac-jack-5-access';
                this.usageKey = 'hvac-jack-5-usage';
                this.stripePaymentLink = 'https://buy.stripe.com/5kQ28sclL7bCbCSekE';

                // 80 LARK Labs Student Access Codes - 12 months pro access
                this.validStudentCodes = [
                    'LARK0001', 'LARK0002', 'LARK0003', 'LARK0004', 'LARK0005',
                    'LARK0006', 'LARK0007', 'LARK0008', 'LARK0009', 'LARK0010',
                    'LARK0011', 'LARK0012', 'LARK0013', 'LARK0014', 'LARK0015',
                    'LARK0016', 'LARK0017', 'LARK0018', 'LARK0019', 'LARK0020',
                    'LARK0021', 'LARK0022', 'LARK0023', 'LARK0024', 'LARK0025',
                    'LARK0026', 'LARK0027', 'LARK0028', 'LARK0029', 'LARK0030',
                    'LARK0031', 'LARK0032', 'LARK0033', 'LARK0034', 'LARK0035',
                    'LARK0036', 'LARK0037', 'LARK0038', 'LARK0039', 'LARK0040',
                    'LARK0041', 'LARK0042', 'LARK0043', 'LARK0044', 'LARK0045',
                    'LARK0046', 'LARK0047', 'LARK0048', 'LARK0049', 'LARK0050',
                    'LARK0051', 'LARK0052', 'LARK0053', 'LARK0054', 'LARK0055',
                    'LARK0056', 'LARK0057', 'LARK0058', 'LARK0059', 'LARK0060',
                    'LARK0061', 'LARK0062', 'LARK0063', 'LARK0064', 'LARK0065',
                    'LARK0066', 'LARK0067', 'LARK0068', 'LARK0069', 'LARK0070',
                    'LARK0071', 'LARK0072', 'LARK0073', 'LARK0074', 'LARK0075',
                    'LARK0076', 'LARK0077', 'LARK0078', 'LARK0079', 'LARK0080'
                ];

                this.init();
            }

            init() {
                // Check for Stripe success redirect
                this.checkStripeSuccess();

                // Check if already authenticated
                if (this.isAuthenticated()) {
                    this.hideOverlay();
                } else {
                    this.showOverlay();
                }

                this.setupEventListeners();
            }

            setupEventListeners() {
                // Tier selection buttons
                document.getElementById('btn-free-tier').addEventListener('click', () => {
                    this.activateFreeTier();
                });

                document.getElementById('btn-pro-tier').addEventListener('click', () => {
                    this.redirectToStripe();
                });

                document.getElementById('btn-student-tier').addEventListener('click', () => {
                    this.showStudentCodeEntry();
                });

                // Student code form
                const studentForm = document.getElementById('student-form');
                studentForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const code = document.getElementById('student-passkey').value;
                    this.validateStudentCode(code);
                });

                // Back button
                document.getElementById('btn-back-to-tiers').addEventListener('click', () => {
                    this.showTierSelection();
                });
            }

            async checkStripeSuccess() {
                const urlParams = new URLSearchParams(window.location.search);
                const stripeSuccess = urlParams.get('stripe_success');
                const sessionId = urlParams.get('session_id');

                if (stripeSuccess === 'true' && sessionId) {
                    console.log('🚀 Stripe payment detected, verifying session...');

                    try {
                        const response = await fetch('/api/verify-stripe', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ sessionId })
                        });

                        const data = await response.json();

                        if (data.success && data.accessGranted) {
                            this.setAuthenticated('pro', data.expirationDate, data.limits);

                            // Clean URL
                            window.history.replaceState({}, document.title, window.location.pathname);

                            console.log('✅ Pro access activated via Stripe!');
                        } else {
                            console.error('❌ Stripe verification failed:', data.error);
                        }
                    } catch (error) {
                        console.error('❌ Stripe verification error:', error);
                    }
                }
            }

            showTierSelection() {
                document.getElementById('tier-selection-view').style.display = 'block';
                document.getElementById('student-code-view').style.display = 'none';
            }

            showStudentCodeEntry() {
                document.getElementById('tier-selection-view').style.display = 'none';
                document.getElementById('student-code-view').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('student-passkey').focus();
                }, 300);
            }

            activateFreeTier() {
                const limits = {
                    photoAnalysis: 10,
                    textQueries: 15
                };

                this.setAuthenticated('free', null, limits);
                this.initializeUsageTracking();
                this.hideOverlay();
                console.log('✅ Free tier activated (10 photos, 15 text queries)');
            }

            redirectToStripe() {
                console.log('🚀 Redirecting to Stripe checkout...');
                window.location.href = this.stripePaymentLink;
            }

            async validateStudentCode(enteredCode) {
                const errorElement = document.getElementById('student-error');
                const code = enteredCode.toUpperCase().trim();

                if (!this.validStudentCodes.includes(code)) {
                    errorElement.classList.add('show');
                    document.getElementById('student-passkey').value = '';
                    console.log('❌ Invalid student code attempted:', code);

                    setTimeout(() => {
                        errorElement.classList.remove('show');
                    }, 3000);
                    return;
                }

                // Valid student code
                try {
                    const response = await fetch('/api/validate-student-code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ accessCode: code })
                    });

                    const data = await response.json();

                    if (data.success && data.accessGranted) {
                        this.setAuthenticated('student', data.expirationDate, data.limits);
                        errorElement.classList.remove('show');
                        this.hideOverlay();
                        console.log('✅ Student access granted (12 months pro access):', code);
                    } else {
                        errorElement.classList.add('show');
                        console.error('❌ Student code validation failed:', data.error);
                    }
                } catch (error) {
                    console.error('❌ Student code validation error:', error);
                    errorElement.textContent = 'Validation error. Please try again.';
                    errorElement.classList.add('show');
                }
            }

            setAuthenticated(tier, expirationDate, limits) {
                const authData = {
                    authenticated: true,
                    tier: tier, // 'free', 'pro', or 'student'
                    activatedDate: new Date().toISOString(),
                    expirationDate: expirationDate,
                    limits: limits
                };

                localStorage.setItem(this.storageKey, JSON.stringify(authData));
                sessionStorage.setItem(this.storageKey, JSON.stringify(authData));
            }

            initializeUsageTracking() {
                const usageData = {
                    photoAnalysis: 0,
                    textQueries: 0,
                    resetDate: new Date().toISOString()
                };

                localStorage.setItem(this.usageKey, JSON.stringify(usageData));
            }

            isAuthenticated() {
                try {
                    let authData = JSON.parse(sessionStorage.getItem(this.storageKey));
                    if (!authData) {
                        authData = JSON.parse(localStorage.getItem(this.storageKey));
                        if (authData) {
                            sessionStorage.setItem(this.storageKey, JSON.stringify(authData));
                        }
                    }

                    if (authData && authData.authenticated) {
                        // Check expiration for pro and student tiers
                        if (authData.tier === 'pro' || authData.tier === 'student') {
                            if (authData.expirationDate) {
                                const expiryTime = new Date(authData.expirationDate).getTime();
                                if (new Date().getTime() >= expiryTime) {
                                    // Expired
                                    this.clearAuthentication();
                                    console.log('⏱️ Access expired');
                                    return false;
                                }
                            }
                        }

                        console.log(`🔓 Access active: ${authData.tier} tier`);
                        return true;
                    }
                } catch (error) {
                    this.clearAuthentication();
                }
                return false;
            }

            canUseFeature(featureType) {
                const authData = JSON.parse(localStorage.getItem(this.storageKey));
                if (!authData || !authData.authenticated) return false;

                // Pro and student tiers have unlimited access
                if (authData.tier === 'pro' || authData.tier === 'student') {
                    return true;
                }

                // Free tier - check usage limits
                if (authData.tier === 'free') {
                    const usageData = JSON.parse(localStorage.getItem(this.usageKey)) || {
                        photoAnalysis: 0,
                        textQueries: 0
                    };

                    if (featureType === 'photo') {
                        return usageData.photoAnalysis < authData.limits.photoAnalysis;
                    } else if (featureType === 'text') {
                        return usageData.textQueries < authData.limits.textQueries;
                    }
                }

                return false;
            }

            incrementUsage(featureType) {
                const authData = JSON.parse(localStorage.getItem(this.storageKey));
                if (!authData || authData.tier !== 'free') return;

                const usageData = JSON.parse(localStorage.getItem(this.usageKey)) || {
                    photoAnalysis: 0,
                    textQueries: 0
                };

                if (featureType === 'photo') {
                    usageData.photoAnalysis++;
                } else if (featureType === 'text') {
                    usageData.textQueries++;
                }

                localStorage.setItem(this.usageKey, JSON.stringify(usageData));
                console.log(`📊 Usage updated: ${usageData.photoAnalysis} photos, ${usageData.textQueries} text queries`);
            }

            getRemainingUsage() {
                const authData = JSON.parse(localStorage.getItem(this.storageKey));
                if (!authData || authData.tier !== 'free') {
                    return { photos: '∞', text: '∞' };
                }

                const usageData = JSON.parse(localStorage.getItem(this.usageKey)) || {
                    photoAnalysis: 0,
                    textQueries: 0
                };

                return {
                    photos: authData.limits.photoAnalysis - usageData.photoAnalysis,
                    text: authData.limits.textQueries - usageData.textQueries
                };
            }

            clearAuthentication() {
                localStorage.removeItem(this.storageKey);
                sessionStorage.removeItem(this.storageKey);
                localStorage.removeItem(this.usageKey);
            }

            showOverlay() {
                document.getElementById('beta-overlay').style.display = 'flex';
            }

            hideOverlay() {
                const overlay = document.getElementById('beta-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
        }

        class HVACJack4 {
            constructor() {
                this.photoData = null;
                this.photoAnalysisData = null;
                this.conversationHistory = [];
                this.chatMessages = [];
                this.isAnalyzing = false;
                this.sessionId = this.generateSessionId();
                this.initializeElements();
                this.setupEventListeners();
                this.checkConnection();
            }

            generateSessionId() {
                return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            }

            initializeElements() {
                this.elements = {
                    photoUpload: document.getElementById('photo-upload'),
                    photoInput: document.getElementById('photo-input'),
                    previewContainer: document.getElementById('preview-container'),
                    photoPreview: document.getElementById('photo-preview'),
                    photoAnalyzeBtn: document.getElementById('photo-analyze-btn'),
                    queryInput: document.getElementById('query-input'),
                    analyzeBtn: document.getElementById('analyze-btn'),
                    responseSection: document.getElementById('response-section'),
                    responseContent: document.getElementById('response-content'),
                    clearChatBtn: document.getElementById('clear-chat-btn'),
                    statusIndicator: document.getElementById('status-indicator')
                };
            }

            setupEventListeners() {
                // Photo upload
                this.elements.photoUpload.addEventListener('click', () => {
                    this.elements.photoInput.click();
                });

                this.elements.photoInput.addEventListener('change', (e) => {
                    this.handlePhotoUpload(e.target.files[0]);
                });

                // Drag and drop
                this.elements.photoUpload.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.elements.photoUpload.classList.add('drag-over');
                });

                this.elements.photoUpload.addEventListener('dragleave', () => {
                    this.elements.photoUpload.classList.remove('drag-over');
                });

                this.elements.photoUpload.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.elements.photoUpload.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.handlePhotoUpload(file);
                    }
                });

                // Photo analysis button
                this.elements.photoAnalyzeBtn.addEventListener('click', () => {
                    this.performPhotoAnalysis();
                });

                // Analysis button
                this.elements.analyzeBtn.addEventListener('click', () => {
                    this.performAnalysis();
                });

                // Clear chat button
                this.elements.clearChatBtn.addEventListener('click', () => {
                    this.clearChat();
                });

                // Enter key in textarea
                this.elements.queryInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        this.performAnalysis();
                    }
                });
            }

            async handlePhotoUpload(file) {
                if (!file) return;

                try {
                    // Show preview with original image
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.elements.photoPreview.src = e.target.result;
                        this.elements.previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);

                    // Compress and convert to base64 for API
                    this.photoData = await this.compressAndConvertImage(file);

                    console.log('📷 Photo uploaded and compressed successfully');
                    this.showStatus('Photo ready for analysis', 'success');
                } catch (error) {
                    console.error('Photo upload error:', error);
                    this.showStatus('Photo upload failed', 'error');
                }
            }

            async compressAndConvertImage(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            // Create canvas for compression
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            // Calculate new dimensions (max 1200px on longest side for faster processing)
                            let width = img.width;
                            let height = img.height;
                            const maxDimension = 1200;

                            if (width > maxDimension || height > maxDimension) {
                                if (width > height) {
                                    height = (height / width) * maxDimension;
                                    width = maxDimension;
                                } else {
                                    width = (width / height) * maxDimension;
                                    height = maxDimension;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;

                            // Draw and compress
                            ctx.drawImage(img, 0, 0, width, height);

                            // Convert to base64 with quality reduction (0.85 = 85% quality)
                            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.85);

                            const originalSize = (e.target.result.length * 0.75 / 1024).toFixed(0);
                            const compressedSize = (compressedBase64.length * 0.75 / 1024).toFixed(0);
                            console.log(`🗜️ Image compressed: ${originalSize}KB → ${compressedSize}KB (${((compressedSize/originalSize)*100).toFixed(0)}%)`);

                            resolve(compressedBase64);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            async performPhotoAnalysis() {
                if (!this.photoData) {
                    this.showStatus('Please upload a photo first', 'error');
                    return;
                }

                if (this.isAnalyzing) return;

                this.isAnalyzing = true;
                this.elements.photoAnalyzeBtn.disabled = true;
                this.elements.photoAnalyzeBtn.innerHTML = '<div class="spinner"></div> Analyzing Photo...';

                try {
                    // Add progress tracking for retry attempts
                    this.showStatus('Analyzing photo...', 'info');
                    const response = await this.callPhotoAnalyzer();
                    this.photoAnalysisData = response; // Store photo analysis for future use
                    this.addToConversationHistory('photo_analysis', response);
                    this.addChatMessage('photo-analysis', '📋 Photo Analysis Complete', response);
                    this.showStatus('Photo analysis complete', 'success');

                    // Dispatch event for maintenance form system
                    window.dispatchEvent(new CustomEvent('hvacjack-photo-analysis-complete', {
                        detail: response
                    }));
                } catch (error) {
                    console.error('Photo analysis error:', error);
                    
                    // More helpful error messages
                    let userMessage = 'Photo analysis failed';
                    if (error.message.includes('timeout')) {
                        userMessage = 'Analysis timed out - try a smaller image';
                    } else if (error.message.includes('500')) {
                        userMessage = 'Server temporarily unavailable - please retry';
                    } else if (error.message.includes('fetch')) {
                        userMessage = 'Connection error - check internet and retry';
                    }
                    
                    this.showStatus(userMessage, 'error');
                    this.displayError(`${userMessage}. ${error.message}`);
                } finally {
                    this.isAnalyzing = false;
                    this.elements.photoAnalyzeBtn.disabled = false;
                    this.elements.photoAnalyzeBtn.innerHTML = '📋 Analyze Photo Only (Extract Rating Plate Data)';
                }
            }

            async performAnalysis() {
                const query = this.elements.queryInput.value.trim();
                
                if (!query) {
                    this.showStatus('Please describe your HVAC issue', 'error');
                    return;
                }

                if (this.isAnalyzing) return;

                this.isAnalyzing = true;
                this.elements.analyzeBtn.disabled = true;
                this.elements.analyzeBtn.innerHTML = '<div class="spinner"></div> Analyzing...';

                try {
                    this.addChatMessage('user-question', '🔍 User Question', query);
                    const response = await this.callExplainerAPI(query);
                    this.addToConversationHistory('user_question', query);
                    this.addToConversationHistory('ai_response', response);
                    this.addChatMessage('ai-response', '🎓 HVAC Jack Expert Analysis', response);
                    this.showStatus('Analysis complete', 'success');
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.showStatus('Analysis failed - please try again', 'error');
                    this.displayError(error.message);
                } finally {
                    this.isAnalyzing = false;
                    this.elements.analyzeBtn.disabled = false;
                    this.elements.analyzeBtn.innerHTML = '🎓 Get Expert Analysis & Troubleshooting';
                }
            }

            async callExplainerAPI(query) {
                const payload = {
                    message: query,
                    sessionId: this.sessionId,
                    explainerMode: true,
                    requestExplanation: true,
                    photoData: this.photoData,
                    photoAnalysisData: this.photoAnalysisData,
                    conversationHistory: this.conversationHistory.slice(-10), // Last 10 exchanges
                    timestamp: new Date().toISOString()
                };

                console.log('🚀 Sending to HVAC Jack 4.0 API:', payload);

                const response = await fetch('/api/hvac-explainer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                return data.response || data.message || 'No response received';
            }

            async callPhotoAnalyzer(retryCount = 0) {
                const maxRetries = 2;
                const retryDelay = 2000; // 2 seconds
                
                const payload = {
                    imageData: this.photoData,
                    query: 'Extract all technical specifications and rating plate data from this HVAC equipment photo',
                    sessionId: this.sessionId,
                    timestamp: new Date().toISOString()
                };

                console.log(`📷 Sending to Photo Analyzer API (attempt ${retryCount + 1}/${maxRetries + 1}):`, payload);

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 55000); // 55 second timeout (Vercel allows 60s)

                    const response = await fetch('/api/photo-analyzer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        // Check if it's a server error that might be retryable
                        if (response.status >= 500 && retryCount < maxRetries) {
                            console.warn(`📷 Server error ${response.status}, retrying in ${retryDelay}ms...`);
                            if (this.showStatus) {
                                this.showStatus(`Server error - retrying (${retryCount + 2}/${maxRetries + 1})...`, 'warning');
                            }
                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                            return this.callPhotoAnalyzer(retryCount + 1);
                        }
                        
                        // Get more detailed error information
                        let errorMessage;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorData.message || `HTTP ${response.status}`;
                        } catch {
                            errorMessage = `HTTP ${response.status} - ${response.statusText}`;
                        }
                        
                        throw new Error(`Photo Analyzer API Error: ${errorMessage}`);
                    }

                    const data = await response.json();
                    console.log('📷 Photo analysis successful:', data.success);
                    return data.analysis || data.message || 'No analysis received';

                } catch (error) {
                    if (error.name === 'AbortError') {
                        if (retryCount < maxRetries) {
                            console.warn('📷 Request timeout, retrying...');
                            return this.callPhotoAnalyzer(retryCount + 1);
                        }
                        throw new Error('Photo analysis timed out. Please try with a smaller image.');
                    }
                    
                    // Network errors might be retryable
                    if (error.message.includes('fetch') && retryCount < maxRetries) {
                        console.warn(`📷 Network error, retrying in ${retryDelay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                        return this.callPhotoAnalyzer(retryCount + 1);
                    }
                    
                    throw error;
                }
            }

            addToConversationHistory(type, content) {
                this.conversationHistory.push({
                    type: type,
                    content: content,
                    timestamp: new Date().toISOString()
                });
                
                // Keep only last 20 items to prevent memory bloat
                if (this.conversationHistory.length > 20) {
                    this.conversationHistory = this.conversationHistory.slice(-20);
                }
            }

            addChatMessage(type, title, content) {
                const timestamp = new Date().toLocaleString();
                const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                const message = {
                    id: messageId,
                    type: type,
                    title: title,
                    content: content,
                    timestamp: timestamp
                };
                
                this.chatMessages.push(message);
                this.renderChatMessages();
            }

            renderChatMessages() {
                const chatHtml = this.chatMessages.map(msg => `
                    <div class="chat-message ${msg.type}">
                        <div class="message-header">
                            <span>${msg.title}</span>
                            <span class="message-timestamp">${msg.timestamp}</span>
                        </div>
                        <div class="message-content">
                            ${this.formatResponse(msg.content)}
                        </div>
                    </div>
                `).join('');
                
                this.elements.responseContent.innerHTML = chatHtml;
                this.elements.responseSection.style.display = 'block';
                
                // Scroll to bottom of chat
                setTimeout(() => {
                    const responseSection = this.elements.responseSection;
                    responseSection.scrollTop = responseSection.scrollHeight;
                    responseSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }

            displayResponse(response) {
                // This method is kept for compatibility but now uses chat system
                this.addChatMessage('ai-response', '🎓 Response', response);
            }

            displayError(error) {
                const errorMessage = `
                    <div style="color: #EF4444; padding: 20px; border-left: 4px solid #EF4444; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <strong>⚠️ Analysis Error</strong><br>
                        ${error}<br><br>
                        Please check your connection and try again.
                    </div>
                `;
                this.addChatMessage('ai-response', '⚠️ Error', errorMessage);
            }

            clearChat() {
                this.chatMessages = [];
                this.conversationHistory = [];
                this.photoAnalysisData = null;
                this.elements.responseSection.style.display = 'none';
                this.showStatus('Chat cleared', 'success');
            }

            async generateTroubleshootingGuide() {
                // Automatically generate comprehensive troubleshooting after photo analysis
                const troubleshootingQuery = `Based on the equipment photo analysis above, can you provide a detailed troubleshooting guide based on the sequence of operation and provide the capacitor size for this appliance? Please also include common parts replacements and part numbers for this specific model and brand.

Please structure your response with:
1. **Sequence of Operation** - Step-by-step how this equipment operates
2. **Capacitor Specifications** - Exact capacitor sizes (MFD and voltage) for this model
3. **Common Troubleshooting Steps** - Systematic diagnostic procedures
4. **Common Part Replacements** - Most frequently replaced components with part numbers
5. **Safety Considerations** - Important safety warnings for this equipment type
6. **Professional vs DIY** - What homeowners can safely check vs when to call a professional

Focus specifically on the brand and model identified from the rating plate analysis.`;

                try {
                    this.showStatus('Generating troubleshooting guide...', 'info');
                    this.addChatMessage('user-question', '🔧 Auto-Generated Request', 'Comprehensive troubleshooting guide and parts information');
                    
                    const response = await this.callExplainerAPI(troubleshootingQuery);
                    this.addToConversationHistory('user_question', troubleshootingQuery);
                    this.addToConversationHistory('ai_response', response);
                    this.addChatMessage('ai-response', '🛠️ Comprehensive Troubleshooting Guide', response);
                    this.showStatus('Troubleshooting guide complete', 'success');
                } catch (error) {
                    console.error('Troubleshooting guide generation failed:', error);
                    this.showStatus('Could not generate troubleshooting guide', 'error');
                    this.addChatMessage('ai-response', '⚠️ Notice', 'Unable to generate automatic troubleshooting guide. You can manually ask: "Provide troubleshooting guide and capacitor specs for this equipment"');
                }
            }

            formatResponse(response) {
                // Convert markdown-like formatting to HTML
                return response
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/^/, '<p>')
                    .replace(/$/, '</p>')
                    .replace(/####\s*(.*)/g, '<h4>$1</h4>')
                    .replace(/###\s*(.*)/g, '<h3>$1</h3>')
                    .replace(/##\s*(.*)/g, '<h2>$1</h2>')
                    .replace(/#\s*(.*)/g, '<h1>$1</h1>');
            }

            showStatus(message, type) {
                this.elements.statusIndicator.textContent = message;
                this.elements.statusIndicator.className = `status-indicator status-${type}`;
                
                setTimeout(() => {
                    this.elements.statusIndicator.textContent = '🟢 Connected';
                    this.elements.statusIndicator.className = 'status-indicator status-connected';
                }, 3000);
            }

            async checkConnection() {
                try {
                    const response = await fetch('/api/hvac-explainer', {
                        method: 'OPTIONS'
                    });

                    if (response.ok) {
                        this.showStatus('Connected', 'connected');
                    } else {
                        this.showStatus('Connection issue', 'error');
                    }
                } catch (error) {
                    console.log('Connection check:', error);
                    this.showStatus('Starting up...', 'connected');
                }
            }
        }

        // PWA Install Manager
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('📱 PWA install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            installBtn.classList.add('show');
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) {
                console.log('📱 No install prompt available');
                return;
            }

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`📱 User response to install prompt: ${outcome}`);

            if (outcome === 'accepted') {
                console.log('✅ PWA installed successfully');
            }

            deferredPrompt = null;
            installBtn.classList.remove('show');
        });

        window.addEventListener('appinstalled', () => {
            console.log('✅ HVAC Jack 5.0 PWA installed');
            installBtn.classList.remove('show');
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize tier authentication first
            window.tierAuth = new TierAuth();

            // Initialize main app
            window.hvacJack = new HVACJack4();
            console.log('🔧 HVAC Jack 5.0 initialized with student access protection');

            // Initialize maintenance form system after a brief delay
            setTimeout(() => {
                if (window.hvacJack) {
                    window.maintenanceFormContainer = new MaintenanceFormContainer(window.hvacJack);
                    console.log('📋 Maintenance Form System initialized');
                }
            }, 500);

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('✅ Service Worker registered:', reg.scope))
                    .catch(err => console.log('❌ Service Worker registration failed:', err));
            }
        });
    </script>
    
    <!-- Maintenance Form System Scripts -->
    <script src="./services/mobileDetection.js"></script>
    <script src="./services/equipmentDataMapper.js"></script>
    <script src="./components/MaintenanceForm/MaintenanceFormContainer.js"></script>
    <script src="./components/MaintenanceForm/GasFurnaceForm.js"></script>
    <script src="./components/MaintenanceForm/MaintenanceFormPDF.js"></script>
    <script src="./components/MaintenanceForm/EmailService.js"></script>
</body>
</html>